5
0
0
2
 
n
u
J
 
7
1
 
 
]
h
p
-
m
e
h
c
.
s
c
i
s
y
h
p
[
 
 
1
v
2
5
1
6
0
5
0
/
s
c
i
s
y
h
p
:
v
i
X
r
a

Determination of the chemical potential using energy-biased sampling

R. Delgado-Buscalioni,1, ∗ G. De Fabritiis,2, † and P. V. Coveney2, ‡
1Depto. Ciencias y T´ecnicas Fisicoqu´ımicas, Facultad de Ciencias,
UNED, Paseo Senda del Rey 9, Madrid 28040, Spain.
2Centre for Computational Science, Department of Chemistry,
University College London, 20 Gordon Street, WC1H 0AJ London, U.K.
(Dated: July 23, 2013)

An energy-biased method to evaluate ensemble averages requiring test-particle insertion is pre-
sented. The method is based on biasing the sampling within the subdomains of the test-particle
conﬁgurational space with energies smaller than a given value freely assigned. These energy-wells are
located via unbiased random insertion over the whole conﬁgurational space and are sampled using
the so called Hit&Run algorithm, which uniformly samples compact regions of any shape immersed
in a space of arbitrary dimensions. Because the bias is deﬁned in terms of the energy landscape it
can be exactly corrected to obtain the unbiased distribution. The test-particle energy distribution is
then combined with the Bennett relation for the evaluation of the chemical potential. We apply this
protocol to a system with relatively small probability of low-energy test-particle insertion, liquid
argon at high density and low temperature, and show that the energy-biased Bennett method is
around ﬁve times more eﬃcient than the standard Bennett method. A similar performance gain is
observed in the reconstruction of the energy distribution.

I.

INTRODUCTION

The chemical potential is a central quantity under-
pinning many physical and chemical processes, such
as phase equilibria, osmosis, thermodynamic stability,
binging aﬃnity and so on1. However,
its evaluation
by computer simulation is more complicated and time-
consuming than for other intensive thermodynamic quan-
tities, such as the pressure P or temperature T . While
P and T can be evaluated from averages over mechanical
properties of molecules (forces, velocities and positions),
the chemical potential is a thermal average and therefore
it requires sampling the phase space of the system. In-
deed, computing the chemical potential is a special case
of the more general problem of computing a free-energy
diﬀerence A1 − A0 between two states (labelled as 0 and
1), a problem for which the inherent diﬃculty is well
understood1,2,3,4. Free energy perturbation (FEP) is an
important category of methods for free energy calcula-
tion; we refer to the recent works by Lu et al.1 and by
Shirts and Pande5 for review and comparisons. As ex-
plained by Lu et al.1, the general working equation for
FEP methods can be cast as

exp[−β(A1 − A0)] =

hw(u) exp[−βu/2]i0
hw(u) exp[−βu/2]i1

,

(1)

with β = 1/kBT and u ≡ U1 − U0 the energy diﬀer-
ence between both systems; KB is the Boltzmann con-
stant. The angular brackets denote ensemble averages
performed on the system labelled by the subscript “0” or
“1”. The weighting function w(u) is arbitrary and diﬀers
for each method introduced in the literature.

The chemical potential is the free energy diﬀerence be-
tween two thermodynamic states diﬀering by the pres-
ence of a single molecule. In other words, the chemical
potential is A1 − A0 where A1 = A(N + 1, V, T ) and
A0 = A(N, V, T ). Here A(N, V, T ) is the Helmholtz free

energy of the system which depends on the number of
molecules N, the volume V and temperature of the sys-
tem. In order to express the averages of Eq. (1) in terms
of one-dimensional integrals of the energy diﬀerence u one
can then introduce the following distribution functions6

f (u) =

hδ (u − U1 + U0)i0V −1dr,

Z

g(u) = hδ (u − U1 + U0)i1,

(2)

(3)

In Eq.

where δ(.) is the Dirac delta function.
(2),
U1 = U1(RN , r), where RN is the conﬁguration of the
ﬁrst N molecules and r denotes the conﬁguration of the
N+1 molecule. Note that in Eq. (2) the N+1 molecule
acts as a “test-molecule” which probes the system “0”
(i.e. the system with N molecules), but does no inter-
act with it. Therefore f (u) is the probability density of
the N molecule ensemble increasing in potential energy
by an amount u if this test-molecule were randomly in-
serted into the ensemble. Conversely, g(u) is the proba-
bility density of the (N+1)-molecule ensemble decreasing
in potential energy by an amount u if a randomly selected
real molecule were removed from the ensemble.

¿From Eq. (1)-(3) an expression for the excess chem-
ical potential µ = A1 − A0 − µid (where µid is the ideal
gas chemical potential3) can be derived in terms of the f
and g distributions1,6,7

exp(βµ) =

w(u)g(u)du
w(u)f (u) exp(−βu)du

R

.

(4)

R

A good choice of the weighting function w(u) is key for
the eﬃciency of the method. For instance, the Widom
method2,3 (w(u) = 1) is known to provide very poor con-
vergence at large densities. The Widom method is a sin-
gle stage FEP, meaning that sampling is only performed
in the reference system “0” (i.e., in the f distribution,
see Eq. (4)). As discussed by Lu et al.1, multiple staging

provides much better eﬃciency. The eﬃciency is gener-
ally deﬁned as the reciprocal of the product of the vari-
ance of the estimator multiplied by its cost ncost (that is,
the total number of energy evaluations performed by the
algorithm)

ε = (ncostVar[βµ])−1.

(5)

Bennett8 showed that the variance of Eq.
(4) is min-
imised if the weighting function is w(u) = F [β(u − c)],
where F (x) = 1/(1 + exp(x)) is the Fermi function and c
is an arbitrary constant. The Bennett estimator is then

βµ = ln

hF[−β(u − c)]ig
hF[β(u − c)]if (cid:19)

(cid:18)

+ βc,

(6)

where the subscripts g and f indicate (simple) averages
over the distributions g(u) and f (u). The value of c pro-
viding the minimum variance and maximum overlap is
c = µ and to evaluate µ using the optimum c(= µ)
one requires to use a self-consistent procedure, iterat-
ing the value of c in Eq. (6) and resetting c = µ un-
til hF[−β(u − c)]ig = hF[β(u − c)]if . In practise, this
step only requires a small number of iterations. Recent
publications1,5 demonstrate that the Bennett method re-
mains the best general method to compute the chemical
potential for many applications.

Note that the Bennett method is a two-stage FEP and
therefore it also requires sampling of the system “1”. In
the case of the determination of the chemical potential
this system has N+1 molecules and g(u) is obtained from
its single-molecule energy distribution. However this ex-
tra requirement is not really a drawback. Lu et al.1
showed that, provided N > O(100), the g−average can
be evaluated in the same simulation as is used to sample
the f distribution (system “0”) without any noticeable
loss in accuracy. The g distribution (constructed from
the energy of the real particles) is thus a byproduct of
the simulation so the average hF ig does not demand any
extra computational cost.

Another group of methods for determination of the
chemical potential are based on biased instead of uni-
form sampling. In particular, cavity-biased methods ﬁrst
select spherical cavities of minimum radius Rc (a free pa-
rameter) in which to insert the test-molecule. This ac-
celerates the evaluation of the ensemble average in dense
phases because the low-energy conﬁgurations of the test-
molecule (with large Boltzmann factors) are usually lo-
cated in larger cavities with less steric hindrance. Vari-
ations of this method have been proposed by several au-
thors; these include the Cavity Insertion Widom method
(CIW) due to Mezei and coworkers9, the Excluded Vol-
ume Map Sampling by Deitrick et al.6 and the method
proposed by Pohorille and Wilson10. The cavities are
located by a grid search over the whole simulation cell.
A cavity centre is assigned at each grid point whose dis-
tance to the closest particle is greater than Rc. In order
to correct the bias introduced in sampling only inside the
cavities one also has to calculate the probability of ﬁnd-
ing a cavity, which is obtained in the same grid-search

2

step. A drawback of the cavity-biased method is that it
is only indirectly related to the test-particle energy via
the excluded volume. This fact introduces a certain inac-
curacy in the estimation of the chemical potential, as it
can depend on the value of the cavity radius Rc selected.
For instance, the CIW has recently been used to calcu-
late the chemical potential of several species across a lipid
bilayer9. As a test calculation the authors estimated the
chemical potential of water in water and reported varia-
tions of about 1 Kcal/mol as Rc was varied from 2.6˚A to
2.8˚A. Also, using Rc ∈ [2.6, 2.9]˚A resulted in uncertain-
ties of about 2 Kcal/mol in estimates of the excess chem-
ical potential of some species across the lipid layer. Note
that the important region of the cavity-biased method is
constructed over the translational degrees of freedom of
a “coarse-grained” spherical molecule with an eﬀective
radius. This means that it can only be applied to small
solutes with spherical or roughly spherical shapes6.

In this work we present an energy-biased method for
the estimation of the chemical potential and reconstruc-
tion of the energy distribution f (u) in dense phases. The
idea is to restrict the sample to an important region
deﬁned by the set of bounded domains in the conﬁgu-
rational space of the test-molecule where the energy u
is smaller than a given free parameter uw. We denote
as an energy-well each compact subdomain within the
test-molecule energy-landscape for which u < uw. Note
that the present approach retains the main beneﬁt of
the cavity-biased method, but provides an exact evalu-
ation of the energy distribution f (u) and the chemical
potential, because the energy-wells are deﬁned directly
in terms of the energy landscape. Moreover our energy-
biased method does not assume any particular molecu-
lar shape and therefore it may be used for non-spherical
molecules and can coherently sample over rotational de-
grees of freedom as well.

We also note that the number of stages are not lim-
ited to two. When systems 0 and 1 are very diﬀerent it
may be impossible within the simulation time to sample
the importance region of the two systems. In this case
it is more eﬃcient to compute the total free energy dif-
ference by using a set of intermediate states. The energy
bias method can be applied on each of these intermediate
state transitions at the cost of performing independent
simulations for each state. Other approaches include, for
instance, slow and fast growth methods where the sys-
tem is changed from one state to another within a cer-
tain simulation time τ (large for slow growth). The fast
growth method consists of sampling rapid transformation
from many simulations which are then combined by us-
ing Jarzynski nonequilibrium work relation11 to obtain
the total free energy diﬀerence.

The rest of the paper proceeds as follows. The energy-
biased method is explained in Sec. II, while in Sec. III
we derive an analytical expression for the eﬃciency of the
method and estimate the optimal parameter uw by max-
imising the eﬃciency.
In Sec IV the method is tested
in liquid argon at high density (modelled as Lennard-

3

Jones atoms) where it is used to reconstruct the test-
particle energy distribution f (u) and the chemical po-
tential. We also demonstrate the gain in eﬃciency ob-
tained with energy-biased sampling with respect to uni-
form sampling. We conclude with a summary of our
ﬁndings in Sec. V. Finally in Appendix A we brieﬂy
explain the Hit&Run algorithm which eﬃciently samples
bounded regions of arbitrary shape immersed in an arbi-
trary number of dimensions.

II. OVERVIEW OF THE METHOD

As stated in the introduction, energy-biased sampling
consists of uniform sampling of the importance region
deﬁned by the set of subdomains in the test-molecule
conﬁgurational space where its potential energy is less
than uw. The probability density is therefore given by

h(u) =

f (u)/Fw u ≤ uw
u > uw,

0

(cid:26)

(7)

uw
where the normalisation factor Fw ≡
−∞ f (u)du is the
cumulative probability of the unbiased distribution f (u)
R
and uw is an arbitrary energy (free parameter).

Note that the energy-biased distribution of Eq. (7) can
be straightforwardly combined with any of the popular
methods to calculate the chemical potential from Eq. (4).
We shall use the Bennett method due to its excellent
performance. Introducing the weighting function w(u) =
F [β(c − u)] in Eq. (6) and using Eq. (7), one obtains the
energy-biased Bennett estimator for βµ,

FIG. 1: Energy landscape for the three-dimensional conﬁgu-
rational space generated by inserting an argon atom in a cube
of side 16 ˚A of argon ﬂuid. The isosurfaces of regions Auw
are shown for uw equal to 1 (dark grey) and to 10 Kcal/mol
(light grey).

a uniform probability distribution

puw (r) =

1
Ω(Auw )

,

(10)

βµ = ln

hFcig
FwhFcih (cid:19)

(cid:18)

+ βc,

(8)

where Ω(Auw ) is the volume of the region.

For a given energy bias uw, the algorithm for selecting
conﬁgurations r according to Eq. (10) can be described
in terms of two main steps which are applied iteratively:

where we have introduced the notation Fc ≡ F[β(u − c)]
to indicate that after the ensemble average we still have
a function of c. As before, the subscript h indicates the
average over the biased distribution of Eq. (7).

Sampling from the energy probability distribution h(u)
requires a more careful consideration of the energy land-
scape of the system. We indicate by r a conﬁguration of
the (N+1)th molecule and by R the conﬁguration of the
remaining N molecules. For a simple argon ﬂuid r ∈ D
where D ⊂ R3, while for a 3 sites ﬂexible water model like
TIP3P D ⊂ R9, which includes the three Euler angles de-
termining the molecule orientation, the H-O-H angle and
the two H-O distances.

As shown in Fig. (1), the region

Auw = {r ∈ D : u(r, R) < uw}

(9)

is composed of many disconnected bounded regions of
uw , where each Aα
diﬀerent sizes such that Auw = ∪αAα
uw
is now a connected region. Of course, for uw → ∞ we
have that all the regions Aα
∞ = D, the
entire domain. The sampling algorithm must reproduce

uw connect and Aα

1. Locate a compact energy-well Aα
rational space D, where u < uw.

uw in the conﬁgu-

2. Sample the energy-well Aα

uw with a uniform prob-

ability density.

The simplest procedure for locating energy wells in
step (1) is to perform a random search over the whole
conﬁgurational space until a ﬁxed number of cavities is
found. This procedure, however, does not avoid the prob-
ability of exploring the same well more than once, and
we observed that it can easily lead to highly correlated
Instead we perform step (1) by choosing points
data.
on a grid within the whole conﬁgurational space of the
test-molecule. In the case of the Lennard-Jones ﬂuid, the
three-dimensional conﬁgurational space is probed at the
nodes of a Cartesian grid of size nx × ny × nz, where
nα is the number of nodes along the coordinate α. We
observed that the minimum distance between nodes that
guarantees statistically independent samples is around
0.5σ.

An energy well is found at each node where the energy
of the test-molecule is u < uw. Then, the locations of
each of these nodes are used as starting conﬁgurations
for independent well samplings. In this way we ensure
that we are sampling diﬀerent cavities for each explored
conﬁguration (snapshot) of the system. Note that using
grid-sampling the number of cavities found per snapshot
is a ﬂuctuating quantity.

The search requires an average of n0 = 1/Fw energy
evaluations to locate one well (i.e. one conﬁguration with
energy u < uw.) During this same step (1) one can cal-
culate the cumulative probability Fw from the estima-
tor m/n0, with n0 being the total number of samples
(Bernoulli trials) and m the number of successful trials
with u < uw, i.e., the total number of energy-wells found.
This number m/n0 converges to Fw as n0 → ∞ and, for
a ﬁnite number of statistically independent trials n0, its
variance is (1 − Fw)Fw/n0. In practise, the estimation
of Fw requires the number of unbiased samples to be
n0 >> 1/Fw; this condition also ensures that a signiﬁ-
cant number of energy-wells (m > 0) are to be found.

Step (2) of the loop mentioned above requires a pro-
cedure to sample in an unbiased way the interior of each
energy well. This is a delicate step because any bias in-
curred in sampling the importance region will be trans-
fered to the estimator for βµ, resulting in inaccuracy of
the method. To tackle this problem we use the so-called
Hit&Run algorithm12, which is explained in Appendix
A.

III. EFFICIENCY AND OPTIMAL
PARAMETERS OF THE METHOD

We now calculate the eﬃciency of the method and pro-
vide a way of choosing the optimal value of the parameter
uw by maximising the eﬃciency. We also compare the
eﬃciency of the estimator in Eq. (8) based on energy-
biased sampling with that of the standard Bennett algo-
rithm of Eq. (6).

A. Energy-biased Bennett method

The variance of the Bennett method can be cast in
terms of the probability densities f (u) and g(u). Starting
from Eq.
(6), after some algebra the variance of the
Bennett method assumes the form

VarB[βµ] =

1
n0hF[β(u − c)]if

,

(11)

where n0 is the number of insertions used to sample
the complete conﬁgurational space of the test-particle.
Note that the computational cost of the standard Ben-
nett method is n0, so according to (5) and Eq. (11) its
maximum eﬃciency is given by

εB = hFcif .

(12)

4

Let us now consider the variance of the estimator in Eq.
(8), which is the sum of the variance of the estimator for
Fw and the estimator for the ensemble average

,

+

≃

1
n0Fw

1
nwhFcih

VarEB[βµ] = Var[ln Fw] +

1
nwhFcih
(13)
where we have used the relation Var[ln(Fw)] ≃
Var[Fw]/F 2
w = (1 − Fw)/(n0Fw) ≃ 1/(n0Fw), for Fw <<
1. Here n0 is the number of random insertions in the
entire conﬁgurational space and nw is the number of in-
dependent samples within the importance region u < uw.
The probability of ﬁnding an energy-well with u < uw
using uniform sampling over the whole conﬁgurational
space is Fw, so the number of cavities found after n0 trials
is m = Fwn0. If the number of statistically independent
samples per well is s, the total number of independent
samples within the restricted conﬁgurational space u <
uw is

nw = n0sFw.

(14)

We note that the number of independent samples per well
s depends on the ﬂuid considered and, of course, on the
biasing energy uw. In Appendix B we provide a way of
estimating s from the outcome of the data obtained from
Hit&Run sampling. Inserting Eq. (14) into Eq. (13) one
obtains for the energy-biased algorithm

VarEB[βµ] =

1
n0 (cid:18)

1
Fw

+

1
shFcif (cid:19)

.

(15)

In deriving Eq.(15) we used that hFcif = FwhFcih up
to a negligible amount. This can be seen by noticing
that the function F [β(u − c)] in the integrand of hFcif =
∞
−∞ f (u)F [β(u − c)]du decays exponentially for u > c.
Hence, in any practical case (uw > c) most of the integral
R
weight comes from u < uw, for which the energy-biased
reconstruction of the energy proﬁle f (u) is exact (see Fig.
3).

We now evaluate the cost, which is given by the total
number of energy evaluations of the test molecule needed
to obtain nw samples:

ncost = n0 + nw/a,

(16)

where a < 1 is the acceptance ratio of the Hit&Run
sampling algorithm, deﬁned in Appendix A.
Introduc-
ing Eq.(14) into Eq. (16) we obtain

ncost = n0 (cid:18)

1 +

sFw
a (cid:19)

.

(17)

For the energy-biased algorithm the eﬃciency is ε =
(ncostVarEB[βµ])−1. Using Eq.(15) and Eq.(17) one ob-
tains

ε−1
EB =

1
Fw

+

1
shFcif

+

s
a +

Fw
ahFcif

.

(18)

By maximising the eﬃciency ε = ε(Fw) in Eq. (18) with
respect to Fw, one obtains the optimal value F opt
w and
the maximum eﬃciency εEBmax = εEB(F opt

w ):

F opt

w =

q
ε−1
EBmax = 2

ahFcif
1
ahFcif

p

+

+

s
a

1
shFcif

.

(19)

(20)

Finally, we compare the eﬃciency of the energy-biased
algorithm with that provided by the Bennett algorithm,
given by εB = hFcif . According to Eq. (20) the ratio of
eﬃciencies is given by

εB
εEBmax

= 2r

hFcif

a +

shFcif

a +

1
s

.

(21)

p

p

Equation (21) yields the range of values of hFcif
for which the energy-biased Bennett estimator for βµ
method is more eﬃcient than the standard (unbiased)
a/hFcif the eﬃ-
Bennett algorithm. Note that for s =
ciency ratio given by Eq. (21) reaches its minimum value,
hFcif /a, and therefore εB < εEB if
εB/εEBmax = 4
hFcif > a/16. Hence the energy-biased method is suited
for ﬂuids at high densities or low temperatures or for
molecular ﬂuids with low insertion probability. In this
regime hFcif << a/16 and the dominant term in Eq.
(21) is 1/s, hence εEBmax ≃ sεB.
In other words, the
maximal eﬃciency of the present energy-biased method
is limited by the average number s of independent sam-
ples that can be obtained within one energy-well. As
shown in Appendix B, for the Lennard-Jones ﬂuid we
have observed that in the most unfavourable case (high
density and low temperature) s ∼ [5 − 10].

B. Reconstruction of the energy distribution

u

−∞ f (u′)du for u < uw (i.e.
R

We now show that the reconstruction of f (u) using the
energy-biased procedure (EB) is faster and more eﬃcient
than that obtained using any unbiased sampler which
uniformly explores the whole conﬁgurational space. To
that end we consider the evaluation of the cumulative
probability F (u) =
for
F (u) < Fw). We shall compare the variance of two es-
timators for F : one based on uniform insertion over the
whole domain and the other based on the energy-biased
procedure. The variance of the unbiased estimator is sim-
ply Var(F ) = F (1−F )/n0 and for low energies (F << 1)
its eﬃciency is 1/F . The expected value of the energy-
−∞ h(u′)du′
biased estimator is HFw, where H(u) =
is the cumulative probability of the biased distribution
R
in Eq. (7). This estimator is constructed as a product
of two statistically independent ﬂuctuating variables and
its variance is13

u

VarEB(F ) = Var(HFw) = F 2
w

Var(H)

(22)

+ H 2Var(Fw) + Var(Fw)Var(H).

5

Using Var(H) = H(1 − H)/nw and Var(Fw) = Fw(Fw −
1)/n0 one obtains

VarEB =

Fw(Fw − 1)H 2
n0

+

H(1 − H)F 2
w
nw

+

FwH(1 − H)
n0nw

.

(23)
Note that, as expected, for H ≃ 1 one recovers the vari-
ance of the unbiased insertion method. The interesting
part of the energy distribution is the importance region,
located in the low energy range, where H << 1. In this
regime one can make the approximation 1−H ≃ 1. Using
F = HFw and nw = n0sFw, one gets

VarEB =

F
n0 (cid:18)

F
Fw

+

+

1
s

1
n0sFw (cid:19)

.

(24)

Note that the term in brackets is the reduction in vari-
ance with respect to uniform unbiased sampling. Because
Fw is evaluated from n0 probes, this means that necessar-
ily n0 >> 1/Fw so the third term inside the brackets is
much smaller than unity. On the other hand, for the low
energy range considered F << Fw and one ﬁnally con-
cludes that VarEB ≃ Var(F )/s, where Var(F ) ≃ F/n0 is
the variance obtained in the unbiased uniform sampling
of the whole domain.

The cost associated with the energy-biased procedure
is ncost = n0(1 + sFw/a).
In the case of a Lennard-
Jones liquid we have found that a ≃ 0.17 and s ∼ O(10),
while the optimal cumulative probability is Fw . 10−3.
This means that, in practical situations, sFw/a . 1 and
ncost & n0. Thus, according to Eq.
(24) the energy-
biased sampling procedure is around s times faster than
a uniform unbiased (grid or random) sampler in recon-
structing the low energy range of f (u). As before, s is the
average number of independent samples taken per well.

IV. RESULTS

In order to conﬁrm the foregoing theoretical relations
about eﬃciency and variance reduction, we performed
molecular dynamics simulations of a Lennard-Jones liq-
uid at high density and low temperature (ρ = 0.0236˚A−3
and T = 84K). These simulations were performed in a
cubic periodic box of side L = 10σ. We used the stan-
dard Verlet method2 to integrate Newton’s equations of
motion, incorporating a Langevin thermostat14 to keep
the system in the NVT ensemble.

During the simulation, the iterative loop (1)+(2) ex-
plained in Sec. II was performed m times per time in-
terval δtsamp = 0.5τ , which corresponds to about three
times the collision time. The search for wells performed
in step (1) was done by probing at the nodes of a Carte-
sian grid comprising 153 nodes. This ensured that the
explored cavities are independent. All the cavities found
in step (1) were sampled using the Hit&Run algorithm
(see Appendix A).

A. Estimation of the chemical potential

One way to measure the eﬃciency of the method
is to evaluate the convergence of the estimated value
of the chemical potential for an increasing number of
test-particle probes ncost. Convergence can be calcu-
lated from the diﬀerence between successive values of µn,
where n(= ncost) indicates the total number of evalua-
tions of the test-particle energy. Figure 2 shows how
this diﬀerence decreases in calculations based on both
the energy-biased and the unbiased samples. These cal-
culations correspond to liquid argon with number density
ρ = 0.0236˚A−3 and temperature T = 84K (these values
correspond to ρ = 0.92σ3 and T = 0.7 in Lennard-Jones
units), for which the average of the Fermi function is
hFcif = 8.9 × 10−6. According to Eq. (19) the optimum
value of Fw is 0.0012, which corresponds to uw ≃ 14.19
Kcal/mol. We selected the predicted optimum parameter
(uw = 14.19 Kcal/mol) and performed d = 15 samples
per well. As can be seen in Fig. 2, for equal numbers
of energy probes (n = ncost), the average diﬀerence be-
tween successive estimates of the chemical potential via
the energy-biased method is about ﬁve times smaller than
that obtained with the unbiased sampler. As predicted
by Eq. (21), such a gain in eﬃciency is consistent with
the average number s of independent samples per well
(see table II), which for this simulation was s ≃ 5.

Evaluations of the chemical potential for Lennard-
Jones (LJ) ﬂuids are shown in Table I together with
the estimated eﬃciency of each calculation. For a LJ
ﬂuid with ρ = 0.02360˚A−3 and T = 84K the numeri-
cally obtained net gain is around 7, which coincides with
(21) using s = 7. For illustra-
the prediction in Eq.
tive purposes we also analysed a case for which the eﬃ-
ciency of our implementation of the energy-biased sam-
pling is similar to the uniform-unbiased Bennett method.
For instance, hFcif = 0.0102 for ρ = 0.01755˚A−3 and
T = 178.5K. Using a = 0.165 and the (optimum) num-
a/hFcif ≃ 4 in Eq. (21) one ob-
ber of samples s =
tains εB/εEBmax ≃ 1; our numerical calculations, with
uw = 7.33 and d = 8, conﬁrmed this conclusion. We note
that for any value of uw considered the energy-biased es-
timation of the chemical potential µ agrees within about
0.01 Kcal/mol with the unbiased Bennett result. This is
illustrated in Table II where we show the estimated µ for
the higher density liquid, using several values of uw.

p

6

Unbiased Widom
Energy-biased Widom 
Unbiased Bennett
Energy-biased Bennett

0.0

2.0×10

6

4.0×10

6

6.0×10

6

ncost

Energy-biased Bennett
Unbiased Bennett

µ

n

-0.1

-0.15

-0.2

-0.25

-0.3

-0.35

2

)

n

∆

+
n

µ

-

µ

(

n

-4

10

-5

10

-6

10

-7

10

3×10

6

4×10

6

6

6×10

6

7×10

6

5×10
ncost

FIG. 2:
(Top) The estimation of the chemical potential
plotted against the overall number of energy probes (ncost).
We compare the standard (uniform sampling) Bennet and
Widom methods with the corresponding energy-biased ver-
sions of these methods. The calculations correspond to a
Lennard-Jones ﬂuid with ρ = 0.0236˚A−3, and T = 84K
(ρ = 0.92σ3 and T = 0.7ǫ/kB in reduced LJ units); the
energy-biased sampling was done using uw = 14.19 Kcal/mol
and d = 15 samples per well.
(Bottom) The convergence
measured as the squared diﬀerence between consecutive es-
timations with increasing cost (∆n = 105).
In the energy-
biased method the cost is given by ncost = n0 (1 + dFw/a),
where n0 is the number of random probes used to evaluate
Fw(= F (uw) = 0.00122) and a = 0.165 is the acceptance ra-
tio of the Hit&Run sampler. Circles are the successive values
of (µn − µn+∆n)2 (shown only for the energy-biased case) and
solid lines are the average over twenty consecutive diﬀerences.

B. Reconstruction of the energy distribution f (u)

In Fig. 3 we compare the reconstructed energy dis-
tribution f (u) at energies u < uw with that computed
from an unbiased method, which consists of a large num-
ber of random insertions within the entire conﬁgurational
space. Figure 3 clearly illustrates that the energy-biased
method exactly reproduces the unbiased distribution f (u)
for energies smaller that uw. This attractive feature is a
consequence of the fact that it is easy to exactly cor-

rect for the bias in terms of the cavity energies. This is
not true for the accessible volume of the molecule, as in
cavity-biased procedures6,9.

In order to illustrate the above conclusion we show
in Fig.
4 the estimation of the cumulative probabil-
ity F (u) versus the total number of test-particle en-
ergy probes used for the evaluation. The particular case
shown corresponds to u = 5 Kcal/mol, for a LJ liquid at
ρ = 0.0236˚A−3 and T = 84K. The energy-biased sam-
pling was done using uw = 14.19 Kcal/mol and d = 15

ρ (˚A−3) T (K) µEB
0.02360

84

µB

ε−1
B

ε−1
EB

-0.336 -0.323 0.9 × 105 (1.2 ± 0.1) × 104

εEB/εB
7 ± 1

Fw

d
0.00122 15

TABLE I: Comparison of the chemical potential (in Kcal/mol) calculated via the standard Bennett method (i.e. using uniform
unbiased sampling) and the energy-biased Bennett (subscript EB). The ineﬃciency of both methods (reciprocal of eﬃciency) is
also shown. In the case of the standard Bennett method we write the minimum ineﬃciency (ε−1
B = hFµif ) while the ineﬃciency
of the energy-biased method was obtained from numerical calculation of the variance of βµ, using block-analysis (see Appendix
B or e.g. Refs.2,3) and agrees within error bars with the theoretical expression of Eq. (18) (see text). The error in εEB/εB
comes mainly from the uncertainty in the numerical calculation of VarEB.

7

0.0006

0.0005

0.0004

0.0003

0.0002

0.0001

y
t
i
s
n
e
d
 
y
t
i
l
i
b
a
b
o
r
p

0.0002

0.00015

)
l
o
m

/
l
a
c
k
 
5
 
=
 
u
(
F

0.0001

unbiased sampling
uw=11.8
uw=47.00
uw=165.53

0

0

100
50
150
energy (kcal/mol)

200

Energy-biased sampling 
Uniform unbiased sampling

0

4e+06

8e+06

ncost

FIG. 3: The energy distribution f (u) obtained from 4 × 106
random insertions over the whole conﬁgurational domain is
compared with energy-biased sampling in the restricted con-
ﬁgurational space u < uw. The calculations correspond to
the same case as in Fig. 2. The energy cavities are sampled
using the Hit&Run algorithm, which provides an unbiased
reconstruction of the energy distribution for any value of uw
chosen.

u

−∞ f (u′)du′ for
FIG. 4: The cumulative probability F (u) =
u = 5 Kcal/mol versus the total number of energy evaluations
of the test-particle ncost. The liquid is the same as in Fig. 2.
We compare the estimations of F (u) for grid-sampling (with
a regular mesh of 363 nodes) and for energy-biased samplings
within u < uw = 14.19 Kcal/mol, performing d = 15 samples
per well. The cumulative probability at uw is Fw = F (uw) =
0.00122.

R

V. CONCLUSION

samples per well, and for this calculation we obtained
s ≃ 5 (see Appendix and Table II). Compared with
the unbiased procedure, the reduction of variance pro-
vided by the energy-biased sampler is immediately ap-
parent on inspection of Fig. 4. A numerical evalua-
tion of the variance of each data set in Fig.
4 pro-
vides: VarEB = 4.14 × 10−5/n0, while the (best) result
for the algorithm based on uniform unbiased sampling is
Var(F ) = F/n0 = 1.9 × 10−4/n0. Hence the net gain
in eﬃciency is about 4.6, in agreement with the value of
s = 5 obtained from the independent correlation analy-
sis explained in Appendix B. As shown in Table I, the
estimated net gain in the evaluation of the chemical po-
tential compared with the unbiased Bennett method is
7 ± 1, which is close to the estimate s ≃ 5 obtained from
the analysis of the cumulative probability.

We have presented a new method for sampling the
energy of a test-molecule in order to calculate single-
particle ensemble averages and, in particular, the chem-
ical potential. The method, called energy-biased sam-
pling, restricts the important region to the bounded do-
mains in the test-molecule energy-landscape where the
test-molecule energy u is smaller than a given free param-
eter uw. This energy-biased sampling retains the princi-
pal beneﬁt of cavity-biased methods6,9 in the sense that,
by sampling only within regions with a signiﬁcant Boltz-
mann factor, convergence is greatly accelerated with re-
spect to uniform sampling. Furthermore, because the
energy-biased sampling is accurately deﬁned in terms of
the test-particle energy it has some important beneﬁts:
ﬁrst, it allows accurate reproduction of the test-particle

energy distribution f (u) and the chemical potential; sec-
ond, it is possible to sample cavities of arbitrary shape
(not only spherical ones) and to generalise the cavity
dimensionality to include the rotational degrees of free-
dom in the energy-well reconstruction; ﬁnally, and rather
importantly, it enables one to combine the sampling re-
sults with standard free energy perturbation (FEP) for-
mulae. In particular, we combined it with the Bennett
method8 which minimises the variance of the estimator
and has proved to be the best method in the literature1,5.
Energy-biased sampling is a general protocol to bias the
sampling and consists of two sequential steps: (1) search-
ing and (2) sampling the interior of energy-wells. In this
work we have implemented these two steps using rela-
tively simple algorithms: uniform unbiased search and
Hit&Run sampling. However we note that other solu-
tions are also possible. For instance, non-uniform sam-
pling of the importance region may surely increase the
eﬃciency of the present method. In dense systems, the
searching step becomes the most diﬃcult one and a more
eﬀective extension of this method could be to perform
a biased search (using, for instance, some variation of
the usher algorithm15,16) so as to signiﬁcantly increase
the probability of ﬁnding favourable cavities for insertion
of the test particle. These extensions are left for future
studies.

Acknowledgments

This research was supported by the EPSRC Integra-
tive Biology project GR/S72023 and by the EPSRC Re-
alityGrid project GR/67699. R.D-B acknowledges sup-
port from the European Commission via the MERG-CT-
2004-006316 grant and from the Spanish research grants
FIS2004-01934 and CTQ2004-05706/BQU.

8

i. Choose a random direction e and ﬁnd the intersec-
tions of the cavity border with the line r(λ) = r0+λe,
where λ is a real number. As the cavity A is bounded
the intersection is composed by two points r(λ+) and
r(λ−) (here λ+ > 0 and λ− < 0).

ii. Select a point r1 within the segment (r(λ+), r(λ−)),

i.e.,

r1 = r(λ−) + ξ(r(λ+) − r(λ−))

(A2)

where ξ ∈ (0, 1) is a uniformly distributed random
number.

iii. Sample at r1, set r1 → r0 as the new starting point

and go to (i).

The above procedure is repeated to obtain the desired
number of samples d.
In our case the starting point
for the sample chain, r0, is the test-particle conﬁgura-
tion returned by the algorithm for energy-well searching
(U (r0, R) < uw). In order to locate the borders of the
energy well r(λ+) and r(λ−) we use the following proce-
dure. Starting from r0 we cross the well along the line
deﬁned by the random unit vector e moving in steps of
size δs, i.e., according to

r(k) = r0 + k δs e,

(A3)

with k being an integer starting from k = ±1. The en-
ergy is computed at each point r(k) until one crosses
the edges of the well at k = k+ and k = k− (for which
u(r(k±), R) > uw). An approximate location of the cav-
ity borders is provided by setting λ± = k±. We used
typically δs ≃ 0.3˚A and required, on average, about ﬁve
iterations to cross the well in one random direction (this
value depends on the density and uw). Note that the
acceptance ratio is a = hk+ − k−i−1 and for the high
density cases considered here a ≃ 0.17.

APPENDIX A: SAMPLING BOUNDED REGIONS
WITH THE HIT&RUN ALGORITHM

APPENDIX B: OPTIMAL NUMBER OF
SAMPLING DIRECTIONS

There exists a relatively large literature on sampling
a bounded connected region (see for instance Ref.17 and
references therein).
In this work we have used the so-
called Hit&Run algorithm for its simplicity and good
performance17. The Hit&Run sampler is a special Monte
Carlo Markov chain which draws numbers from an as-
signed distribution12,17 p(r), where r ∈ A lies within
a bounded connected region of an n-dimensional space
A ⊂ Rn. In our case, p(r) is a uniform probability den-
sity over the region Aα
uw such that

p(r) =

1
Ω(Aα
uw )

.

(A1)

The Hit&Run algorithm starts from a point r0 within
the bounded region A and performs the following steps:

It is possible to reduce the cost without increasing the
variance by setting the number of samples per cavity d
equal to or somewhat larger than s, the average number
of independent samples per cavity. Note that the number
of statistically independent samples within one cavity is
s = d/τc, where τc is an empirically estimated autocor-
relation length of the whole chain of data. This number
τc can be estimated from the large m limit of the quan-
tity m Var[F (m)]/Var[F ], where Fc = F [β(u − c)] is the
Fermi function evaluated at a single energy u and F (m)
denotes the mean of m consecutive F values.

The value of s can be estimated by performing sev-
eral Hit&Run samplings with an increasing number of
directions per cavity d > s, then computing τc for the
chain of samples and evaluating d/τc, which should be
nearly independent of d. We carried out this evaluation

of s for varying values of uw within the same system
and for ﬁxed uw and varying density. The results of this
study, reported in Table II, clearly indicate that s does
not greatly vary for a broad range of values of the cavity-
border energy uw. In fact, at low and moderate values
of uw the energy-cavities are isolated and their average
size (in ˚A) grows quite slowly with uw. This is due to
the steepness of the hard-core part of the Lennard-Jones
potential. Above a certain energy uw the cavities be-
come connected and a steep rise in the average size of
the energy-cavities is observed. This is reﬂected in the

value of s. As shown in Table II for uw = 14.19 Kcal/mol
we obtained s ≃ 4.5 and s ≃ 11 for two calculations us-
ing d = 15 and d = 100 respectively. We obtained a
relatively close value s ≃ 7 for twice as large an energy
limit uw = 28.38 Kcal/mol. However using uw = 165.53
Kcal/mol the average number of independent samples in-
creased up to 25, reﬂecting the more complex shape and
larger volume of these energy cavities. In summary, for
the optimum range of values of uw ∼ [10 − 30] Kcal/mol
we ﬁnd s ≃ [5 − 10] in the case of the Lennard-Jones
liquid.

9

∗ r.delgado-buscalioni@ucl.ac.uk
† g.defabritiis@ucl.ac.uk
‡ p.v.coveney@ucl.ac.uk
1 N. Lu, J. K. Singh, and D. A. Kofke, J. Chem. Phys. 118,

2977 (2003).

2 M. Allen and D. Tildesley, Computer Simulations of Liq-

uids (Oxford University Press, 1987).

3 D. Frenkel and B. Smith, Understanding Molecular Simu-
lation: From Algorithms to Applications (Academic Press,
San Diego, 2nd edition, 2002).

4 P. Kollman, Chem. Rev. 93, 2395 (1993).
5 M. R. Shirts and V. S. Pande, J. Chem. Phys. 122, 144107

(2005).

8 C. H. Bennett, J. Comput. Phys. 22, 245 (1976).
9 P. Jedlovszky and M. Mezei, J. Am. Chem. Soc. 122, 5125

(2000).

(1996).

10 A. Pohorille and M. A. Wilson, J. Chem. Phys. 104, 3760

11 C. Jarynski, Phys. Rev. Lett. 78, 2690 (1997).
12 R. L. Smith, Operations Research 32, 1296 (1984).
13 L. Goodman, J. Amer. Stat. Assoc. 55, 708 (1960).
14 K. Kremer and G. Grest, J. Chem. Phys. 92, 5057 (1990).
15 R. Delgado-Buscalioni and P. V. Coveney, J. Chem. Phys.

119, 978 (2003).

16 G. De Fabritiis, R. Delgado-Buscalioni, and P. V. Coveney,

J. Chem. Phys. 121, 12139 (2004).

6 G. L. Deitrick, L. E. Scriven, and H. T. Davis, J. Chem.

17 J. S. Liu, Monte Carlo Strategies in Scientiﬁc Computing

Phys. 90, 2370 (1989).

7 K. S. Shing and K. E. Gubbins, Mol. Phys. 46, 1109 (1982).

(New York: Springer-Verlag, 2001).

uw(Kcal/mol) d

s ncost/n0 µ (Kcal/mol)

28.38
28.38
14.19
14.19
165.53

n0

hFcih
20 4.2 105
1.1 10−3 7
100 2.95 106 1.08 10−3 7
100 4.3 106 2.66 10−3 12
15 1.0 107 2.77 10−3 5
200 2.76 105 1.3 10−5 25

1.5
3.8
1.7
1.1
85.8

-0.32
-0.353
-0.335
-0.334
-0.357

10

TABLE II: Details of the energy-biased calculations in a Lennard-Jones (LJ) liquid at density ρ = 0.0236˚A−3 and temperature
T = 84K (ρ = 0.92 and T = 0.7 in LJ units). We compare the results for varying values of the energy parameter uw, samples
per cavity d and varying number n0 of energy probes within the unbiased distribution. The cumulative probabilities of the
uw
unbiased distribution (Fw = F (uw) =
−∞ f (u)du) are Fw(165.53) = 0.0704, Fw(28.38) = 0.00458, Fw(14.19) = 0.00122. The
average of the Fermi function in the biased distribution hFcih is deﬁned in Eq. (8). The average number of independent
samples per cavity s is obtained from s = d/τc, where the correlation number τc is calculated from the correlation between the
whole chain of data. The overall number of energy probes in the energy-biased method is ncost = n0 (1 + dFw/a), where a is
the acceptance ratio obtained for the Hit&Run sampler, a ≃ 0.17. The estimation of the chemical potential using the standard
(unbiased) Bennett method with 1.1 × 107 energy samples is µ = −0.323 Kcal/mol.

R

