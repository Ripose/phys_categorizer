6
0
0
2
 
b
e
F
 
2
2
 
 
]
h
p
-
c
c
a
.
s
c
i
s
y
h
p
[
 
 
1
v
0
5
1
2
0
6
0
/
s
c
i
s
y
h
p
:
v
i
X
r
a

Eﬃcient computation of matched solutions of the Kapchinskij-Vladimirskij envelope
equations for periodic focusing lattices

Steven M. Lund∗
Lawrence Livermore National Laboratory, Livermore, CA 94550

Sven H. Chilton and Edward P. Lee
Lawrence Berkeley National Laboratory, Berkeley, CA 94720
(Dated: 12 January, 2006, Submitted to Phys. Rev. Special Topics – Accel. and Beams)

A new iterative method is developed to numerically calculate the periodic, matched beam envelope
solution of the coupled Kapchinskij-Vladimirskij (KV) equations describing the transverse evolution
of a beam in a periodic, linear focusing lattice of arbitrary complexity. Implementation of the method
is straightforward. It is highly convergent and can be applied to all usual parameterizations of the
matched envelope solutions. The method is applicable to all classes of linear focusing lattices without
skew couplings, and also applies to all physically achievable system parameters – including where
the matched beam envelope is strongly unstable. Example applications are presented for periodic
solenoidal and quadrupole focusing lattices. Convergence properties are summarized over a wide
range of system parameters.

PACS numbers: 29.27.Bd,41.75.-i,52.59.Sa,52.27.Jt

I.

INTRODUCTION

The Kapchinskij-Vladimirskij (KV) envelope equations[1, 2, 3] are often employed as a simple description of the
transverse evolution of intense ion beams. The equations are coupled ordinary diﬀerential equations that describe the
evolution of the beam edge (or rms radii) in response to applied linear focusing forces of the lattice and defocusing
forces resulting from beam space-charge and transverse phase-space area (emittances). Although the KV envelope
equations are only fully Vlasov consistent with the singular KV distribution, the equations can be applied to describe
the low-order evolution of a real distribution of beam particles when the variation of the statistical beam emittances is
negligible or suﬃciently slow[2]. Large nonlinear ﬁelds that can be produced by non-ideal applied focusing elements,
nonuniform beam space-charge, and species contamination (electron cloud eﬀects, etc.) drive deviations from the KV
model. Such eﬀects are suppressed to the extent possible in most practical designs, rendering the KV model widely
applicable.

The matched solution of the KV envelope equations is the solution with the same periodicity as the focusing
lattice[1, 2, 3]. The matched beam envelope is important because it is believed to be the most radially compact solution
supported by a periodic linear focusing channel[3]. Matched envelopes are typically calculated as a ﬁrst step in the
design of practical transport lattices and for use in initializing more detailed beam simulations to evaluate machine
performance[2]. The matched envelope solution is typically calculated by numerically integrating trial solutions of
the KV equations from assumed initial conditions over one lattice period and searching for the four initial envelope
coordinates and angles that generate the solution with the periodicity of the lattice[2, 3, 4]. An optimal formulation
of the conventional root ﬁnding procedure for envelope matching has been presented by Ryne[4]. Conventional root
ﬁnding procedures for matching can be surprisingly problematic even for relatively simple focusing lattices. Variations
in initial conditions can lead to many inﬂection points in the envelope functions at the end of the lattice period. Thus
initial guesses close to the actual values corresponding to the periodic solution are often necessary to employ standard
root ﬁnding techniques. This is especially true for complicated focusing lattices with low degrees of symmetry and
where focusing strengths (or equivalently, undepressed single particle phase advances) are large. For large focusing
strength and strong space-charge intensity, the matched envelope solution can be unstable over a wide range of system
parameters[2, 3]. Such instabilities can restrict the basin of attraction when standard numerical root ﬁnding methods
are used to calculate the needed matching conditions — especially for certain classes of solution parameterizations.

In this article we present a new iterative procedure to numerically calculate matched envelope solutions of the KV
equations. The basis of this procedure is that the KV distribution of particle orbits internal to the beam must have
a locus of turning points consistent with the beam edge (envelope). In the absence of beam space-charge, betatron

∗smlund@llnl.gov

amplitudes calculated from the sine- and cosine-like principal orbits describing particles moving in the applied focusing
ﬁelds of the lattice directly specify the matched beam envelope[5]. For ﬁnite beam space-charge, the principal orbits
describing the betatron amplitudes and matched beam envelope cannot be a priori calculated because the defocusing
forces from beam space-charge uniformly distributed within the (undetermined) beam envelope are unknown.
In
the iterative matching (IM) method, the relation between the betatron amplitudes and the particle orbits is viewed
as a consistency equation. Starting from a simple trial envelope solution that accounts for both space-charge and
and applied focusing forces in a general manner, the consistency condition is used to iteratively correct the envelope
functions until converged matched envelope solutions are obtained that are consistent with particle orbits internal to
the beam.

The IM method oﬀers superior performance and reliability in constructing matched envelopes over conventional
root ﬁnding because the IM iterations are structured to reﬂect the periodicity of the actual matched solution rather
than searching for parameters that lead to periodicity. The IM method works for all physically achievable system
parameters (even in cases of envelope instability) and is most naturally expressed and rapidly convergent when relative
beam space-charge strength is expressed in terms of the depressed particle phase advance. All other parameterizations
of solutions (speciﬁed perveances and emittances, etc.) can also be carried out by simple extensions of the IM method
rendering the approach fully general. The natural depressed phase advance parameterization is also useful when
carrying out parametric studies because phase advances are the most relevant parameters for analysis of resonance-
like eﬀects central to charged particle dynamics in accelerators. The IM method provides a complement to recent
analytical perturbation theories developed to construct matched beam envelopes in lattices with certain classes of
symmetries[6, 7, 8, 9]. In contrast to these analytical theories, the IM method can be applied to arbitrary linear
focusing lattices without skew couplings. The highly convergent iterative corrections of the IM method have the same
form for all order iterations after seeding, rendering the method straightforward to code and apply to numerically
generate accurate matched envelope solutions.

The organization of this paper is the following. After a review of the KV envelope equations in Sec. II, various
properties of matched envelope solutions and the continuous focusing limit are analyzed in Sec. III. These results
are used in Sec. IV to formulate the IM method for calculation of matched solutions to the KV envelope equations.
Example applications of the IM method are presented in Sec. V to illustrate application and convergence properties
of the method over a wide range of system parameters for a variety of systems. Concluding comments in Sec VI
summarize the advantages of the IM method over conventional techniques.

II. THEORETICAL MODEL

1

We consider an unbunched beam of particles of charge q and mass m coasting with axial relativistic factors βb = const
β2
and γb = 1/
b . In the KV model, the beam is propagating in a linear focusing lattice without skew couplings
and has uniform charge density within an elliptical cross-section with principal radii rx and ry along the (transverse)
x- and y-coordinate axes. When self-ﬁelds are included and image eﬀects are neglected, the envelope radii consistent
with the KV distribution evolve according to the so-called KV envelope equations[1, 2, 3]

p

−

′′
j (s) + κj(s)rj(s)
r

2Q

−

rx(s) + ry(s) −

ε2
j
r3
j (s)

= 0.

Here, primes denote derivatives with respect to the axial machine coordinate s, the subscript j ranges over both
transverse coordinates x and y, the functions κj(s) represent linear applied focusing forces of the transport lattice,
Q = const is the dimensionless perveance, and εj = const are the rms edge emittances. Equations relating the
functions κj to magnetic and/or electric ﬁelds of practical focusing elements are presented in Ref. [3]. The perveance
provides a dimensionless measure of self-ﬁeld defocusing forces internal to the beam[2] and is deﬁned as

Q =

qI
2πǫ0mc3γ3

b β3
b

.

Here, I is the constant beam current, c is the speed of light in vacuo, and ǫ0 is the permittivity of free space. The
perveance Q can be thought of as a scaled measure of space-charge strength[2]. The rms edge emittances εj provide
a statistical measure of beam phase-space area projections in the x–x′ and y–y′ planes[2].

When the emittances are constant (εj = const), the KV envelope equations (1) are consistent with the Vlasov
equation only for the KV distribution[1, 10], which is a singular function of Courant-Snyder invariants. This singular
structure can lead to unphysical instabilities within the Vlasov model[11]. However, the KV envelope equations can
be applied to physical (smooth) distributions in an rms equivalent beam sense[2], with the envelope radii and the

2

(1)

(2)

emittances deﬁned by statistical averages of the physical distribution as

and

rx = 2

,
i

x2
h
p

ry = 2

,
i

y2
h
p

εx = 4

εy = 4

x2
h
y2
(cid:2)
h
(cid:2)

′2

x

′2

ih
y
ih

′
xx

′

yy

2
i
2
i

1/2

,

1/2
(cid:3)

.

i − h

i − h

(cid:3)

h· · · i

denotes a transverse statistical average over the beam distribution function, and for notational simplicity,
Here,
= 0). In this rms equivalent sense, the emittances εj will generally
we have assumed zero centroid oﬀset (e.g.,
evolve in s. If this variation has negligible eﬀect on the rj, then the KV envelope equations can be applied with
εj = const to reliably model practical machines. This must generally be veriﬁed a posteriori with simulations of the
full distribution.

x
i
h

For appropriate choices of the lattice focusing functions κj(s), Eq. (1) can be employed to model a wide range
of transport channels, including solenoidal and quadrupole transport. For solenoidal transport, the equations must
be interpreted in a rotating Larmor frame (see Appendix A of Ref. [3]). In a periodic transport lattice, the κj are
periodic with fundamental lattice period Lp, i.e.,

The beam envelope is said to be matched to the transport lattice when the envelope functions have the same periodicity
as the lattice:

κj(s + Lp) = κj(s).

rj (s + Lp) = rj(s).

For speciﬁed focusing functions κj(s), beam perveance Q, and emittances εj, the matching condition is equivalent to
requiring that rj and r′
j satisfy speciﬁc initial conditions at s = si when the envelope equations (1) are integrated
as an initial value problem. The required initial conditions generally vary with the phase of si in the lattice period
(because the conditions vary with the local matched solution). In conventional procedures for envelope matching,
needed initial conditions are typically found by numerical root ﬁnding starting from guessed seed values[3]. This
numerical matching can be especially problematic when: applied focusing strengths are large, the focusing lattice
is complicated and devoid of symmetries that can reduce the dimensionality of the root ﬁnding, choices of solution
parameters require extra constraints to eﬀect, and where the matched beam envelope is unstable.

The undepressed particle phase advance per lattice period σ0j provides a dimensionless measure of the strength of

the applied focusing functions κj describing the periodic lattice[3, 5]. The σ0j can be calculated from[5]

where M0j(s
we have

si) denotes the 2
|

×

2 single particle transfer matrix in the j-plane from axial coordinate si to s. Explicitly,

cos σ0j =

1
2

Tr M0j(si + Lp|

si),

M0j(s

si) =
|

C0j(s
C′
0j(s

si) S0j(s
|
si) S′
0j(s
|

si)
|
si)
|

,

(cid:19)

(cid:18)

F

′′
0j(s

si) + κj(s)F0j (s
|

si) = 0,
|

where the C0j(s

si) and S0j(s
|

si) denote cosine-like and sine-like principal orbit functions satisfying
|

with F representing C or S with C0j subject to cosine-like initial (s = si) conditions C0j(si|
and with S0j subject to sine-like initial conditions S0j(si|
in terms of C0j and S′

si) = 0 and S′

0j(si|

0j as

si) = 1 and C′
si) = 0,
si) = 1. Equation (7) can be expressed

0j(si|

cos σ0j =

1
2

[C0j(si + Lp|

′

si) + S

0j(si + Lp|

si)].

The σ0j are independent of the particular value of si used in the calculation of the principal functions. For some
particular cases such as piecewise constant κj the principal functions F0j can be calculated analytically. But, in
general, the F0j must be calculated numerically. In the absence of space-charge, the particle orbit is stable whenever
σ0j < 180◦ and parametric bands of stability can also usually be found for σ0j > 180◦[2, 3, 12]. For a stable orbit, the

3

(3)

(4)

(5)

(6)

(7)

(8)

(9)

(10)

scale of the κj (i.e., κj →
ακj with α = const setting the scale of the speciﬁed κj) can always be regarded as being
set by the σ0j . In this context, Eq. (10) is employed to ﬁx the scale of the κj in terms of σ0j and other parameters
deﬁning the κj. Because there appears to be no advantage in using stronger focusing with σ0j > 180◦ in terms of
producing more radially compact matched envelopes[3, 13], we will assume in all analysis that follows that the κj are
suﬃciently weak to satisfy σ0 < 180◦.

The formulation given above for calculation of the undepressed principal orbits C0j and S0j and the undepressed
particle phase advances σ0j can also be applied to calculate the depressed principal orbits Cj and Sj and the depressed
phase advances σj in the presence of uniform beam space-charge density for a particle moving within the matched
KV beam envelopes. This is done by replacing

κj →
in Eqs. (9) and dropping the subscript 0s in Eqs. (7)–(10) for notational clarity (i.e., C0j →
Explicitly, the depressed principal functions satisfy

κj −

2Q
(rx + ry)rj

Cj and S0j →

Sj).

si)
|
with F representing C or S with Cj subject to Cj(si|
S′
si) = 1, and the depressed phase advances satisfy
j(si|

si) + κj(s)Fj (s
|

F

′′
j (s

2QFj(s

si)
|

= 0,

−

si) = 1 and C′

[rx(s) + ry(s)]rj (s)
j (si|

si) = 0, and Sj subject to Sj(si|

si) = 0 and

[Cj (si + Lp|
For a stable orbit, it can be shown that the σj can also be calculated from the matched envelope as[3, 5]

j(si + Lp|

cos σj =

si) + S

si)].

′

1
2

σj = εj

si+Lp

ds
r2
j (s)

.

si

Z

≤

σj/σ0j ≤

1 with σj/σ0j →

for ﬁnite Q), and σj/σ0j →

This formula can also be applied to calculate σ0j by using the matched envelope functions rj calculated with Q = 0.
Matched envelope solutions of Eqs. (1) can be regarded as being determined by the focusing functions κj, the
perveance Q, and the emittances εj. The lattice period Lp is implicitly speciﬁed through the κj. We will always
regard the scale of the κj as being set by the undepressed phase advances σ0j through Eq. (10). For σ0j < 180◦
there is no ambiguity in scale choice and the use of the σ0j as parameters allows disparate classes of lattices to be
analyzed in a common framework[3]. The depressed phase advances σx and σy can be employed to replace up to
two of the three parameters Q, εx, and εy. Such replacements can be convenient, particularly when carrying out
parametric surveys (for example, see Ref. [3]) because σj/σ0j is a dimensionless measure of space-charge strength
0, or
satisfying 0
0).
εj → ∞
We will discuss calculation of matched beam envelopes for the useful parameterization cases listed in Table I. In cases
typical of linear accelerators the focusing functions have equal strength in the x- and y-planes giving σ0x = σ0y. In
such plane symmetric cases we denote σ0j ≡
σ0. In practical situations where the focusing lattice and emittances
ε, then the depressed phase advance is also plane symmetric with
are both plane symmetric with σ0j ≡
σ and parameterization cases 2 and 3 are identical. It is assumed that a unique matched envelope solution
σj ≡
exists independent of the parameterization when the κj are fully speciﬁed. There is no known proof of this conjecture,
but numerical evidence suggests that it is correct for simple focusing lattices (i.e., simple κj) when σ0j < 180◦. In
typical experimental situations, note that transport lattices are ﬁxed in geometry and excitations of focusing elements
in the lattices can be individually adjusted. In the language adopted here, such lattices with diﬀerent excitations in
focusing elements (both overall scale and otherwise) correspond to diﬀerent lattices described by diﬀerent κj with
corresponding diﬀerent matched envelopes.

1 representing a warm beam with negligible space-charge (i.e., Q
0 representing a cold beam with maximum space-charge intensity (i.e., εj →

σ0 and εj ≡

→

III. MATCHED ENVELOPE PROPERTIES

In development of the IM method in Sec. IV, we employ a consistency equation between depressed particle orbits
within the beam and the matched envelope functions (III A) and use a continuous focusing description of the matched
beam (III B) to construct a seed iteration. Henceforth, we denote lattice period averages with overbars, i.e., for some
quantity ζ(s),

4

(11)

(12)

(13)

(14)

(15)

si+Lp

ds
Lp

ζ(s).

ζ

≡

si

Z

TABLE I: Possible parameterizations of matched envelope solutions.

Case Parameters

0
1
2
3

κj (σ0j ), Q, εj
κj (σ0j ), Q, σj
κj (σ0j ), εj, and one of σj
κj (σ0j ), σj, and one of εj

A. Consistency condition between particle orbits and the matched envelope

We calculate nonlinear consistency conditions for the matched envelope functions rj and the depressed principal
orbit functions Cj and Sj as follows. First, the transfer matrix Mj of the depressed particle orbit in the j-plane is
expressed in terms of betatron function-like formulation as[5]

with,

Here,

Mj(s

si) =
|

Cj(s
C′
j(s

si) Sj(s
|
si) S′
j(s
|

si)
|
si)
|

(cid:19)

(cid:18)

cos ∆ψj(s)

sin ∆ψj(s),

r′
j(si)rj (s)
εj

−

Cj (s

si) =
|

Sj(s

si) =
|

C

′
j (s

si) =
|

−

S

′
j(s

si) =
|

rj (s)
rj (si)
rj (si)rj(s)
εj
r′
j(s)
rj (si) −
εj
rj(si)rj (s)
(cid:20)
rj (si)
rj (s)

(cid:20)

sin ∆ψj (s),

cos ∆ψj (s)

r′
j (si)
rj(s)
(cid:21)
j(si)r′
r′
εj
(cid:21)
rj(si)r′
j (s)
εj

j (s)

+

cos ∆ψj(s) +

sin ∆ψj(s).

sin ∆ψj(s),

∆ψj(s) = εj

s

d˜s
r2
j (˜s)

si

Z

is the change in betatron phase of the particle orbit from s = si to s and the principal functions Cj and Sj are
calculated including the linear space-charge term of the uniform density elliptical beam from Eq. (12) . Note that
εjβj can be used in Eqs. (17) and (18) to express the results more conventionally in terms of the betatron
rj ≡
amplitude functions βj describing linear orbits internal to the beam in the j-plane[5]. These generalized betatron
functions are periodic [i.e., βj(s + Lp) = βj(s) and include the transverse defocusing eﬀects of uniformly distributed
space-charge within the KV equilibrium envelope. Recognizing that ∆ψj(si + Lp) = σj [see Eq. (14)] and that the
matched envelope functions rj have period Lp gives

p

βj(s) =

r2
j (s)
εj

=

[Mj]12(s + Lp|
s)
sin σj

=

Sj(s + Lp|
sin σj

s)

.

Here, [Mj]12 denotes the 1, 2 component of the 2
Eq. (13) or Eq. (14).

×

2 matrix Mj and σj can be equivalently calculated from either

Equation (19) can be applied to numerically calculate the consistency conditions for the matched envelope functions
rj on a discretized axial grid of s locations. As written, the principal orbit functions employed (i.e., the Cj and
Sj) need to be independently calculated at each s-location on the grid through one lattice period. The fact that
every period is the same can be applied to simplify the calculation. For any initial axial coordinate si we have
Mj(s + Lp|
s). Multiplying this equation from the right side by the identity
matrix I = Mj(s
si)
gives

s) = Mj(s + Lp|
si + Lp)
·
si) where M−1
j (s
si)
|
·
|

is the inverse matrix and using Mj(si + Lp|
s)

si) = Mj(si + Lp|
|

Mj(si + Lp|

Mj(s

M−1

·

j

Mj(s + Lp|

s) = Mj(s

si)
|

·

Mj(si + Lp|

si)

·

M−1

j (s

si).
|

5

(16)

(17)

(18)

(19)

(20)

Some straightforward algebra employing Eqs. (16), (19), and (20), and the Wronskian (or symplectic) condition on
Mj[5]

yields

Cj(s

si)S
|

′
j(s

si)
|

−

Sj(s

si)C
|

′
j (s

si) = 1
|

βj(s) =

r2
j (s)
εj

=

S2

j (s
si)
|
si)/ sin σj
Sj(si + Lp|
+

Sj(si + Lp|
sin σj

si)

Cj(s

si) +
|

(cid:20)

cos σj −

Cj(si + Lp|
si)

Sj(si + Lp|

si)

Sj(s

2

.

si)
|
(cid:21)

Equation (22) explicitly shows that the linear principal functions Cj and Sj need only be calculated in s from some
arbitrary initial point (si) over one lattice period (to si + Lp) to calculate the consistency condition for the matched
r2
envelope functions rj (s), or equivalently, the betatron amplitude functions βj(s)
j (s)/εj. Equation (22) can also
be derived using Courant-Snyder invariants of particle orbits within the beam.

≡

Equations (13) and (22) form the foundation of an iterative numerical method developed in Sec. IV to calculate
the matched beam envelope for any lattice. These equations express the intricate connection between the bundle of
depressed particle orbits within the uniform density KV beam and the locus of maximum particle excursions deﬁning
the envelope functions rj . The method will be iterative because the consistent matched envelope functions rj are
necessary to integrate the linear diﬀerential equations for the depressed orbit principal functions Cj and Sj. However,
in the limit Q
0, the principal functions do not depend on the rj and the matched envelope can be immediately
calculated from the equations. Thus, the periodic zero-current matched beam envelope can be directly calculated
using Eq. (22) in terms of the two independent, aperiodic linear orbits (i.e., C0j and S0j) integrated over one lattice
period.

→

Additional constraints on the matched envelope functions rj and/or betatron functions βj are necessary to formulate
the IM method for parameterizations where one or more of the parameters Q and εj need to be eliminated (see Table I).
Appropriate constraints can be derived by taking the period average of Eq. (1) for a matched envelope, giving

1

κjrj −

2Q

rx + ry −

ε2
j

1
r3
j

= 0.

B. Continuous limit

κj →

2

σ0j
Lp (cid:19)

2

σ0j
Lp (cid:19)

(cid:18)

2Q

rj −

rx + ry −

ε2
j
3 = 0.
rj

In the continuous focusing approximation, we take the lattice focusing functions κj as constants set according to

(cid:18)
with the σ0j calculated from Eq. (10) consistent with the actual s-varying periodic focusing functions κj. Then we
replace rj →
rj in the KV envelope equations (1) and take rj = const to obtain the continuous limit envelope equation

Equation (25) provides an estimate of the lattice period average envelope radii rj in response to applied focusing forces
and defocusing forces from beam space-charge and thermal (emittance) eﬀects. Solutions for rj will be employed to
seed the IM method of constructing matched envelope solutions. In general, the continuous limit approximations
80◦. However, even for higher values of
tend to be more accurate for weaker applied focusing strengths with σ0j <
σ0j < 180◦, the formulas can still be applied to seed iterative numerical matching methods if the methods have a
∼
suﬃciently large “basin of attraction” to the desired solution.

For case 0 parameterizations (speciﬁed σ0j , Q, and εj) the solutions of Eq. (25) will, in general, need to be calculated
numerically from a trial guess. Certain limits are analytically accessible and often relevant. If the beam perveance Q
is zero, or equivalently if σj = σ0j , then Eqs. (25) decouple and are trivially solved as

εj
(σ0j /Lp)

.

rj =

r

6

(21)

(22)

(23)

(24)

(25)

(26)

Alternatively, this result can be obtained using rj = rj in Eq. (14) with σj →
with σ0x = σ0y ≡
quadratic equation in r2

ε, then rx = ry ≡

σ0 and εx = εy ≡
b is solved as

σ0j . In the case of a symmetric system
rb and the envelope equations decouple and the resulting

rb =

1
(σ0/Lp) 

Q
2

+

1
2 s



Q2 + 4

ε2

.

2

σ0
Lp (cid:19)

(cid:18)

1/2





In parameterization cases 1–3, the continuous limit solutions rj must be expressed using the depressed phase
advances σj to eliminate one or more of the parameters Q and εj. In these cases, if the emittances εj are known, then
Eq. (14) can be employed to estimate

Alternatively, if the perveance Q is known but one or more of the emittances εj is unknown, we can use Eq. (28) to
eliminate the emittance term(s) in Eq. (25) obtaining (σ2
p/(rx + ry). Taking the ratio of the x- and
0j −
y-equations yields

σ2
j )rj = 2QL2

Back-substitution of this result in (σ2

j )rj = 2QL2
σ2

p/(rx + ry) then gives

0j −

εj
(σj /Lp)

.

rj =

r

ry
rx

=

σ2
0x −
σ2
0y −

σ2
x
σ2
y

.

rx =

ry =

√2QLp

(σ2

0x −

r

x) + (σ2
σ2
0x
(σ2
0y

−σ2
x)2
−σ2
y)

√2QLp

(σ2

0y −

σ2
y) +

r

(σ2
0y
(σ2
0x

−σ2
y)2
−σ2
x)

,

.

Alternative smooth-limit formulations in the literature[14, 15] can also be employed to estimate the rj for systems

with high degrees of symmetry.

IV. NUMERICAL ITERATIVE METHOD FOR MATCHED ENVELOPE CALCULATION

We formulate a numerical iterative matching (IM) method to construct the matched beam envelope functions rj (s)
over one lattice period Lp using the developments in Sec. III. The IM method is formulated for arbitrary periodic
focusing functions κj. Constraints necessary to apply the IM formalism to all cases of envelope parameterizations
listed in Table I are derived.

Label all quantities varying with iteration number with a superscript i (i = 0, 1, 2,

) denoting the iteration
· · ·
order. For example, the ith order envelope functions are labeled ri
j . The iteration label should not be confused with
the initial coordinate si and the initial “seed” iteration corresponds to i = 0. Parameters such as the perveance Q
or emittances εj will also be superscripted to cover parameterization cases where the quantities are unspeciﬁed and
are calculated from the envelope functions and other parameters (see Table I). For example, εi
j denotes the j-plane
emittance at the ith iteration and for parameterization cases where the value of εj is speciﬁed, then εi
j = εj = const.
1, we calculate reﬁnements of the principal orbit functions [see Eqs. (9) and (11)] in terms of the

For iterations i

≥
envelope calculated at the previous, i

1 iteration from

−

F i ′′
j + κjF i

j −

2Qi−1F i
j
x + ri−1
)ri−1
j

(ri−1

y

= 0.

j denotes Ci
Here, F i
and Si
j(si|

si) or Si
j(s
|
si) = 0, Si ′
j (si|

j(s

si) which are subject to the initial (s = si) conditions Ci
|

si) = 0
j depend on the envelope functions and perveance of the prior,

si) = 1. Note that the F i

j (si|

j(si|

si) = 1, Ci ′

7

(27)

(28)

(29)

(30)

(31)

1, iteration. previous iteration envelope functions. Updated envelope functions ri

j and/or betatron functions βi
j

i
are calculated [see Eq. (22)] from the F i

−

j for all i from

βi
j(s) =

[ri

j(s)]2
εi
j

=

si)]2
[Si
j(s
|
si)/ sin σi
Si
j(si + Lp|
j
Si
j(si + Lp|
sin σi
j

si)

cos σi
Ci
j (si + Lp|
j −
Si
si)
j(si + Lp|
Here, if the parameterization does not specify the depressed phase advances as σi
Eq. (13)] for all i from

si) +
|

Ci
"

j (s

+

si)

Si

j(s

si)
|

#

2

.

j = σj, then they are calculated [see

cos σi

j =

1
2

[Ci

j(si + Lp|

si) + Si′

j (si + Lp|

si)].

In parameterization cases 0 to 3 (see Table I), one or more of the needed quantities among Qi, εi

speciﬁed (e.g., for case 1: εi
j 6
(i + 1) iteration principal functions from Eq. (31). Equations (33) and/or the constraint equations (23) with Q
εj →
to fully realize each iteration as follows for each case:

j are not
= εj speciﬁed) and must be calculated to apply Eq. (32) and/or to calculate the next
Qi,
j ) can be employed to calculate parameter eliminations necessary

ri
j (or in some cases rj →

εi
j, and rj →

j, and σi

jβi
εi

→

q

Case 0 (κj, Q, εj speciﬁed) The σi

j can be calculated from Eq. (33).

Case 1 (κj, Q, and σj speciﬁed) The εi

j can be calculated using Eq. (23) expressed in betatron form to obtain

εi
x
2Qi =

1
x+√εi
y/εi

√βi

x√βi
y

κx

βi
x −

1/(βi

x)3/2

εi
y
2Qi =

1
y√βi

√εi

x/εi

x+√βi
y

κy

βi
y −

1/(βi

y)3/2

,

,

p

q

εi
y
εi
x

s

κx

=

κy

p

q

βi
x −
βi
y −

1/(βi

x)3/2

.

1/(βi

y)3/2

2Qi =

κjri

j −
1/(ri

j)2/(ri
(εi
x + ri
y)

j)3

with the ratio εi

y/εi

x on the right hand side of the equations determined by

Note that expressing the constraints in terms of betatron functions βi
envelope functions ri
of the envelope equations, the βi
values of the εi
j.

j cannot be calculated from Eq. (32) until the εi

j is necessary in this case because the
j are known, whereas because of the structure
j can be calculated from Eq. (32) without a priori knowledge of the

j = (ri

j )2/εi

Case 2 (κj, εj, and σx speciﬁed; or κj, εj, and σy speciﬁed) If necessary, either σi
from Eq. (33) to enable full speciﬁcation of the functions βi
and the βi

x or σi
y can be calculated
j. Then, Qi can be calculated using Eq. (34)

j or ri

j, or alternatively, using

with εi

j = εj.

Case 3 (κj, σj , and εx speciﬁed; or κj, σj, and εy speciﬁed) First, Eq. (35) and the βi
to calculate εi
j = εj) using Eq. (34) and the βi
εi

j, or alternatively, with Eq. (36) and the ri
j .

y from speciﬁed εx, or εi

x from speciﬁed εy. Then, Qi can be calculated from the εi

j functions can be applied
j (if speciﬁed,

8

(32)

(33)

(34)

(35)

(36)

9

(37)

−

(38)

The seed i = 0 iteration is treated as a special case where the continuous limit formulas derived in Sec. III B are
applied to estimate the leading order defocusing eﬀect of space-charge on the beam. In this case the principal functions
are calculated from

F 0 ′′
j + κjF 0

j −

2QF 0
j
(rx + ry)rj

= 0.

si) = 1, C0 ′

→

→

εj.

j (s

j (si|

j (si|

si) = 0, S0 ′

si) or S0
|

Q and εj →

Q and εj →

j denotes C0
j (s
j (si|

si) subject to the initial (s = si) conditions C0
|

Here, F 0
si) = 0 and
S0
si) = 1, and Q and rj denote the continuous focusing approximation perveance and envelopes
j (si|
calculated from the formulation in Sec. III B with Q
εj. The continuous focusing values of Q and εj
used in calculating the rj are set by the parameterization values in cases where they are speciﬁed (e.g., Q = Q for Q
speciﬁed). Otherwise, Q and/or the εj are calculated in terms of other parameters using the appropriate constraint
equations from Eqs. (26)–(30) applied with Q
Note that the seed envelope functions r0

j calculated under this procedure are not the continuous limit functions
(i.e., r0
= rj). Likewise, in parameterizations where they are not held ﬁxed, the seed perveance and emittances will
j 6
not equal the continuous focusing values (i.e., Q0
= εj). Due to Eq. (32), the seed envelope functions
r0
j will have a (dominant) contribution to the envelope ﬂutter from the applied focusing ﬁelds of the lattice with
a correction due to space-charge defocusing forces from the continuous limit formulas. This approximation should
produce seed envelope functions r0
j that are signiﬁcantly closer to the actual periodic envelope functions rj than would
be obtained by simply applying continuous limit formulas (i.e., taking r0
j = rj) or neglecting the eﬀects of space-charge
altogether [i.e., by calculating r0
j using Eq. (22) with Q = 0]. Generally speaking, a seed iteration closer to the desired
solution can reduce the number of iterations required to achieve tolerance, and more importantly, can help ensure a
starting point within the basin of attraction of the method, thereby reducing the likelihood of algorithm failure. At
the expense of greater complexity and less lattice generality, alternative seed iterations can be generated using low
order terms from analytical perturbation theories for matched envelope solutions[6, 7, 8, 9]. In certain cases, these
formulations may generate seed iterations closer to the matched solution.

= Q and/or ε0
j 6

Iterations can be terminated at some value of i where the maximum fractional change between the i and (i

1)

iterations is less than a speciﬁed tolerance tol, i.e.,

Max

ri−1
ri
j −
j
ri
j

tol,

≤

(cid:12)
(cid:12)
(cid:12)
(cid:12)
(cid:12)

(cid:12)
(cid:12)
(cid:12)
(cid:12)
where Max denotes the maximum taken over the lattice period Lp and the component index j = x, y. Many numerical
(cid:12)
methods will be adequate for solving the linear ordinary diﬀerential equations for the principal functions Ci
j of
the iteration because they are only required over one lattice period. Generally, the principal functions will be solved
at (uniformly spaced) discrete points in s over the lattice period. These discretized solutions can then be employed
with quadrature formulas to calculate any needed integral constraints to aﬀect the envelope parameterizations given
in Table I. Finally, the convergence criterion (38) can be evaluated at the discrete s-values of the numerical solution
for ri
that are needed for calculation of the ith iteration.
It is usually suﬃcient to evaluate the convergence criterion at some limited, randomly distributed sample of s-values
within the lattice period. Issues of convergence rate and the basin of attraction of the method are parametrically
analyzed for examples corresponding to typical classes of transport lattices in Sec. V.

j at the ith iteration using saved i

1 iteration values for ri−1

j and Si

−

j

V.

EXAMPLE APPLICATIONS

In this section we present examples of the IM method developed in Sec. IV to construct matched envelope solutions
and explore parametric convergence properties for example solenoidal and quadrupole periodic focusing lattices. For
simplicity, examples are restricted to plane-symmetric focusing lattices with equal undepressed particle phase advances
in the x- and y-planes (i.e., σ0j ≡
ε). Under
σ) and parametrization cases
these assumptions, the depressed phase advances σj are also equal in both planes (σj ≡
2 and 3 of Table I are identical. First, parameterization cases 1 (speciﬁed κj, Q and σ) and 2 (speciﬁed κj, ε, and
σ) are examined in Sec. V A. Both of these cases have speciﬁed depressed phase advance σ and represent the most
“natural” parameterization of the IM method. Then results in Sec. V A are extended in Sec. V B to illustrate how the
IM method can be applied to parameterization case 0 (speciﬁed κj, Q, and ε) with unspeciﬁed σ while circumventing
practical implementation diﬃculties.

σ0) and a symmetric beam with equal emittances in both planes (εj ≡

6
10

∈

−

κj|
|

For simplicity, we further restrict our examples to periodic solenoidal and quadrupole doublet focusing lattices
with piecewise constant focusing functions κj(s) as illustrated in Fig. 1. Solenoidal focusing has κx(s) = κy(s),
κy(s). For both the solenoid and quadrupole lattices
and alternating gradient quadrupole focusing has κx(s) =
(0, 1) is the fractional occupancy of the focusing elements in the lattice period Lp. The focusing
illustrated, η
= ˆκ = const within the axial extent of the optics and zero outside.
strength of the elements is taken to be
For solenoids, κj = ˆκ > 0 in the focusing element; and for quadrupoles κx =
κy = ˆκ > 0 in the focusing-in-x
ˆκ < 0 in the defocusing-in-x element. The free drift between solenoids
κy =
element of the doublet, and κx =
has axial length d = (1
η)Lp and
−
d2 = (1
= d2). A syncopation
α)(1
η)Lp separating focusing and defocusing quadrupoles can be unequal (i.e., d1 6
[0, 1] provides a measure of this asymmetry. Without loss of generality, the lattice can always be
parameter α
[0, 1/2], with α = 0 corresponding to the focusing and defocusing lenses touching each other
relabeled to take α
∈
η)Lp] and α = 1/2 corresponding to a so-called FODO lattice with equally spaced drifts
[d1 = 0 and d2 = (1
[d1 = d2 = (1
η)Lp/2]. These focusing lattices are discussed in more detail in Ref. [3], including a description of how
the focusing strength parameter ˆκ is related to magnetic and/or electric ﬁelds of physical realizations of the focusing
elements.

η)Lp. For quadrupole doublet focusing, the two drift distances d1 = α(1

−

−

−

−

−

−

−

−

∈

κ

x(s)

a) Periodic Solenoid
y )

x = κ

 ( κ

^
κ

d/2

ηLp

d/2

d/2

b) Periodic Quadrupole Doublet

κ

x(s)

 ( κ

x = −κy )

d = (1−η)Lp

^
κ

d1

ηLp/2

d2

F Quad

ηLp/2

D Quad

Lp
Lattice Period

^
−κ
d1 = α(1−η)Lp
d2 = (1−α)(1−η)Lp

s

s

FIG. 1: Periodic solenoid and quadrupole focusing lattices with piecewise constant κj .

As mentioned, for general lattices the scale of the focusing functions κj can be set by the undepressed phase advances
σ0j using Eq. (10). For the piecewise constant κj deﬁned in Fig. 1, this calculation[3] shows that the focusing strength
ˆκ
|

is related to σ0 by the constraint equations:

|

Solenoidal Focusing,
Quadrupole Focusing.

1−η
η Θ sin(2Θ),

−

cos(2Θ)
cos Θ cosh Θ
+ 1−η
η Θ(cos Θ sinh Θ
α) (1−η)
2α(1

2

cos σ0 = 


Here, for both solenoidal and quadrupole focusing lattices, Θ =
ηLp/2. In the analysis that follows, Eq. (39) is
|
employed to numerically calculate Θ for a speciﬁed value of σ0, and then ˆκ is calculated in terms of other speciﬁed
= 4Θ2/(ηLp)2. The undepressed phase advance σ0 is measured in degrees per lattice period.
lattice parameters as
Integrations of needed principal orbits to implement the IM method are carried out with the with initial conditions
(s = si) corresponding to the axial middle of drifts separating focusing elements.

η2 Θ2 sin Θ sinh Θ.

sin Θ cosh Θ)

ˆκ
|
p

ˆκ
|
|

(39)

−

−

−

Typical matched envelope solutions rj are shown for one lattice period in Fig. 2 for solenoid, FODO (α = 1/2)
quadrupole, and syncopated (α
= 1/2) quadrupole focusing lattices. Scaled x-plane lattice focusing functions κx are
shown superimposed. Excursions of the matched envelope functions are in-phase for solenoidal focusing (rx = ry)

6
because the applied focusing is plane symmetric (κx = κy). In contrast, for quadrupole focusing, the anti-symmetric
plane focusing (κx =
κy) results in out of phase envelope ﬂutter in each plane (focus-defocus) leading to net
focusing over the lattice period in both planes. Expected symmetries of the matched solutions are present for both
the solenoidal and quadrupole focusing lattices (see Appendix A). For the quadrupole solutions, note that the FODO
case exhibits a higher degree of sub-period symmetry than the syncopated case. Leading order terms of an analytical
perturbation theory for the matched beam envelope solution[7] can be applied in the limit σ
0 to show that the
envelope excursions (ﬂutter) scales as

→

−

Max[rx]
rx

1

−

≃ (

(1−cos σ0)(1−η)(1−η/2)
6
1/2
23/2(1−2η/3)1/2

(1−cos σ0)

(1−η/2)

Solenoidal Focusing.

FODO Quadrupole Focusing.

Equation (40) shows that for solenoidal focusing the matched envelope ﬂutter increases with decreasing lattice occu-
pancy η and increasing focusing strength σ0. In contrast, for FODO quadrupole focusing the ﬂutter depends weakly
on η (the variation of Max[rx]/rx −
1 in η has a maximum range of 0.07) and more strongly on σ0 (variation of 0.5).
Envelope ﬂutter changes only weakly when space-charge strength is reduced (i.e., σ/σ0 increased).

11

(40)

a)

)

m
m

(

y
r
,
x
r

8.0

7.5

7.0

6.5

6.0

)

m
m

(

y
r
,
x
r

)

m
m

(

y
r
,
x
r

8

6

4

8

6

4

rx = ry

κx

κx

κx

s/Lp

0.0

0.2

0.4

0.6

0.8

1.0

10

b)

rx

ry

0.0

0.2

0.4

0.6

0.8

1.0

10

c)

rx

ry

0.0

0.2

0.4

0.6

0.8

1.0

FIG. 2: (Color) Example matched envelope solutions for (a) solenoidal, (b) FODO (α = 1/2) quadrupole, and (c) syncopated
−4, and ε = 50
◦
(α = 0.1) quadrupole focusing lattice. Parameters for all cases are: Lp = 0.5 m, η = 0.5, σ0 = 80
mm-mrad. These parameters yield σ/σ0 = 0.3144, 0.3093, and 0.3099 for (a), (b), and (c).

, Q = 4 × 10

Although the system symmetries assumed simplify interpretation of the matched envelope solutions obtained in the

12

examples, we note that the numerical methods employed in calculation of the particle principal orbits functions and
any necessary constraint equations are not structured to take advantage of the symmetries of the matched solutions.
Because of this, the examples provide a better guide to the performance of the IM method in situations where there are
lesser degrees of system symmetry. Mathematica[16] based programs used to in the examples have been archived[17].
These programs can be easily adapted to more complicated lattices.

A. Case 1 and 2 parameterizations

The IM method described in Sec. IV is applied with σi = σ speciﬁed and the unknown parameters of the ith
iteration εi (case 1: Q and σ speciﬁed) or Qi (case 2: ε and σ speciﬁed) calculated from the constraint equations (34)
and (35). The continuous focusing approximation envelope radii rj used in the seed (i = 0) iterations are calculated
from Eq. (30) (case 1) and Eq. (28) (case 2). The number of iterations needed to achieve a 10−6 fractional envelope
tolerance [see Eq. (38)] are presented in Fig. 3 as a function of σ0 and σ/σ0 for solenoidal, FODO quadrupole, and
syncopated quadrupole focusing lattices employing both case 1 and case 2 parameterization methods.
In Fig. 4,
iterations corresponding to one data point in Fig. 3 (case 2 solenoidal focusing) are shown. This example shows a
result typical for lower to intermediate values of σ0, where the seed iteration r0
j is fairly close to the matched solution
and the ﬁrst iteration correction r1
j closely tracks the matched solution to within a percent local fractional error.
Higher values of σ0 and more complicated lattices result in both seed iterations farther from the matched solution
and less rapid convergence with iteration number.

a)

Case 2, ε = 50 mm-mrad

13

40

60

80
100
σ0 (degrees)

120

140

160

40

60

80
100
σ0 (degrees)

120

140

160

4
Case 1, Q = 10−
x
x
4
3
3
3
3
3
3
3
3
3
3
3
3
3
4
3
4
3

x
4
4
3
4
4
4
4
4
4

4
Case 1, Q = 10−
x
x
4
3
4
4
4
4
4
5
4
5
4
5
4
5
4
5
4
5

x
4
5
5
5
6
6
6
6
6

x
4
3
4
4
4
4
4
4
4

x
4
4
4
4
4
5
5
5
5

x
5
4
5
5
5
5
5
6
6

a)

1.0

0.8

0.6

0.4

0.2

0.0

b)

1.0

0.8

0.6

0.4

0.2

0.0

1.0

0.8

0.6

0.4

0.2

0.0

0
σ
/
σ

0
σ
/
σ

0
σ
/
σ

x
6
5
4
4
5
5
5
5
5

x
5
5
6
6
6
7
7
7
7

x
5
5
5
6
6
6
6
6
6

x
7
6
5
5
5
6
6
6
6

x
5
6
6
7
7
7
7
7
8

x
6
6
6
6
6
7
7
7
7

x
10
7
6
6
6
7
7
7
7

x
17
7
7
7
7
7
8
8
8

x
6
7
7
7
8
8
8
8
8

x
7
6
6
7
7
7
7
7
7

x
6
7
7
8
8
8
8
8
8

x
8
7
7
7
7
7
8
8
8

0
σ
/
σ

0
σ
/
σ

0
σ
/
σ

1.0

0.8

0.6

0.4

0.2

0.0

b)

1.0

0.8

0.6

0.4

0.2

0.0

1.0

0.8

0.6

0.4

0.2

0.0

1
3
3
3
3
3
3
3
3
3

1
3
3
3
4
4
4
4
4
4

Case 2, ε = 50 mm-mrad
1
1
1
4
3
5
4
6
5
7
4
5
7
4
5
7
4
6
7
6
4
7
6
4
7
6
4
8
6
4

1
5
5
6
6
6
7
7
7
7

1
4
4
4
5
5
5
5
5
5

1
3
3
3
3
3
3
3
4
4

1
4
4
4
4
4
5
5
5
5

1
4
4
3
4
4
4
4
4
4

1
5
4
5
5
5
5
5
5
5

1
5
5
4
4
5
5
5
5
5

1
5
5
5
5
6
6
6
6
6

1
7
6
5
5
5
6
6
6
6

1
6
6
6
6
6
6
7
7
7

1
9
6
6
6
6
6
7
7
7

1
6
7
7
7
8
8
8
8
8

1
7
6
6
7
7
7
7
7
7

1
16
7
7
7
7
7
8
8
8

1
6
7
7
8
8
8
8
8
8

1
7
7
7
7
7
8
8
8
8

40

60

80
100
σ0 (degrees)

120

c)

4
Case 1, Q = 10−

140

160

40

60

80

100
σ0 (degrees)

120

140

160

c)

Case 2, ε = 50 mm-mrad

40

60

80
100
σ0 (degrees)

120

140

160

40

60

80
100
σ0 (degrees)

120

140

160

FIG. 3: Number of IM iterations needed to achieve a tol = 10−6 fractional error tolerance matched envelope solution for (a)
solenoidal, (b) FODO (α = 1/2) quadrupole, and (c) syncopated (α = 0.1) quadrupole focusing lattices as a function of σ0 (for
◦
◦
) and σ/σ0 (for σ/σ0 = 0.1, 0.2, 0.3, · · · , 1.0). The left column corresponds to the parametrization
, · · · , 160
σ0 = 40
−4 (Unachievable limit points marked x) and the right column corresponds to the parameterization
case 1 method with Q = 10
case 2 method with ε = 50 mm-mrad. Other lattice parameters are Lp = 0.5 m and η = 0.5 for (a), (b), and (c).

◦
, 80

◦
, 60

14

)

m
m

(

x
r

8.2

8.0

7.8

7.6

7.4

7.2

rx
r1
x

r0
x

κx

s/Lp

0.0

0.2

0.4

0.6

0.8

1.0

FIG. 4:
r0
x (red), and the second iteration r1
σ/σ0 = 0.3.

(Color) For solenoidal focusing: converged matched envelope solution (black) with rx = ry, the ﬁrst seed iteration
◦
, ε = 50 mm-mrad, and
x (green). System parameters are Lp = 0.5 m, η = 0.5, σ0 = 80

The data in Fig. 3 shows that the IM method converges rapidly to small tolerances over a broad range of ap-
plied focusing (σ0) and space-charge (σ/σ0) strength. Not surprisingly, stronger focusing strength (i.e., increasing
σ0) requires more iterations for both solenoidal and quadrupole focusing at the ﬁxed value of lattice occupancy η
employed. Also, lesser degrees of lattice symmetry result in more iterations being necessary for convergence (e.g.,
lattice convergence rate order: solenoidal, FODO quadrupole, syncopated quadrupole). Iterations required appear
to depend only weakly on space-charge strength (σ/σ0) – except for solenoidal focusing lattices with very high σ0
where required iterations become abruptly larger for weak space-charge with σ/σ0 close to unity. Even parameters
deep within the regime of strong envelope instability[3] converge rapidly. Points for σ/σ0 = 1 are eliminated in the
case 1 examples because the perveance Q is held to a ﬁxed, ﬁnite value and this limit would correspond to a matched
beam envelope with inﬁnite cross-sectional area. Conversely, for the limit σ/σ0 = 1 in the case 2 examples, only one
iteration is required for convergence to a ﬁnite solution because for zero space-charge strength the trial seed iteration
generated by Eq. (32) for i = 0 corresponds to the exact matched envelope to numerical error (i.e., when Q0 = 0
the C0
j are the principal undepressed particle orbits which generate the matched envelope of the undepressed
0
beam). The IM method applies for extremely strong space charge with σ/σ0 ≪
requires careful analysis of various terms in the formulation presented in Sec. IV.

0.1, but probing the limit σ

j and S0

→

Complementary to Fig. 3, the decrease in the log of the fractional tolerance [see Eq. (38)] achieved with iteration
number is plotted in Fig. 5 for solenoidal and FODO quadrupole focusing lattices for one set of system parameters.
The matched envelopes are calculated using the case 2 methods. Case 1 methods and other system parameters
yield similar results to those presented. We ﬁnd that the IM method converges rapidly, with the fractional tolerance
achieved increasing by one to two orders of magnitude per iteration till saturating at a value reﬂecting the precision
of numerical calculations employed (

10−15 fractional accuracy for the examples in Fig. 5).

∼

a)

b)

5

10
Iteration Number

15

20

0

−

5

)
l
o
t
(
0
1
g
o
l

−

10

−

15

−

20

0

0

−

5

)
l
o
t
(
0
1
g
o
l

−

10

−

15

−

20

0

5

10
Iteration Number

15

20

FIG. 5: Log of fractional error tolerance (tol) achieved for matched envelope solutions versus number of IM iterations for (a)
solenoidal and (b) FODO (α = 1/2) quadrupole focusing lattices. Solutions are generated using case 2 methods for system
−4 and
◦
parameters: Lp = 0.5 m, η = 0.5, σ0 = 80
Q ≃ 6.561 × 10−4 for (a) and (b)].

, ε = 50 mm-mrad, and σ/σ0 = 0.2 [corresponding to Q ≃ 6.700 × 10

B. Case 0 parameterization

In parameterization case 0, the matched envelope functions rj are speciﬁed by κj, Q, and εj. For the ith iteration,
the depressed phase advances σi
j needed to calculate the iteration envelope functions ri
j are most simply calculated
using Eq. (33). Unfortunately, this simple method can fail if space-charge is strong and iterations result in envelope
corrections where the radial cross-section of the beam is compressed suﬃciently relative to the actual matched envelope
solution over the lattice period. Compressive over-corrections can produce iteration principal orbits that are depressed
below zero phase advance (i.e., σi
j becomes complex and we ﬁnd that Eq. (32) can fail to
generate an iteration closer to the desired matched envelope solution.

j = 0). In this situation, σi

To better understand where the problem described above can occur, a simple continuous focusing estimate (see
Sec. III B) is applied. Taking κj = (σ0/Lp)2 and εj = ε, we estimate the envelope compression factor f needed to
fully depress particle orbits within the matched envelope. A particle moving within the continuous matched envelope
rj = rb has depressed phase advance (σ/Lp)2 = (σ0/Lp)2
0 in this phase
advance formula gives

2. Replacing rb →

f rb and σ

Q/rb

→

−

But for continuous focusing, we have[3]

f =

√2

.

1 +

1 + 4[σ0ε/(QLp)]2

q

p

σ0ε
QLp

=

(σ/σ0)
(σ/σ0)2 .

1

−

Together, Eqs. (41) and (42) show that f = 0.99, 0.95, and 0.90 (corresponding to
1%, 5% and 10% compressive
over-corrections) will produce fully depressed particle orbits for σ/σ0 < 0.14, 0.31, and 0.44. Numerically analyzed

∼

15

(41)

(42)

16

examples below indicate that this problem can occur in periodic focusing lattices for more moderate space-charge and
compression factors than the continuous focusing estimates suggest.

The parameter region where the IM method can be applied using the “conventional” case 0 procedure for example
periodic solenoid and FODO quadrupole lattices is illustrated in Fig. 6. The region of applicability corresponds to
parameters where Eq. (33) can be employed to calculate the iteration depressed phases advances σi
j without obtaining
complex values.
Iterations necessary to achieve tolerance are plotted as a function of σ0 and σ/σ0. Rather than
plotting results in terms of the perveance Q, Eq. (14) was used to calculate σ/σ0 from the matched envelope functions
and system parameters to better quantify the relative space-charge strength where the method fails. Values of Q were
chosen to uniformly distribute points in σ/σ0. Note that the IM method works with the simple initial seed iteration
1) but abruptly fails with increasing space charge (σ/σ0 < 0.6).
when space-charge is moderate to weak (0.6 < σ/σ0 ≤
Near the point of failure, convergence becomes slow (iteration counts for the example in Fig. 6 can become thousands
if points are chosen suﬃciently close to the start of the failure region).

a)
1.0

0.8

0.6

0.4

0.2

0.0

b)
1.0

0.8

0.6

0.4

0.2

0.0

0
σ
/
σ

0
σ
/
σ

1
3
5
10
53
x
x
x
x
x

40

1
5
9
17
90
x
x
x
x
x

40

1
4
6
12
67
x
x
x
x
x

60

1
6
9
18
89
x
x
x
x
x

60

80

120
100
σ0 (degrees)

140

160

1
4
7
14
77
x
x
x
x
x

1
6
9
18
76
x
x
x
x
x

1
5
8
15
82
x
x
x
x
x

1
6
9
17
57
x
x
x
x
x

1
5
9
16
81
x
x
x
x
x

1
5
8
14
38
x
x
x
x
x

1
6
9
16
68
x
x
x
x
x

1
6
7
11
22
x
x
x
x
x

1
9
10
15
44
x
x
x
x
x

1
10
8
9
15
63
x
x
x
x

80

120
100
σ0 (degrees)

140

160

FIG. 6: Number of “conventional” IM iterations needed in case 0 to achieve a tol = 10−6 fractional error tolerance matched
◦
◦
envelope solution for (a) solenoidal and (b) FODO (α = 1/2) quadrupole lattices as a function of σ0 (for σ0 = 40
,
, 80
◦
· · · , 160
) and σ/σ0 (for σ/σ0 = 0.1, 0.2, 0.3, · · · , 1.0). System parameters are: Lp = 0.5 m, η = 0.5, and ε = 50 mm-mrad.
Parameters where the method fails are marked x.

◦
, 60

Several alternative methods were attempted to render the IM method applicable to all case 0 parameters with
arbitrary space-charge strength. We describe these methods without assuming σ0x = σ0y and εx = εy to better reﬂect
general case 0 applications. First, rather than employing Eq. (33) to calculate the depressed phase advance σi
j of the
1 iteration with
iteration, the integral formula (14) is applied with the envelope functions of the previous i

σi
j = εj

si

Z

si+Lp

ds
[ri−1
j

.

(s)]2

−

(43)

The anticipation is that σi
j calculated from Eq. (43) should be suﬃciently close to the actual depressed phase advance
σj of the converged solution to correct the problem. Unfortunately, this method, when applied to example solenoid
and quadrupole lattices, results in systematic convergence to unphysical solutions. Replacing Eq. (43) with an “under-
relaxed” average over previous iterations might address this problem but was not analyzed. In cases where complex

17

phase advances resulted, various other simple replacements of Eq. (33) were attempted without obtaining satisfactory
results.

Several alternative procedures extend applicability to general case 0 parameters. First, slowly increasing the per-
veance Q from some suﬃciently small (or zero) value while implementing the conventional case 0 iteration method
using Eq. (33) proves workable in our tests. In this scheme, if Eq. (33) fails (i.e., produces unphysical complex values
for σi
j) then Q is adaptively decreased while iterating until the formula becomes valid before increasing Q again
toward the target value. For strong space-charge this procedure can result in many iterations being necessary for
convergence because small increases in Q were required in various test cases examined. It is also diﬃcult to determine
optimal increments to increase the perveance – which complicates practical code development and can limit the range
of method applicability.

Another, simpler to implement, alternative procedure is formulated by combining the Sec. V A method for solving
case 1 parameterizations with numerical root ﬁnding. In this “hybrid” procedure, the emittances εj calculated from
the x- and y-plane constraint equations (23) are regarded as an undetermined function of the σj [i.e., εj|speciﬁed =
εj(σx, σy)] and trial matched envelope solutions rj are rapidly calculated to tolerance using matched envelopes obtained
with case 1 methods for speciﬁed (guessed) values of the σj. Numerical root ﬁnding can be employed to reﬁne the
guessed values for the σj to obtain the values of σj consistent with the target values of εj. Because the εj(σx, σy) are
smooth, monotonic functions of the σj for 0 < σj < σ0j , the consistent values of the σj can be found with relatively
small numbers of root ﬁnding iterations. This is particularly true for plane-symmetric systems (σ0j = σ0 and εj = ε)
because one-dimensional root ﬁnding can be employed.

The total number of two-dimensional (i.e, the calculations do not assume plane symmetry) iterations needed to
implement this hybrid method for case 0 is shown in Fig. 7 for example periodic solenoid and FODO quadrupole
lattices. Here, the total iteration number represents the sum of all iterations needed to calculate the emittances to
a speciﬁed fractional tolerance while calculating all trial matched envelope solutions to a separate speciﬁed tolerance
over all two-dimensional root ﬁnding steps. The same lattices and presentation methods used in Fig. 6 are employed
to aid comparisons. Note that the full case 0 parameter space is accessible in this procedure with only relatively
modest total iteration counts in spite of the additional numerical work resulting from the root ﬁnding. A secant-like
multi-dimensional root ﬁnding method is employed[16]. Note that only two-dimensional root ﬁnding is necessary in
contrast to four-dimensional root ﬁnding associated with conventional procedures for constructing matched envelope
solutions by ﬁnding appropriate initial envelope coordinates and angles. Initial root ﬁnding iterations are seeded using
continuous focusing model estimates for σj calculated from Eq. (28) using the seed values of rj. Subsequent root
ﬁnding steps in σj employ the previous step matched envelopes as a seed envelope in the case 1 iterations. For small
root ﬁnding steps in σj this previous step seeding saves considerable numerical work. Only one iteration is necessary
for the limit points with σ/σ0 = 1 because for zero space-charge strength the trial seed iteration is exact to numerical
error. Iteration counts at ﬁxed σ0 likely increase and decrease in σ/σ0 due to approximate iteration seed guesses being
(accidentally) farther and closer to the actual root than in other cases. If the plane symmetries are employed (i.e.,
using εx = εy and σx = σy), then total iterations required can be further reduced. Matched envelopes for general case
0 parameters can also be calculated in similar number of total iterations by analogously combining case 2 methods
with numerical root ﬁnding. In this case values of σj consistent with speciﬁed values of Q are calculated using the
two components of Eq. (23) [i.e., set Q
Qj in the j = x and y components of Eq. (23) and then root solve for σj
consistent with Q = Qj(σx, σy)].

→

18

a)
1.0

0.8

0.6

0.4

0.2

0.0

b)
1.0

0.8

0.6

0.4

0.2

0.0

0
σ
/
σ

0
σ
/
σ

1
9
9
9
9
9
9
9
7
7

40

1
9
10
10
10
10
10
10
10
10

40

1
21
9
9
9
9
9
9
10
10

60

1
16
23
15
15
17
15
13
11
11

60

80

120
100
σ0 (degrees)

140

160

1
14
10
9
10
10
10
10
10
10

1
16
17
15
15
16
16
14
16
12

1
14
15
12
14
15
11
11
11
11

1
19
18
18
18
16
16
17
17
17

1
24
16
32
15
15
16
16
16
12

1
18
19
20
21
19
19
19
17
16

1
30
37
18
16
16
20
19
17
13

1
22
20
21
23
38
22
20
20
18

1
56
23
21
19
21
19
32
20
18

1
22
23
23
23
24
22
22
22
18

80

120
100
σ0 (degrees)

140

160

FIG. 7: Number of total “hybrid” IM iterations needed for case 0 using tol = 10
envelope solutions and root found εj with 10
(α = 1/2) quadrupole lattices. The same system parameters and presentation format is employed as is used in Fig. 6.

−6 fractional error tolerance case 1 matched
−4 fractional accuracy from speciﬁed values for (a) solenoidal and (b) FODO

VI. CONCLUSIONS

An iterative matching (IM) method for numerical calculation of the matched beam envelope solutions to the KV
equations has been developed. The method is based on orbit consistency conditions between depressed particle
orbits within a KV beam distribution and the envelope of orbits making up the distribution. Application of the
IM method in simplest form requires numerical solution of linear ordinary diﬀerential equations describing principal
particle orbits over one lattice period and the calculation of a few axillary integrals over the lattice period. A large
basin of convergence enables seeding of the iterations with a simple trial solution that takes into account both the
envelope ﬂutter driven by the applied focusing lattice and leading-order space-charge defocusing forces. All cases of
envelope parameterizations can be employed, but the method is most naturally expressed, and highly convergent, when
employing the depressed particle phase advances σj as parameters — which also corresponds to a natural choice of
parameters to employ for enhanced physics understanding. Virtues of the IM method are: it is straightforward to code
and applicable to periodic focusing lattices of arbitrary complexity; it is eﬃcient for arbitrary space-charge intensity;
and it works for all physically achievable system parameters – even in bands of parametric envelope instability where
conventional matching procedures can fail.

ACKNOWLEDGMENTS

The authors wish to thank J.J. Barnard and A. Friedman for useful discussions. This research was performed
under the auspices of the U.S. Department of Energy at the Lawrence Livermore and Lawrence Berkeley National
Laboratories under Contracts No. W-7405-Eng-48 and No. DE-AC03-76SF0098.

19

(A1)

(A2)

(A3)

(A4)

(A5)

APPENDIX A: MATCHED ENVELOPE SYMMETRIES FOR QUADRUPOLE DOUBLET AND
SOLENOIDAL FOCUSING

Consider a periodic quadrupole doublet lattice[3] focusing a beam with symmetric emittances (i.e., εx = εy). To

concretely deﬁne doublet focusing, we assume that the lattice focusing functions κj(s) satisfy

κj(s) =

κj(

s),

−
−
in addition to the general quadrupole lattice symmetry κx =
κy. This doublet focusing symmetry is consistent with
focusing/defocusing elements with axial structure (i.e., including fringe ﬁelds) if both the focusing and defocusing
elements are realized by identical hardware assemblies with equal ﬁeld excitations appropriately arranged in a regular
lattice via symmetry operations (i.e., translations and rotations). Without loss of generality, let s = 0 correspond
to the axial location of the drift between two successive quadrupoles in the periodic lattice (for cases where a ﬁnite
fringe ﬁeld extends into the drifts, this location will be where κj = 0). Assume that the matched envelope functions
satisfying the KV equations (1) are symmetric about the mid-drift with

−

rj(s) = r˜j(

s).

−

Here, if j = x, y, then ˜j = y, x. Take the j = x KV equation [see Eq. (1)], substitute s
s. Then employing
the focusing and envelope symmetries in Eqs. (A1) and (A2) together with κy =
κx obtains the complementary
j = y KV equation, thereby showing that the assumed symmetry in Eq. (A2) is consistent. An immediate corollary of
Eq. (A2) is that at any mid-drift between quadrupoles, the envelope is round (i.e., rx = ry) with opposite convergence
angles (i.e., r′

→ −

−

Restrict the situation described above to a symmetric FODO system where the two focusing and defocusing
quadrupoles are separated by equal length axial drifts[3] and the focusing and defocusing elements are each re-
ﬂection symmetric about their axial midplane [i.e., within one element, κx(s
s + ˜s) where s = ˜s is the
geometric ﬁeld center of the element]. These further assumptions lead to the additional FODO focusing symmetry

˜s) = κx(

−

−

x =

r′
y).

−

κj(s) = κ˜j(Lp/2 + s).

rj(s) = r˜j (Lp/2 + s).

′
j (s) =
r

′
j(Lp/2
r

−

s).

−

With the choice of s = 0 made as above, the focusing and defocusing optical elements are centered at s = Lp/4 and
s = 3Lp/4 within the period s
[0, Lp]. Using steps analogous to those outlined above, it can be shown that the
matched envelope functions also have the FODO symmetry:

∈

Another FODO symmetry can be obtained by replacing s
to yield

→ −

s in Eq. (A4), applying Eq. (A2), and diﬀerentiating

j (s + Lp) = r′

Evaluating this expression at the focusing element centers at s = Lp/4 and s = 3Lp/4 and invoking periodicity of the
j(s) shows that the matched envelope functions are extremized (i.e., r′
rj with r′
j = 0) at the focusing
element centers in a symmetric FODO lattice. The envelope equations (1) then shows that the j-plane extrema of
rj with κj < 0 (defocusing plane) satisﬁes r′′
j > 0 and therefore must be a minimum value. Period symmetries then
require that the other focusing plane extrema (˜j-plane with κ˜j > 0) corresponds to a maximum value.

Analogous steps to those employed in the analysis of quadrupole doublet focusing can be applied to solenoidal
focusing (κx = κy) systems with εx = εy to show that rx = ry. Consider a periodic solenoidal focusing function
with only a single element in the period that is also reﬂection symmetric about the axial midplane (with reﬂection
symmetry deﬁned as for the FODO quadrupole case above). Then procedures used above are readily employed to
show that the matched envelope function rj is maximum at the axial center of the focusing element and is minimum
at the axial center of the drift.

[1] I. Kapchinskij and V. Vladimirskij, in Proceedings of the International Conference on High Energy Accelerators and In-

strumentation (CERN Scientiﬁc Information Service, Geneva, 1959), p. 274.

[2] M. Reiser, Theory and Design of Charged Particle Beams (John Wiley & Sons, Inc., New York, 1994).
[3] S. M. Lund and B. Bukh, Phys. Rev. Special Topics - Accelerators and Beams 7, 024801 (2004).

20

[4] R. Ryne, Tech. Rep. acc-phys/9502001, http://arxiv.org, Accelerator Physics (1995).
[5] H. Wiedemann, Particle Accelerator Physics: Basic Principles and Linear Beam Dynamics (Springer-Verlag, New York,

1993).

[6] E. P. Lee, Particle Accelerators 52, 115 (1996).
[7] E. P. Lee, Physics of Plasmas 9, 4301 (2002).
[8] O. Anderson, in Proceedings of the 2005 Particle Accelerator Conference, Knoxville, TN (IEEE #01CH37268C, Piscataway,

NJ 08855, 2005), p. TPAT061.

[9] O. A. Anderson (2005), submitted for publication.
[10] R. C. Davidson, Physics of Nonneutral Plasmas (Addison-Wesley, Reading, MA, 1990), re-released, World Scientiﬁc, 2001.
[11] I. Hofmann, L. J. Laslett, L. Smith, and I. Haber, Particle Accelerators 13, 145 (1983).
[12] E. D. Courant and H. S. Snyder, Annals of Physics 3, 1 (1958).
[13] E. Lee and R. J. Briggs, Tech. Rep. LBNL-40774, UC-419, Lawrence Berkeley National Laboratory (1997).
[14] R. C. Davidson and Q. Qian, Phys. Plasmas 1, 3104 (1994).
[15] R. C. Davidson and H. Qin, Physics of Intense Charged Particle Beams in High Energy Accelerators (World Scientiﬁc,

New York, 2001).

[16] S. Wolfram, The Mathematica Book, 5th ed. (Wolfram Media, 2003).
[17] Mathematica programs employed can be obtained on the arXiv.org e-Print archive (http://arxiv.org).

