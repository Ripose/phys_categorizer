range of X-ray detectors

6 The dual-gain mode: a way to enhance the dynamic
0
0
2
 
l
u
J
 
4
 
 
]
h
p
-
d
e
m

Varian Medical Systems Imaging Laboratory GmbH, T¨afernstrasse 7, CH-5405
Baden-D¨attwil, Switzerland

E-mail: evangelos.matsinos@varian.com and wolfgang.kaissl@varian.com

Evangelos Matsinos and Wolfgang Kaissl

Abstract. Varian Medical Systems has manufactured and recently put into operation
a clinically-applicable solution for image-guided radiation therapy. Cone-beam CT
imaging, one of the operation modes of the imaging unit of this device, aims at high-
quality volumetric reconstruction. To boost the image quality, the dual-gain mode,
a successful means for enhancing the dynamic range of the ﬂat-panel detectors and
obtaining better results in the contrast of the reconstructed image, was developed and
successfully tested during the last few years. The important steps in the calibration of
this mode involve a correction to the pulse widths associated with the X-ray production,
the assessment of the detector signal above which nonlinear eﬀects become signiﬁcant
and the determination of some properties of the detector pixels, namely, of dark ﬁelds,
ﬂatness corrections, etc. Finally, the defect-pixel map is obtained, containing dead
and ﬂickering pixels, as well as pixels with properties which are suﬃciently ‘out of
range’. An eﬀect observed in the oﬀset correction of raw images seems to originate
in the mismatch between the measured and extrapolated values of the dark ﬁeld; a
correction scheme is proposed to take account of this eﬀect. In the data processing,
which is achieved on the basis of the ﬁles produced in the calibration of the mode, the
high-gain signal is used whenever meaningful; otherwise, it is substituted by the low-
gain signal, properly scaled. Defect pixels are interpolated from their good neighbours;
a procedure achieving a correction in case of small defect-pixel clusters is outlined.

PACS numbers: 87.57.Ce, 85.57.Nk, 87.59.Fm

Keywords: cone-beam CT, ﬂat-panel detector, dual gain, image quality

1. Introduction

The detailed knowledge concerning the position of the tumour and of the vital organs
during the treatment has long been one of the most crucial and demanding problems in
radiation therapy. Disregarding patient-localisation uncertainties, one may identify two
time scales in relation to organ motion: one pertaining to daily variations (interfraction
motion), the other to the respiration cycle (intrafraction motion). These two scales
aﬀect diﬀerently the various regions within the human anatomy.

.
s
c
i
s
y
h
p
[
 
 
1
v
1
2
0
7
0
6
0
/
s
c
i
s
y
h
p
:
v
i
X
r
a

The dual-gain mode in CT imaging

2

To overcome the absence of a monitoring process, which would be practical enough
for everyday application, the oncologists add a margin around the target in order to
maximise the probability of destroying the entire tumour by the end of the treatment.
The inevitable consequence of increasing the volume of the region which receives the
largest radiation impact is the destruction of healthy tissue.

Aiming at increasing the precision in radiation therapy, Varian Medical Systems,
Inc. (VMS), Palo Alto, CA, has recently deployed a number of new products. In autumn
2004, the VMS Clinac accelerator, equipped with imaging functionality ‡, the ‘On-Board
Imager’ (OBI), came into operation (ﬁgure 1). As this device is capable of both tracking
and targeting tumours, it represents a clinically-applicable solution for image-guided
radiation therapy.

The two main components of the OBI system are the low-energy (kV) X-ray tube
(simply called ‘tube’ hereupon) and the ﬂat-panel detector (FPD); both are attached
to the body of the device via a system of robotic arms enabling 2D (for the tube) or 3D
(for the detector) movement. The detector which is currently in use may be operated
in ﬂuoroscopic (real-time moving images, to be used for position and veriﬁcation) or
radiographic mode (high-resolution images, to be used for diagnosis and planning).

The availability of reliable large-area FPDs at the commercial level has been a
crucial factor in the development of the high-resolution volumetric reconstruction. The
transition from traditional computed tomography (CT) to modern imaging modalities is
well under way. In circular cone-beam CT (CBCT) imaging, the algorithm of Feldkamp
et al (1984) is a good starting point for further investigation; variants of this algorithm
have appeared in the literature, e.g., see Grass et al (2000) and Tang et al (2005).
The problem of the reconstruction in case of a helical source-detector trajectory has
been studied for a number of years, e.g., see Fuchs et al (2000) and the corresponding
references in Grass et al (2000). New techniques, aiming at improving the image quality
by suppressing the noise, have surfaced with the papers of Pan (1999), Kachelrieß et al
(2001), and Pan and Yu (2003). Finally, renewed interest in ‘1800 plus’ reconstructions
was triggered with the works of Yu and Pan (2003), and Zou et al (2005).

To yield reliable information, the imaging unit must be properly calibrated; the
calibrations may be classiﬁed as general and mode-speciﬁc. The general calibrations
include the geometric calibration (yielding the values of important spatial parameters,
e.g., of the source-axis and source-detector distances, as well as the corrections due to
the mechanical imperfection), the I0 calibration (yielding the open-geometry signal -
the so-called ‘air counts’ - as a function of the position on the detector), the norm-
phantom calibration (yielding images of a norm phantom, that is, of a cylindrical object
of known density, which may subsequently be used as reference in the reconstruction
of other objects), the calibration for the beam-hardening correction §, etc. The mode-

‡ The idea of integrating the imaging and delivery units had been proposed almost one decade ago
as a means to facilitate the deposit of higher dose in the target and ensure better protection of the
surrounding tissue; for an overview, see Jaﬀray et al (2002).
§ Due to the energy dependence of the photon absorption length, the low-energy components of a

The dual-gain mode in CT imaging

3

speciﬁc calibrations relate to the diﬀerent operation modes of the detector. An overview
of the calibrations of the imaging unit, including some details, may be obtained from
Matsinos (2005).

The present paper deals with the description of the most promising operation mode
of the VMS FDPs, namely, the dual-gain mode. This mode has been developed in the
recent years as a result of the need for enhancing the dynamic range of the detectors in
order to improve image quality; the broader the dynamic range of an imaging device,
the higher is the contrast capability in the reconstructed image. The method described
here is general and may be used in systems where a dual signal, relating to the same
object, is produced, either via successive exposures or by sophisticated readout.

2. Materials and methods

2.1. Hardware components in the imaging device

it is a rotating-anode X-ray tube with
The X-ray source is the VMS model G242;
maximal operation voltage of 150 kV. The anode is a disc (∅ 102 mm) with a rhenium-
tungsten face on molybdenum substrate with graphite backing. The tube is driven and
controlled by the X-ray generator.

The VMS PaxScan 4030CB amorphous-silicon FPD is a real-time digital X-
ray imaging device comprising 2048 × 1536 square elements (pixels) and spanning
an approximate area of 40 × 30 cm2.
In order to expedite the data transfer and
processing, the so-called half-resolution (2 × 2-binning) mode is used in most of the
VMS applications; thus, the detector is assumed to consist of 1024 × 768 (logical) pixels
(pitch: 388 µm). Due to the high sensitivity of the scintillating material (thallium-
doped cesium iodide) and to the sophisticated noise-reduction techniques implemented,
the low-dose imaging performance of this type of detector is remarkable, save for a small
band neighbouring its borders k. The application of this FPD in CBCT imaging has
been outlined in Roos et al (2004).

2.2. The dual-gain mode

The VMS FPDs may be operated in a number of modes; a mode is identiﬁed as a set
of options pertaining to binning, gain choice, etc. In the dual-gain mode, the charge
stored in the semiconductor is read out by using two diﬀerent capacitors (0.5 and 4 pF),
leading to the so-called high- and low-gain signals, see Roos et al (2004). In this mode,
each scan (approximately 650 images) produces about 2 GB of data which has to be
transferred (from the acquisition system) to the workstation for additional processing

polychromatic X-ray beam, when passing through matter, experience higher attenuation than the
high-energy ones. This eﬀect creates beams which are progressively richer (harder) in high-energy
components.
k Due to ﬂuctuations in the sensitivity of the scintillator, the data within 2.91 mm of the detector
borders (the so-called ‘inactive area of the detector’) are not taken into account.

The dual-gain mode in CT imaging

4

(correction, storage and reconstruction). The mode has been subjected to extensive and
successful experimentation during the recent years and, at present, it represents the best
option for high-quality radiography.

The dual-gain mode is an important option because it increases the dynamic range
of the detector. Aﬀecting the contrast and the signal-to-noise ratio, the dynamic range
in an image is a key factor for high-quality CT images. The storage capacity of the each
individual detector pixel does not impose limits to the delivered dose; the saturation
level in the readout circuits deﬁnes (depending on the gain chosen) these limits. The
optimal acquisition settings for a given exposure are those for which the maximal low-
gain signal detected is close to the saturation level of the photodiode capacity. In the
low-gain mode, the digital increment is coarse and restricts the contrast resolution in
the high-attenuation areas of the irradiated object. To improve the contrast in these
areas, a higher gain must be used; this is exactly where the dual-gain mode comes in.
In this mode, each row of detector pixels is read out twice: ﬁrst in low, then in high
gain. One image is ﬁnally created, in which the two signals are interlaced.

2.3. The calibration of the dual-gain mode

The purpose of the calibration is to produce a set of ﬁles needed in the data processing.
Before delving into the description of these ﬁles, we will give one deﬁnition. Henceforth,
‘map’ implies an array of values (matrix) pertaining to the logical pixels of the detector;
for instance, in the 2 × 2-binning mode, a map comprises 1024 × 768 elements.

The description of the calibration is facilitated if one commences with two notions

which are common in imaging: the dark current and the ﬂatness correction.

2.3.1. The dark current. The dark current is also referred to as dark ﬁeld. It is due
to a number of physical processes which occur inside the detector irrespective of the
external radiation; these processes involve eﬀects relating to the de-trapping current,
thermal noise, on-chip electronic noise, etc. A useful overview of these eﬀects may be
obtained from Young et al (1998). As a result, the detector signal is not vanishing in
the absence of external radiation. The dark-ﬁeld correction is often referred to as oﬀset
correction of raw data.

To subtract the appropriate dark ﬁeld from the data, one has to reassess its
contribution frequently during the daily operation of the imaging unit; the dark ﬁeld is
sensitive to temperature variation and exposure history. To ensure that the appropriate
dark-ﬁeld values be used in the correction of the data, VMS has implemented an
automatic procedure leading to the recalibration of the dark ﬁeld if the imaging device
is inactive for some (user-deﬁned) time; additionally, the recalibration of the dark ﬁeld
is forced in case of mode switching, prior to any other calibration and shortly before
acquiring scan data. To suppress noise in the determination of the dark ﬁeld, a number
of images (for example, 100 maps) are averaged.

One important question one might pose is whether the dark ﬁeld determined in the

The dual-gain mode in CT imaging

5

absence of radiation provides the appropriate oﬀset correction in the case of exposures;
this is not a trivial subject. One unique feature of the present work is that corrections
to the measured dark ﬁelds (obtained in the absence of radiation) will be derived prior
to applying the oﬀset correction to the raw data.

2.3.2. The ﬂatness correction. Even when the appropriate dark ﬁeld is deducted from
the raw data, the resulting map is not expected to be ﬂat. Assuming the absence of
statistical ﬂuctuation, there are two reasons for this deviation: the anisotropy in the
radiation ﬁeld and the variability in the response of the detector pixels to the incident
radiation. We will now estimate the corrections which lead to a ﬂat image at each
intensity level in open-ﬁeld geometry. The intensity I may be thought of as the product
of two acquisition settings, namely, of the tube current and pulse width.

The intensity-signal linearity implies that the raw signal sij, extracted from the pixel
ij (i denotes the lateral position of the pixel on the detector and j the longitudinal), is
given by the formula

where aij and dij are position-dependent quantities; the latter represents the dark ﬁeld.
Under this assumption, the oﬀset-corrected signal in each pixel is deﬁned as

sij = aijI + dij ,

sij = sij − dij = aijI .

We previously gave reasons why the oﬀset-corrected signal is not expected to be
constant over the detector. To achieve the signal uniformity, one has to multiply the
oﬀset-corrected contents in each pixel by a ﬂatness-correction factor which may be
deﬁned as

where the average of the sij signals over the entire area of the detector appears in
the numerator on the right-hand side. Taking (2) and (3) into account, the ﬂatness
correction may be written as

Fij =

< s >
sij

,

Fij =

< a >
aij

.

(1)

(2)

(3)

(4)

Therefore, the factors Fij may be calculated from the slope parameters aij. If each Fij
multiplies the corresponding oﬀset-corrected signal of (2), a constant value is obtained
over the entire detector. The ﬂatness correction is also referred to as ﬂood-ﬁeld or
ﬂat-ﬁeld correction.

Assuming that the input signals do not saturate anywhere on the detector (i.e., that
the intensity-signal linearity holds), equation (4) explains why the ﬂatness corrections
extracted at one intensity lead to ﬂat images at all intensity levels. To suppress noise
in the determination of the ﬂatness-correction maps, a number of images (for example,
100 maps) are averaged.

6

(5)

(6)

(7)

(8)

(9)

(10)

(11)

The dual-gain mode in CT imaging

2.3.3. Application to the dual-gain mode. As two signals in each pixel are obtained
in the dual-gain mode, two dark-ﬁeld and two ﬂatness-correction maps have to be
and dLG
introduced. The two dark-ﬁeld values for the pixel ij will be denoted as dHG
ij ,
where the superscripts have obvious meaning. Similarly, the two ﬂatness corrections
will be given by the formulae

ij

The fully-corrected high-gain signal may be obtained by the formula

and

and

Similarly,

F HG

ij =

< aHG >
aHG
ij

F LG

ij =

< aLG >
aLG
ij

.

ij = sHG
cHG

ij F HG
ij

.

cLG
ij = sLG

ij F LG
ij

.

ij =< aHG > I
cHG

ij =< aLG > I .
cLG

Combining (2), (5) and (7), we conclude that

As expected, ﬂat images have been obtained in both gains. From (9) and (10), it is
deduced that the ratio of the fully-corrected signals is constant over the whole detector.

R =

cHG
ij
cLG
ij

=

< aHG >
< aLG >

.

In the data processing, the signal cHG

from (7) will be used if the raw high-gain
ij does not exceed a threshold value; otherwise, the low-gain signal cLG
signal sHG
ij , scaled
up by the ratio R of (11), will be used. The fully-corrected (scaled) low-gain signal may
be expressed as

ij

ij = cLG
˜cLG

ij R =< aLG > I

< aHG >
< aLG >

= aLG
ij I

aHG
ij
aLG
ij

< aHG >
aHG
ij

= sLG

ij rijF HG

ij

, (12)

where rij denotes the (position-dependent) high-to-low-gain slope ratio. This formula
suggests that the ﬁnal signal, corresponding to the use of the low-gain component in the
data processing, may be put in the form of a product of the oﬀset-corrected low-gain
signal, high-to-low-gain slope ratio and high-gain ﬂatness correction.

The dual-gain mode in CT imaging

2.4. The calibration ﬁles

7

At the end of the calibration, the following maps are produced.

• The high-gain dark-ﬁeld map; it is used in the oﬀset correction of the raw high-gain

data.

data.

• The low-gain dark-ﬁeld map; it is used in the oﬀset correction of the raw low-gain

• The high-gain ﬂatness-correction map; according to (7), it is used in the correction
of the oﬀset-corrected high-gain data and, according to (12), it is also involved in
the correction of the low-gain data.

• The low-gain ﬂatness-correction map;

it is used in the correction of the oﬀset-
corrected low-gain data. As previously explained, the low-gain ﬂatness-correction
map is simply the product of the high-to-low-gain slope-ratio and high-gain ﬂatness-
correction maps.

• The threshold map; it contains the maximal reliable raw signal. The method to

derive the threshold map will be given in detail later on.

An important point in the present work is that two additional maps will be
introduced to correct for small eﬀects in the two dark ﬁelds. All in all, eight maps
are needed to process the data; the eighth calibration ﬁle is the map of defect pixels
(defect-pixel map). When initialising the dual-gain-calibration workspace, the user has
the option of selecting an already existing defect-pixel map and append to it new defect
pixels; otherwise, a new map is created.

2.5. The method

2.5.1. The input data. The input data comprises a number of dark-ﬁeld images and
a number of raw images; the latter are acquired at diﬀerent intensity levels by varying
the width of the pulse produced by the generator. There are two reasons why series
of images are obtained. On one hand, this is done to suppress noise; on the other, the
range of the signal values obtained in each pixel provides an estimate of the (signal)
uncertainty which is to be used in the optimisation phase.

At this point, we are touching upon an important issue, namely, the numbers of
images to be skipped and acquired at each intensity value. This discussion surfaces
because the detector signals do not only depend on the incident radiation within the
time window corresponding to the particular exposure, but also on the (short- and
long-term) exposure history of the detector. The signal which is not directly associated
with the dose delivered by the current pulse will be assumed to be a product of ‘lag
eﬀects’. Information on this eﬀect may be found in Hsieh et al (2000) and Overdick et
al (2001). The deep-seated traps in the semiconductor seem to be responsible for this
bizarre behaviour, inducing two types of eﬀects: those which aﬀect the dark ﬁeld and
those which lead to the modiﬁcation of the gain of each pixel.

The dual-gain mode in CT imaging

8

Lag eﬀects in the calibration have to be avoided for two reasons. First, they lead to
erroneous calibration ﬁles, as the averages obtained do not match the characteristics of
the asymptotic behaviour. Second, they artiﬁcially increase the uncertainties, which are
subsequently to be used in the optimisation scheme, thus aﬀecting the determination
of the ﬁt parameters in each pixel and complicating the statistical interpretation of the
results of the linearity tests.

The data analysed in the present paper were acquired at the VMS laboratory in
Baden, Switzerland, on December 15, 2005. A total of 200 dark-ﬁeld images were
obtained. A total of 200 exposures at each of 15 pulse-width values ¶ (4, 5, 6, 7, 8, 9,
10, 11, 12, 13, 14, 18, 22, 26 and 30 msec) were obtained with the tube voltage set to 125
kV and the tube current to 16 mA. To reduce the lag eﬀects, only the last 50 of these
images at each intensity level were processed. The variation of the average high- and
low-gain signals with the frame counter was found small, namely, below the 1% level;
the variation in the original series (200 images) was around 15% for the high gain and 6
to 11% (depending on the pulse-width value) for the low gain. Therefore, the exclusion
of the ﬁrst 150 images at each intensity value leads to a signiﬁcant reduction of the lag
eﬀects.

2.5.2. The data analysis. The dark-ﬁeld images were processed ﬁrst. Each pixel was
followed across the input ﬁles. Pixels with constant contents were marked defect. Pixels
with null content in any of the images were also marked defect. Only a few pixels
failed these two tests. The average signal across the images and the rms of each signal
distribution (i.e., for each pixel) were evaluated and stored.

The processing of the raw images, obtained at diﬀerent intensity levels, came next.
The average signal across the input images and the rms of the distributions were
evaluated and stored for each good pixel (that is, not already marked as defect), at
each intensity level separately.

A correction to the pulse-width values was implemented to account for diﬀerences
between the actual widths of the produced pulses and the nominal acquisition settings.
A scheme has been put forth to derive these corrections from the low-gain signals +. For
each pixel of the detector, two low-gain values were assumed ‘safe’ to use: the measured
dark ﬁeld and the signal at the highest intensity being used in the calibration (30 msec).
The amount by which each intermediate pulse-width value had to be corrected in order
to bring the corresponding signal onto the straight line (deﬁned by the two extreme
measurements) was histogrammed, separately for the diﬀerent pulse widths, and average
values over the entire detector were obtained from these distributions. These correction
factors (see ﬁgure 2 for an example) were directly applied to the high-gain signal and
removed the nonlinear eﬀects which had previously been observed.

¶ The 2 and 3 msec pulse widths were avoided because of the larger corrections (due to the pulse shape)
which are to be applied at the low end of the (pulse-width) range.
+ In the future, these corrections will be estimated on the basis of the signals obtained from a
normalisation chamber which is placed close to the tube, at the borders of the radiation ﬁeld.

The dual-gain mode in CT imaging

9

The correction described in the previous paragraph ensures that the intensity-signal
linearity is fulﬁlled in the low gain on average; however, the absence of position-
it does make sense to test the
dependent eﬀects is not guaranteed. Consequently,
linearity hypothesis in each pixel even in the case of the low-gain data.

The intensity-signal linearity is fulﬁlled in each pixel up to a threshold value. An
absolute bound for this threshold corresponds to the ‘hard’ limit in the analog-to-digital
conversion, which at present utilises 14 bits of information; however, nonlinearity enters
the problem at smaller signals, in fact, at a ﬁxed (that is, almost identical for all pixels)
level below each maximal (saturated) signal mij. This last observation leads to two
suggestions: ﬁrst, diﬀerences (of signals) to the maximal signal (observed in the pixel
chosen) should be used in this investigation and, second, a single value of the diﬀerence to
the maximal signal (i.e., not a map) is adequate in describing the onset of the nonlinear
eﬀects over the entire area of the detector; in the following, this signal diﬀerence (to
the corresponding mij) will be denoted as d.
It is recommended that one be rather
generous with the starting d value; in the present analysis, the ﬁrst d value was 4000
counts. The linearity hypothesis was then tested for those signals which do not exceed
the mij − d level. If the test failed, the pixel was marked defect; if it succeeded, the
two parameters (slope and intercept) of the straight line, optimally describing the data
below the mij − d level, were calculated via a weighted least-squares ﬁt. The normalised
residuals for the signals above the mij −d level were evaluated on the basis of the straight
line which was obtained below the mij − d level. Finally, the square of each normalised
residual was histogrammed in bins of the diﬀerence df between the chosen signal and the
maximal signal mij. The position where the average χ2 contribution appeared rapidly
increasing with decreasing df identiﬁed the level at which nonlinear behaviour set in.
The above procedure involves one parameter, namely, the distance d. The consistency of
the scheme may be investigated by varying d. The average χ2 contributions as functions
of df are plotted in ﬁgure 3 for diﬀerent choices of d; it is comforting to ﬁnd out that
there is good overlap in the low-df region for all d choices. The conclusion from this
ﬁgure is that, for the detector used, the nonlinear behaviour starts becoming an issue
about 850 counts below the maximal signal. To safeguard against the variability of the
properties of diﬀerent detectors (of the same type), it was decided that the threshold
map contain the maximal signal (observed in each pixel) reduced by 1500 counts.

A few words should be said about the linearity tests. As usual, the χ2 function is

deﬁned by the formula

n

χ2 =

i=1  
X

2

,

i − yf
ym
δym

i

i !

is the measured signal in one pixel, yf

where ym
the signal
i
uncertainty, the index i identifying the dose level; the sum extends over n measurements.
The goodness of the ﬁt is determined on the basis of the p-value corresponding to the
calculated χ2 value for the given degrees of freedom, that is, n − 2, as two parameters
(slope and intercept) are calculated (per gain type) in each pixel; the p-value of the

i the ﬁtted one and δym
i

The dual-gain mode in CT imaging

10

ﬁt represents the upper tail of the χ2 distribution for the given degrees of freedom.
Large p-values indicate good ﬁts, small ones point to the ineﬃciency of the parametric
model to account for the input data; since a linear parametric model is used in the
data description, small p-values indicate departure from linearity. In the present paper,
statistical signiﬁcance is associated with p-values below 5%.

2.5.3. Extraction of the calibration maps. We now give some details concerning the
extraction of the calibration maps. In each pixel, two weighted least-squares ﬁts were
performed (ﬁgure 4). The high-gain ﬁts were made on all the values below threshold.
The low-gain ﬁts were made from the highest intensity which still yielded high-gain
signals below threshold onwards. This method ensures that the parameters for the two
gains be obtained exclusively from the regions where they will subsequently (in the data
processing) be used. The following distributions were obtained after iterating over all
pixels: high-gain dark ﬁeld (ﬁtted values), low-gain dark ﬁeld (ﬁtted values), high-gain
slope, low-gain slope and threshold.

We now come to an important point. Experience showed that the outcome of the
data processing using the two measured dark ﬁelds was inferior to the case involving
the ﬁtted values in the correction scheme. Taken as such, this observation implies the
existence of a systematic diﬀerence between the measured and ﬁtted values of the two
dark ﬁelds, corroborating a previous suspicion that the oﬀset obtained from a direct
measurement might not correct the raw data suﬃciently well. There is one additional
point to consider. Even if the ﬁtted values of the dark ﬁelds were stored each time that
the dual-gain calibration is performed (for instance, on a monthly basis), a recalibration
of the dark ﬁeld (which is made several times during the daily operation of the imaging
unit) would inevitably overwrite these maps. Therefore, only one set of oﬀset ﬁles,
the one obtained in the dual-gain calibration, would correspond to ﬁtted values; all
the subsequent ﬁles would contain measured, not ﬁtted, values. Such a correction
scheme, however, would be inconsistent. A solution to this problem may be obtained by
storing the measured dark-ﬁeld maps, as well as the ones corresponding to the diﬀerence
between ﬁtted and measured values. A recalibration of the dark ﬁeld overwrites only the
measured values. In the data processing, the diﬀerence of the two dark ﬁelds (assumed
to be time invariant) is added to the current (measured) dark ﬁelds to produce the
maps to be used in the oﬀset correction of the raw data. It has to be stressed that,
though the diﬀerence between ﬁtted and measured dark-ﬁeld values is about two orders
of magnitude smaller than these values themselves, it is nevertheless systematic and, as
such, it does aﬀect the correction scheme.

The high-gain ﬂatness-correction map is obtained from the high-gain slopes via
equation (5). The high-to-low-gain slope-ratio map is obtained from the ratio of the
two slopes as they are extracted from the two linear ﬁts to the data in each pixel. As
previously said, the threshold map has been obtained from the maximal raw signal in
each pixel, reduced by 1500 counts.

The defect-pixel map is the last of the calibration ﬁles. As the name indicates, this

The dual-gain mode in CT imaging

11

map contains the coordinates of the pixels with unreliable signal. This failure may be
due to several reasons: a pixel may be dead (constant signal), ﬂickering (occasionally
dead) or its properties may be suﬃciently ‘out of range’ when compared to a standard,
set by the majority of the pixels (bulk of the data). The tests for dead pixels take place
when processing the series of images being used as input in the calibration. To obtain a
set of pixels with suﬃciently close properties, we have applied cuts to the distributions
of the high-gain dynamic range (threshold diminished by the dark-ﬁeld value), low-gain
dynamic range and high-to-low-gain slope ratio. The pixels which populate the tails
of any of these three distributions were marked defect; 4σ limits on either side of the
average values were assumed. Pixels with high-gain ﬂatness correction outside the range
[0.5,2] were also marked defect. Although the choice of the acceptance limits (that is,
identifying what is suﬃciently ‘out of range’) is arbitrary, the changes in our results are
very small when using diﬀerent cuts (3 − 5σ).

The idea in the last part of the calibration is to capture those pixels which cannot
be properly corrected for during a scan. This failure may be due to a number of reasons.
For instance, as the calibration is performed at one gantry angle, it may be insuﬃcient
in correcting all pixels at all angles. Two scans are acquired corresponding to diﬀerent
acquisition pulse-width settings: the ﬁrst scan is tailored to the high-gain signal, the
second to the low-gain one. The low-gain component is not used in the high-gain
scan; similarly, the high-gain component is not used in the low-gain scan.
In either
case, raw signals of about 7000 to 11000 counts are obtained in the appropriate gain
type. Each pixel is followed across the images in the two scans separately. Pixels with
constant contents are marked defect. Pixels with null content or with content below
the corresponding dark-ﬁeld value in any of the images are marked defect. Each image
In each
is then corrected using the calibration ﬁles obtained in the previous steps.
image, the signal cij in every good pixel is compared to the average < c > of its good
neighbours. A dissimilarity index δcij may be deﬁned as
| cij− < c >|
< c >

δcij =

.

In case that δcij exceeds 3% in any of the input images, the pixel is turned to defect.
At the end of the analysis of the scan data, the defect-pixel map is updated (that is, it
is enhanced with those pixels which were marked defect at this stage).

the goodness of

The assessment of

the calibration. The average maps,
2.5.4.
corresponding to the pulse widths used in the calibration, are fully corrected on the basis
of the calibration ﬁles obtained; for artefact-free image reconstructions, it is important
that any deviations from uniformity on these fully-corrected average images be entirely
due to random, not systematic, noise. An overall ‘noise level’, deﬁned as the mean of all
rms-to-average-signal ratios over the entire intensity range, may serve as an indicator of
the goodness of the calibration; at present, the values lie in the vicinity of 0.1%. The
pixels contained in the tails (4σ cut) of any of the signal distributions do not contribute
to the calculation of this noise-level indicator; they are all turned to defect. At the

The dual-gain mode in CT imaging

12

end of the assessment, the defect-pixel map is updated. This operation completes the
calibration of the dual-gain mode.

2.5.5. Some numbers. The defect-pixel map was gradually enhanced as follows. The
analysis of the dark-ﬁeld images suggested the exclusion of 6 pixels. The linearity tests
failed in the case of 11 pixels. A total of 1135 pixels were excluded as belonging to the
tails of the distributions of the high-gain dynamic range, low-gain dynamic range and
high-to-low-gain slope ratio; the lion’s share corresponds to the two former distributions
and mostly represents three half-columns of detector pixels which stick out dramatically
from the rest of the data. An additional 3071 pixels were found defect during the analysis
of the data of the two scans. Finally, 1180 pixels failed to pass the signal-distribution
cut applied during the assessment of the goodness of the calibration. Therefore, the
resulting defect-pixel map contained 5403 pixels, corresponding to about 0.7% of all
pixels in the active area of the detector.

When ﬁtted to a Gaussian form, the distribution of the high-gain dynamic range
yielded an average of 12620 and an rms of 120 counts. The high-gain ﬂatness correction
for all good pixels was found equal to 1.003 ± 0.052 and the low-gain ﬂatness correction
to 1.002 ± 0.049. The high-to-low-gain slope ratio was found equal to 6.733 ± 0.087.

Finally, a straight line was ﬁtted to the average fully-corrected signals, obtained
in each of the average maps corresponding to the diﬀerent intensity levels used in
the calibration. The description of the data was found to be excellent and the
extrapolation to null intensity yielded an intercept of −2.5 ± 1.9 counts, compatible
with the expectation value of 0. The slope on this plot was found equal to 79699.3 ± 9.7
counts/mAs.

2.6. The processing of dual-gain data

In each pixel, two fully-
The dual-gain data are processed in the following manner.
corrected signals are created: the ﬁrst corresponds to the high gain (7), the second to
the low gain (12). The raw high-gain signal sij is then compared to the threshold value
tij for the pixel currently processed; only if sij is smaller than tij, is the high-gain content
used. Finally, one map is created corresponding to half the size of the input data.

To ensure a smooth transition between the regions where the high- and low-gain
signals are exclusively used, one may think of introducing a constant window (w)
below threshold where both signals (with the appropriate weights) are involved in the
determination of the output value. The weights which the two signals are to be given in
the overlapping region are subject to two conditions. First, they have to be ‘continuous’
functions of the input signal: the high-gain weight must equal 1 at the tij − w position
and 0 at tij. Second, the sum of the two weights must equal 1 at all positions.

Finally, the signals in the defect pixels are not processed; their contents are
obtained via interpolations using their good neighbours. An iterative approach has been
developed to correct for defect-pixel clusters (defect pixels without any good neighbour).

The dual-gain mode in CT imaging

13

At each iteration cycle, the defect pixels with the maximal number of good neighbours
are identiﬁed and corrected for; the value assigned to any such pixel is the average
of its good neighbours. At the end of each iteration, the defect-pixel map is updated
(the pixels which were interpolated at that step are restored as good). The process
is repeated until all defect pixels have been corrected for. (Naturally, such a simple
scheme is not expected to correct in case of large defect-pixel clusters, but then again
which one would?) On the technical side, the correction sequence (deﬁning which pixel
is to be corrected at which step) solely depends on the supplied defect-pixel map; the
algorithm proposed leads to unique corrected maps. To enable the fast processing of
the data, the way in which the correction is to be performed is determined only once
(at the initialisation step, prior to the data processing) and the correction sequence is
stored in an array.

3. Results

To assert the improvement in the image quality when using the dual-gain signal, three
reconstructions were made: the ﬁrst two involved separately the low- and high-gain
components of the dual-gain signal, whereas, in the last case, the two signals were
combined as described in the previous section. As an example, a phantom (Catphan
500, The Phantom Laboratory, Salem, NY) was scanned, using the acquisition settings:
125 kV, 80 mA and 12 msec.

The results for the reconstructed central slice of the phantom (corresponding to its
CTP401 module) are shown in ﬁgure 5. The reconstruction resolution is 512 × 512. The
standard 2D weighted ﬁltered backprojection algorithm was used, see Kak and Slaney
(1988), combined with modiﬁed-Blackman noise ﬁlter. The input data comprised 675
images obtained within one complete rotation of the gantry. The geometric calibration,
see Matsinos and Kaissl (2006), was made prior to the data acquisition and yielded
the values of the lateral displacement of the detector (2.335 mm) and source-detector
distance (1496.74 mm); these values were used as input in the three reconstructions. In
the processing of the dual signal, a constant window of 500 counts below the threshold
was introduced in each pixel; linear weights for the two gains were assumed in the
overlapping window. It is evident that the reconstruction of the fully-processed dual-
gain signal is of superior quality; when only the high-gain component is used, the borders
of the phantom cannot be reconstructed (due to signal saturation), whereas noise eﬀects
and artefacts appear (as a result of the signal degredation in the high-attenuation areas
of the irradiated object) in the reconstruction of the low-gain signal.

4. Discussion and conclusions

With image-guided radiation therapy (IGRT), tracking and targeting tumours will
become simultaneous processes. Such a development will boost eﬃciency, reliability
and safety in radiation therapy. To this end, Varian Medical Systems, Inc. (VMS), has

The dual-gain mode in CT imaging

14

produced and installed the ﬁrst IGRT machine, the standard VMS Clinac equipped
with an imaging unit. Cone-beam CT (CBCT) imaging, one of the operation modes of
the imaging unit, aims at high-quality volumetric reconstruction. The information on
the position of the tumour and of the vital organs and tissue may be processed quickly,
enabling modiﬁcations in the treatment plan on the daily basis and resulting in the
delivery of higher dose in each treatment session and higher protection of the healthy
tissue surrounding the tumour. The dynamic targeting, the simultaneous tracking and
targeting tumours, is the next goal.

A number of calibrations are needed in order to operate the imaging unit properly;
these calibrations ensure that the machine components are aligned, the mechanical
distortions are small and yield important output which is to be used in the reconstruction
of the scan data. To improve quality in CBCT imaging, VMS has developed the
dual-gain mode, a successful means for enhancing the dynamic range of the ﬂat-panel
detectors (FPD). The broadening of the dynamic range leads to better contrast in the
reconstructed images as meaningful data is simultaneously obtained both in the high-
and low-attenuation areas of the irradiated object. The appropriate calibration of the
mode has been achieved via an elaborate pixel-to-pixel analysis and has been shown to
lead to improved artefact-free images.

The response of each pixel of the FPD to the variation of the incident radiation is
thoroughly investigated on the basis of a series of images obtained at several intensity
levels. At the onset of the calibration, a correction to the pulse widths is derived and
applied systematically in the rest of the analysis. A threshold value in each pixel is
identiﬁed as corresponding to the maximal raw signal which fulﬁlls the intensity-signal
linearity, a basic point in the data processing. The response parameters in the high-
and low-gain-signal series are extracted from the input data and are used to produce the
ﬂatness corrections and the high-to-low-gain slope-ratio map. Finally, the defect-pixel
map is obtained, containing dead and ﬂickering pixels, as well as those pixels having
properties which are suﬃciently ‘out of range’.

One of the important corrections made in the present scheme relates to the dark
ﬁeld. It so happens that the dark ﬁelds obtained in the absence of incident radiation
cannot correct the raw data suﬃciently well; the ﬁtted values, that is, the ones obtained
via an extrapolation from nonzero intensities, seem to do a better job. A scheme has
been proposed to ensure that the ﬁtted values of the dark ﬁeld, instead of the measured
ones, be involved in the oﬀset correction of raw data. The only assumption made at this
point is that the (generally small) ﬁtted-minus-measured dark-ﬁeld diﬀerence in each
pixel is time invariant, this being a reasonable claim regarding the temperature stability
in the laboratory and the concepts involved in the electronics of the detector.

The data-processing scheme uses the maps obtained during the calibration.
Concerning the combination of the high- and low-gain images, the high-gain signal is
used whenever meaningful (not saturated); otherwise, it is substituted by the low-gain
signal, properly scaled with the high-to-low-gain slope ratio. A constant window below
the threshold value in each pixel may be introduced to ensure the smooth transition

The dual-gain mode in CT imaging

15

from the area where the high-gain signals are used to the one where they are replaced
by the low-gain signals. In this overlapping window, both signals, with diﬀerent weights,
are invoked in the determination of the output values. Defect pixels are interpolated
on the basis of the contents of their good neighbours. A simple method achieving the
correction in case of small defect-pixel clusters has been implemented.

Acknowledgments

The dual-gain mode was developed in a time span of several years. Its potentiality in
improving the quality in CT imaging was originally conceived by our colleagues: R E
Colbeth, I Mollov, J Pavkovich, P G Roos, E J Seppi, E G Shapiro and G Zentai. During
the development phase, important contributions were made by many; we apologise if
some names which should have been included do not appear here. During the recent
past, important contributions in this research were made by S B¨ahler, P Munro, J
Richters, H Riem, R Suri, C A Tognina and G F Virshup. The data presented in this
paper were acquired by H Riem.

References

612-19

Rad. 36 69-73

Med. Biol. 45 329-47

Feldkamp L A, Davis L C and Kress J W 1984 Practical cone-beam algorithm J. Opt. Soc. Am. A1

Fuchs Th, Kachelrieß M and Kalender W A 2000 Technical advances in multi-slice spiral CT Eur. J.

Grass M, K¨ohler Th and Proksa R 2000 3D cone-beam CT reconstruction for circular trajectories Phys.

Hsieh J, Gurmen O E and King K F 2000 Investigation of a solid-state detector for advanced computed

tomography IEEE Trans. Med. Im. 19 930-40

Jaﬀray D A, Siewerdsen J H, Wong J W and Martinez A A 2002 Flat-panel cone-beam computed
tomography for image-guided radiation therapy Int. J. Radiation Oncology Biol. Phys. 53 1337-49
Kachelrieß M, Watzke O and Kalender W A 2001 Generalized multi-dimensional adaptive ﬁltering for

conventional and spiral single-slice, multi-slice, and cone-beam CT Med. Phys. 28 475-90

Kak A C and Slaney M 1988 Principles of Computerized Tomographic Imaging (New York: IEEE

Matsinos E 2005 Current status of the CBCT project at Varian Medical Systems Proc. SPIE 5745

Press) p 86-92

340-51

SPIE 4320 47-58

Med. Phys. 26 689-97

Matsinos E and Kaissl W 2006 The geometric calibration of cone-beam imaging and delivery systems

in radiation therapy Preprint physics/0607018

Overdick M, Solf T and Wischmann H-A 2001 Temporal artefacts in ﬂat dynamic X-ray detectors Proc.

Pan X 1999 Optimal noise control in and fast reconstruction of fan-beam computed tomography image

Pan X and Yu L 2003 Image reconstruction with shift-variant ﬁltration and its implication for noise

and resolution properties in fan-beam computed tomography Med. Phys. 30 590-600

Roos P G et al 2004 Multiple-gain-ranging readout method to extend the dynamic range of amorphous

silicon ﬂat-panel imagers Proc. SPIE 5368 139-49

Tang X, Hsieh J, Hagiwara A, Nilsen R A, Thibault J-B and Drapkin E 2005 A three-dimensional
weighted cone beam ﬁltered backprojection (CB-FBP) algorithm for image reconstruction in
volumetric CT under a circular source trajectory Phys. Med. Biol. 50 3889-905

The dual-gain mode in CT imaging

16

Young I T, Gerbrands J J and Van Vliet L J 1998 Fundamentals of Image Processing (Delft: PH

Yu L and Pan X 2003 Half-scan fan-beam computed tomography with improved noise and resolution

Publications) p 32-5

properties Med. Phys. 30 2629-37

Zou Y, Pan X and Sidky E Y 2005 Image reconstruction in regions-of-interest from truncated projections

in a reduced fan-beam scan Phys. Med. Biol. 50 13-27

The dual-gain mode in CT imaging

17

Figure 1. The VMS Clinac accelerator equipped with imaging functionality;
Hirslanden Klinik, Aarau, Switzerland.

The dual-gain mode in CT imaging

18

Figure 2. The corrections applied to the pulse-width values in the present analysis
for the various acquisition pulse-width settings; the uncertainties represent the rms of
each distribution.

The dual-gain mode in CT imaging

19

Figure 3. The average χ2 contribution as a function of the diﬀerence to the maximal
signal. The series correspond to diﬀerent choices of the parameter d (see text).

The dual-gain mode in CT imaging

20

Figure 4. High- and low-gain ﬁts for one pixel chosen at random. The threshold
value for this pixel corresponds to 13685 counts (horizontal line). The parameters
for the high gain are obtained from the signals below threshold (open circles); above
threshold, the high-gain points (ﬁlled circles) are not used. The parameters for the
low gain are obtained from the signals corresponding to the area where the high-gain
signal saturates (open squares); the low-gain values are not used in the area where the
high-gain signals are below threshold (ﬁlled squares). Saturation in this pixel occurs
around 0.16 mAs.

The dual-gain mode in CT imaging

21

Figure 5. The reconstructed central slice of a phantom using the calibration and data-
processing scheme described in the present paper (right); also shown are the results
involving only the low- (left) and the high-gain (middle) components of the dual-gain
signal. In the case of the low-gain signal, the central area of the reconstructed image
has been magniﬁed to demonstrate the signal degradation.

