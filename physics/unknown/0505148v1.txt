1

TTRG integration of light transport equations:

Azymuthally integrated radiances inside a Lambertian foliage

Sophie Royer
Institut für Botanik, Universität Innsbruck, Austria
Antoine Royer
Département de Génie Physique, Ecole Polytechnique, Montréal, Québec H3C 3A7, Canada

A method for numerically integrating transport equations, combining transfer matrices,
transmission-reflection matrices, and Green’s matrices (TTRG), was recently proposed. The
present paper deals specifically with azymuthally integrated radiances inside a horizontally
homogeneous canopy of Lambertian leaves. Its main purpose is to test the accuracy of TTRG by
applying it to non-trivial models possessing analytical solutions, that were given in another
paper. Comparison is made with the widely used iterative integration (or ‘relaxation’ method).
Cases of extreme light trapping are given for which iterative integration is hardly practical, while
TTRG remains as accurate and rapid.

1.   Introduction

In a preceding paper [1], a method was proposed for numerically integrating transport

equations by combining transfer matrices, transmission-reflection matrices, and Green’s matrices

(TTRG). The purpose of the present paper is to test the accuracy and speed of TTRG, by

applying it to analytically solvable models that were formulated in another paper [2], and

compare with the widely used iterative integration (or ‘relaxation’ method [3]).

         The physical system considered is light propagating in a horizontally homogeneous,

azymuthally symmetric (j-symmetric for short) canopy of Lambertian leaves [3-5]. In the

present paper, we only compute j-integrated radiances (i.e., radiances integrated over the

azymuthal angle j), which is much easier. These give the complete solution if the incident

radiance is  j-symmetric (as skylight is usually assumed to be), since the radiance inside the

canopy will then also be  j -symmetric. If there is also sharply directional sunlight incident on

the canopy, then the diffuse radiance may be assumed, as an approximation [3-5], to be

j-symmetric, in which case the  j-integrated radiance again provides the complete solution.

Computation of j-dependent diffuse radiances is defered to subsequent papers.

2

Our treatmen is more general than usual in that we allow the top and under sides of

leaves to have different optical properties, which is more realistic. Moreover, this allows us to

create artificial situations, such as extreme light trapping, for testing the limits of numerical

methods.

We assume purely Lambertian scattering and emission of light, both by individual leaves

and by the ground surface. The light transport equation (LTE) can then be discretized over

photon directions in an analytic way. This makes high precision tests possible.

High precision tests are done in cases with zero emission (either thermal emission, or

first-scattered-sunlight ‘emission’), by applying TTRG to non-trivial models possessing

analytical solutions [2]. Agreement is generally better than 10 significant digits when we let the

computer carry 15 digits (double precision). With emission present, one must numerically

integrate ‘propagated emissions’[1], so that the overall precision of TTRG is limited by the

accuracy of that numerical integration.

Cases of extreme light trapping are given for which interative integration requires on the

order of hours to attain accuracies of 10 3-   or so, while TTRG acheives 10 10-

 and better in

fractions of a second. Also, just stipulating a convergence criterium for the iterative integration

can be problematic. Thus, there are situations where iterative integration is hardly practical,

while TTRG remains as efficient. Such problems do not occur with realistic canopies, but TTRG

is still appreciably faster, as well as much more accurate.

The paper has three parts: Part I deals with the more formal aspects of the paper,

including the derivation of the j-integrated LTE, and its discretization over photon inclinations.

Part II roughly estimates the appropriate thicknesses for the ‘medium’ layers required in TTRG,

and for the ‘thin’ layers used in both TTRG and iterative integration. Part III presents and

discusses the results of numerical computations. Appendices contain technical details.

Remark: Equations in references [1] and [2] will be refered to as  Eq.I-(10), or Eq.II-(20), etc.

Also, section 3 of Ref.[1] will be refered to as section I-3, etc.

3

Notation and conventions: We let the positive  z  direction point downwards. A hat over a scalar

c  signifies absolute value,  ˆc

c∫

> 0 . Using the step function   Q( )x , we denote

x

± ∫

x

(

±

Q

x

)

=

ˆ
x

(

x

),             Q(

x >

±

Q

=0
)

1,     Q(

x <

=0
)

0

Unit vectors in direction   W = ( ,

)mj , where  m

∫ cos , are denoted  WWWW :

q

,
WW == W W W
x

z

y

,

) = (
d d
,
q q j m j
=

sin cos , sin sin ,

,
)
q j q j m
d
)
d f
j m mj

(
f
W W

d d

( ,

m

W

=

=

=

d

)

p

1

z

cos

q

d

W

sin

(
=

Ú

Ú

-p

Ú

1
-

The scalar product of two unit vectors   WW  and   WW¢  is

WW WW◊

¢ =

mm

¢ +

sin sin

q q
¢

cos(

j j
- ¢

)

Dirac d functions of solid angles are written

(
W W- ¢ =
d

)

(

- ¢
d m m d j j

- ¢

) (

)

For any function   f (

)m , and any interval   Dm m m

= (

,

1

2 , we denote
)

f

(

)
m

D

∫

d f
)
(
m m

∫

d f
)
(
m m

,         Dm m m

= (

,

1

2 ,     m m1
)
2<

Ú

D

m

m
2

Ú 1

m

We note the following expansion for small   D ˆm:

f

(

)
m
D

=

f

ˆ
(
)
m m
D

+

1
24

f

3
ˆ
(
)
m m
D

≤

+

...,

m

∫

1
2

(
+
m m
2

1

),

ˆ
m m m
D
1
2

-

∫

obtained by writing   f

(
)
m

=

f

(
)
m

f
+ ¢

(
)
m m m

)(

-

+

1
2

f

(
m m m

)(

-

)

≤

2

+

...

 , and noting that

m
2

Ú

m
1

)
d
m m m

-

(

n

1
2

ˆ
m

D

=

Ú

1
2

ˆ
m

D

-

n

dx x

=

n

1

+

1
2

(

ˆ
)
m
D

1

2
n
+
0

Ï
Ô
Ì
ÓÔ

if     is odd

n

if     is even

n

 

We will need the following integrals of the scalar product (3), using the notation (1):

d

Ú

WW WW WW

◊

¢ =
±

Ú

d

WW

m

=

±

1

p

Ú

-p

d
j m m0
Ú

d

,

= p

d

W

◊
WW WW

2
¢ = p

  

Ú

The following functions are obtained analytically in Appendix B:

g

±

( ,
m m

)
¢ =

1
2
p

d
j

WW WW
◊
¢

,

±

g

±

(

,
D
m m

)
¢ =

d g
m m m
¢
±

( ,

)

Ú

D

m

g

( ,
m m

)
¢ =

1
2
p

d
j

WW WW
◊

¢ =

g

+

( ,
m m

)
¢ +

g

-

( ,
m m
¢

)

p

-p

Ú

p

Ú

-p

We write   W ŒD  or  m ŒD  if  m > 0  (W points downwards),  W ŒU   or  m ŒU   if  m < 0

(upwards). A function   f

W = m   independent of  j  is said to be j-symmetric. 
(

)

)

(

f

(1)

(2)

(3)

(4)

(5)

(6)

(7)

(8)

(9)

Part I    Theoretical aspects

4

This part presents the more formal aspects of the paper. Section 2 summarizes the results

of Ref.[2] that we will need. Section 3 derives the j-integrated light transport equation (LTE).

Section 4 obtains a j-integrated LTE for the diffuse light, with first-scattered-sunlight treated as

an ‘emission’. Section 5 discretizes photon inclinations. Section 6 writes the LTE in matrix form.

Section 7 assumes purely Lambertian scattering and emission. Finally, section 8 deals with

totally absorbing leaves (black leaves).

2   Summary of previous results

We here summarise, for easy reference, results from Ref. [2] that we will use. A photon

travelling in direction  W  is refered to as a ‘photon W’.

Leaves: Scattering and emission coefficients for a horizontal leaf, s(

W

fÆ   and e(
)
Wi

)W f

, are

defined such that  s(

W

i

fdÆ
)
W W
f

  is the probability for a photon   Wi  hitting the leaf to get

scattered into  d fW , and  e(

fd
)W Wf

  is the number of photons emitted into  d fW   by the leaf, per

second per unit area of leaf. The absorption coefficient is

(
W
a

i

)

Ú1
= -

d
W W
s
f

(

i

Æ

W

f

)

It will be convenient to also use the notations

s

(
W

i

Æ

W

f

)

ˆ
ms
i

(
W

i

∫

Æ

W

f

),

a

(
W

i

)

∫

ˆ
(
ma
W
i

i

)

(10)

(11)

Coefficients for the ground surface are written with a subscript  g, e.g.,  sg

(
W

i

)
WÆ .

f

All the above coefficients are assumed invariant under rotations about the vertical  z  axis.

Thus, it suffices to specify the orientation of an inclined leaf by the normal   W L   to its underside.
For a leaf of orientation   W L  (or a ‘leaf  W L ’ for short), the optical coefficients are written with a
subscript   W L , e.g.,  s

)
WÆ .

(
W

i

f

WW
L

Canopy: A horizontally homogeneous canopy is characterized by volume densities  h(
z d
, )W
W
of leaf areas oriented within   d LW . When a photon   Wi  travels an infinitesimal distance    WWidl
through the canopy (where   dl  is an infinitesimal length), it has probability   G W(
i z dl  to get
, )
l  to get scattered into   d fW , where
, )
z d
intercepted by a leaf, and    S

(
W

Æ

W

W

d

L

f

i

f

L

5

(
G W

i

,

z

) =

d

(
h
W W
L

L

,

z

)

WW WW
◊
i
L

Ú

S

Æ(
W

i

,

z

W

f

) =

Ú

d

(
h
W W
L

L

,

z s
)
WW
L

(
W

i

Æ

W

f

)

(12)

(13)

(14)

(15)

The probability per unit distance for the photon to get absorbed is, by (10)-(11):

A

(
W

i

, )
z

=

(
G W

i

, )
z

-

d
(
S
W W
f

i

Æ

W

f

, )
z

=

d
(
h
W W

L

L

, )
z a

(
WW

L

i

)

Ú

Ú

The canopy emits into the solid angle  d fW , per second per unit volume, a number of photons

equal to  

  E (

, )W

f z d , where
W

(
E W
  

f

,

z

) = Ú

d

(
h
W W
L

L

, )
z

(
WW

L

e

f

, )
z

Here we let the leaf thermal emission  eW WL

(

, )  depend on  z, because the temperature of a leaf
f z

will depend in general on its position inside the canopy.

Radiances: We denote by   I

, )W
z d
(

W  the photon flux in direction   W , i.e., the number of

z

photons within   dW  crossing per second a unit area perpendicular to  W . We will often call
, )W   the ‘radiance’ (though more properly radiance is the energy flux). Radiances in
(
I
, )W   and
z
(

downwards ( W ŒD) and in upwards ( W ŒU ) directions will also be denoted by   D
U

z

, )W , so that
(

I

, )
z

(
W

(
W

   if   

z D
, )
=

(
W
W
The LTE: Over an infinitesimal distance    WWf dl, the flux   I
interception by leaves, but gains photons, either emitted into  d fW , or scattered into   d fW   from

W   looses photons due to

, )W
z d
(

z U
, )
=

   if   

(
W

(16)

, )
z

W

D

U

Œ

Œ

I

,

f

f

l
other directions  Wi. Whence the light transport equation (since    d

= m ):

dz

f

d
dz

m

f

ˆ
m
  

f

I

(
W

f

z
, )

= -

(
G W

f

z I
, ) (

W

f

z
, )

z S
, ) (

W Æ W

i

f

z
, )

E

(
W

f

+

z
, )

 

(17)

+ W W
i

i

d

I

(

Ú
(
W W

i

)

Æ +
f

e
g

U

(
W

f

,

z

g

)

=

d D
W W
i

(

i

,

z

g

)

s

g

Ú Œ

m
i

D

(
W

f

),

m

f

<

0

The second line is the reflection and emission by the ground surface, at   z

zg= .

3   jjjj-symmetric canopy, jjjj    -integrated LTE

We henceforth assume j-symmetric leaf area densities. The j-integrated radiance then

satisfies an equation free of azymuthal angles, much simpler than the full LTE (17).

6

jjjj-symmetric canopy: So let us assume j-symmetric leaf area densities

z
, )

(
W L
h

1
= p
2

˜(
h m
L

Ú
Since these define no prefered azymuthal direction,  G W(

h m
L

∫

-p

z
, )

       where       ˜(

, )
z

p

(
d
W
j h
L

L

, )
z

, )z  and   S

(
W

i

WÆ

f

, )
z

  will also be

j-symmetric, that is:

(
G W
s
(
W

g

z
, )

=

G

Æ

W

i

( , ),
z
m
)

s

=

f

g

S

i

Æ(
W
,
),

(
m m j
if

Æ

f

i

,

z

W

f

) =

S

(
m m j
if

Æ

,

f

i

z
, )

j j j

-

∫

if

i

f

where we also assume j-symmetric ground scattering coefficients  sg . Using (9), we have

G( , )
z
m

=

˜(
d
m h m
L
L

, ) ( ,
z g

m m
L

)

1

-Ú 1

jjjj-integrated LTE: If the light incident on the canopy is  j-symmetric, then so will the radiance

inside the canopy, since there is then no prefered azymuthal direction whatsoever, i.e.:

I

1
z
, )
(
W = p

2 m       where       ˜( , )
z

˜( , )
I
z

m

I

p

∫

Ú
zm   is much easier to compute than   I

-p

d I
j

,
W

(

z

)

The  j-integrated radiance   ˜( , )

I

, )W , for it satisfies a
(

z

much simpler transport equation, free of azymuthal angles. Indeed, integrating (17) over jf , and

using (19), we obtain:1

        

˜(
I

f

m

d
dz
˜ (
ˆ
U
m m
  

f

m

f

z
, )

= -

G

(
m

f

, ) ˜(
z I

m

f

z
, )

+

˜ (
d I
m m
i

i

, ) ˜(
z S

m m
Æ

i

f

z
, )

+

˜ (
E

m

f

z
, )

1

Ú

1
-

,

z

g

)

f

=

Ú

m
i

Œ

D

˜ (
d D
m m
i
i

,

z

g

) ˜ (
s
g

)
m m e m
Æ +
f

˜ (
g

i

f

)

(
m

f

UU )

Œ

where a tilde signifies integration over  j . In particular:

˜(
S

Æ
m m

i

f

z
, )

∫

d S
Æ
j m m j

(

,

i

z
, )

1

˜(
d
m h m
L
L

, ) ˜
z s
m
L

(
Æ
m m

i

f

)

p

-p

Ú
(
E W

˜ ( , )
z
E
m
  

∫

p

Ú

-p

d
j

z
, )

=

1

Ú

1
-

f

=

Ú
, ) ˜
d
z
m h m e m
L

˜(

1
-

L

m
L

z
( , )

                                                  

(18)

(19)

(20)

(21)

(22)

(23)

I

1 Note that   ˜( , )
j-symmetry (19) holds, without horizontal homogeneity, then the integral over  jf  of   W ◊ — W
Eq.(22) of Ref.[2], does not produce   ˜(
I
canopy of parallel hedges, even if (19) holds locally.

zm   satisfies a closed equation only if the canopy is globally j-symmetric. If only local
, )r , in
fm r . Indeed, we do not expect j-symmetric radiances inside a

, )

I(

f

f

7

=

Ú

Ú

where we define  jf -integrated, jL -averaged leaf coefficients

˜
s
m
L

(
m m

Æ ∫
f

)

i

˜
e m
m
L

z
( , )

∫

1
2
p

p

-p

1
2
p

Ú
d
j
L

d
j
L

p

d
j

-p

Ú
d
j e
f
WW
L

p

Ú

-p

p

Ú

-p

(
W

z
, )

s
WW
L

(
W

i

f

Æ

W

f

)

using (10)-(11):

A

( , )
z
m

=

( , )
z
m

G

-

d
m m m
i

Æ

f

f

˜(
S

, )
z

˜(
d
m h m
L
L

, )
z a

(
mm
i

L

)

Ú

where we define  jL -averaged leaf absorption coefficients, using (9):

Canopy absorption and emission: The local canopy absorption coefficients (14) may be written,

p

a
m
L

(
m
i

)

∫

Ú
Here we noted that   a

1
2
p

-p

d
j
L

a
(
W W

L

i

)

=

g

,
(
m m
i
L

)

-

d
m

f

˜
s
m
L

(
Æ
m m

i

f

)

W W(

L

i

)  can only be a function of the angle between   Wi  and   W L , hence of

L-
j ji

, by (3). Note also that the ground absorption coefficient is given by

a

g

(
)
W =
i

a

g

ˆ
(
)
m m
=
i

i

-

d
m m m
i

˜ (
s
g

Æ

f

f

)

ŒÚ

m

f

U

The total numbers of photons absorbed or emitted per second, per unit volume of canopy, or per

unit area of ground surface, are:

A

z
( )

=

Ú

A
  

g

=

Ú

D

m

Œ

z
, ) ( , )
z A

m

d I

(
W W
˜ ( ,
d D z a
m m

)

g

(
m

),

g

=

Ú

˜( , ) ( , ),
z A

z

d I
m m

m

E

z
( )

=

d

(
E
W W

z
, )

Ú

E

g

∫

Ú

U

m

Œ

˜ (
d
)
me m
g

Continuity equation: Integrating (22) over mf , using (25), yields continuity equations

i z
( )

E

z
( )

-

=

A

z
( ),

i z
( )

D

z
( )

U

z
( )

-

∫

d
dz
ig
  

∫

D U E A
=
g

-

-

g

g

g

where   i z( )  is the net vertical flux, and    D( )z   and    U( )z   are ‘down’ and ‘up’ vertical fluxes
(numbers of photons crossing per second a horizontal unit area):

∫

z
( )

D
  

ˆ ˜ ( , ),
D z

d
mm m

Ú
In (29) we used the shorthands   i

m

D

Œ

U

z
( )

∫

Ú

m

U
Œ

ˆ ˜ ( , )
U z

d
mm m

= (
i z

g

), 

g

  D Dg
=

(

gz

), etc.

(24)

(25)

(26)

(27)

(28)

(29)

(30)

8

4   First-scattered sunlight treated as an ‘emission’

In this section we consider the effect of sunlight, and how to deal with it. Light incident

on the top   z

z= 0   of the canopy comprises skylight and sunlight. Diffuse skylight is assumed

isotropic in ‘down’ directions, while sunlight is modeled as a sharply directional radiance in the

(downwards) direction   Wh   of sunrays (here  h  stands for helios, and  d  for diffuse):

d

D

(
,
W

z
0

)

=

d
D
0

,

h

D

(
,
W

z
0

)

=

(
h
-d
W W
0

h

)

The incident vertical fluxes are thus, by (30) and (4) (writing    D D0

∫

(

)z
0

, etc.):

d
D
0
  

=

ŒÚ

m

D

ˆ ˜ ( ,
D
d
mm m

d

z
0

)

= p

d
D
0

,

h
D
0

ˆ
m
h

=

h
0

   

Inside the canopy, direct sunlight   I

h (

, )W   is attenuated due to interception by leaves, and is

z

given by:

h

I

(
W

z D
, )
=

(
W

, )
z

=

h

-
W W

h

),

( )
h z

∫

h
x
0
m
h

( )
z

x
m

( )
z

∫

x
m

(

, )
z z
0

∫

-

L

m

e

L
m

(

,
z z
2
1

)

2

z
∫ Ú
z
1

dz

z
( , )
m m

G

h z

( ) (
d
z
, )

z

(

0

,

Broken        jjjj-symmetry : In general, due the sharp directionality of sunlight, the radiance   I

, )W
(
z

will depend on  j, and so will the thermal emission    E (

, )W z   (since the temperature of a leaf

depends on its orientation, especially relative to sunlight). Of course, even if  I

, )W   is not j-
(

z

symmetric, the j-integrated LTE (22) is still valid. Its input is the j-integrated incident radiance

˜ ( ,
D z
m
  
0

)

=

d

˜ ( ,
D
m

z
0

)

+

h

˜ ( ,
D
m

z
0

)

=

d
2
D
0

h
-
d m m
h
0

(

)

+

by (31)-(32) and (4). But   ˜( , )

I

zm   no longer yields   I

, )W   via (21).
(

z

Diffuse light: However, the diffuse radiance

d

I

(
W

, )
z

∫

I

(
W

, )
z

-

h

I

(
W

, )
z

=

I

(
W

, )
z

-

h z

( ) (

-d

W W

h

)

is expected to vary mildly with j, and is often approximated as j-symmetric [3-5]:

d

˜ ( , )
I
z
m

=

1
2
p

˜( , )
I
z
m

-

1
2
p

h

˜ ( , )
I
z
m

d

z
I
, )
(
W ª
˜ ( , )
z
I
m

=

h

1
2
p
( ) (
h z

d m m
-
h

)

Within that approximation,  ˜( , )

I

zm   still provides the complete solution, since

I

(
W

, )
z

=

1
2
p

d

˜ ( , )
I
z
m

+

h

I

(
W

, )
z

=

1
2
p

˜( , )
I
z
m

-

1
2
p

h

˜ ( , )
I
z
m

+

h

I

(
W

, )
z

The vertical fluxes are

(31)

(32)

(33)

(34)

(35)

(36)

(37)

9

z
( )

=

D
  

Ú

D

m

Œ

ˆ ˜ ( , )
d
z
D
mm m

d

ˆ
m
h

+

h z

( ),

U

z
( )

=

Ú

U

m

Œ

d
mm

ˆ ˜ ( , )
z
m

U

d

The total absorption rates in (28) are now given by

A

( )
z

A
  

g

=

d
d I
m m
˜ (

d D
m
i

d

D

=

Ú
Ú Œ

m
i

˜ ( , ) ( , )
z
z A

m

+

( ) (
h z A

, )
z

m
h

m
i

,

z a
)
g

g

(
m
i

)

+

h z a
)
g

(

g

(
m
h

)

jjjj-integrated diffuse LTE: In practice, photon inclinations  m  must be discretized, to enable

numerical computation. Now, the attenuation (33) of sunlight, and the vertical incident sunlight

flux mhh0  (hence the energy flow into the canopy), are very sensitive to the inclination mh   of sun
rays. So tinkering with the latter (e.g., putting it equal to one of the discrete inclinations) may

entail sizable errors, because sunlight is so intense. It is therefore customary [3-5] to compute

accurately the attenuated sunlight   h z( ), thence the sunlight that has been scattered once, and

treat that as an ‘emission’. This is achieved by substituting   ˜( , )
z

=
(or by integrating the diffuse LTE (50) in Ref. [2] over jf ), to obtain

m

I

d

˜ ( , )
z
I
m

+

h

˜ ( , )
z
I
m

  into (22)

d
dz
˜ (
d
U

m

f

ˆ
m
  

f

d

˜ (
I

m

f

z
, )

= -

G

(
m

f

, ) ˜ (
z I

d

m

f

z
, )

+

˜ (
d
d I
m m
i

i

, ) ˜(
z S

m m
Æ

i

f

z
, )

+

tot

˜
E

(
m

f

z
, )

1

Ú

1
-

m

f

,

z

g

)

=

Ú

m
i

Œ

D

d D
m
i

d

˜ (

m
i

,

z

g

) ˜ (
s
g

tot
˜
m m e
Æ +
g
f

)

i

(
mm

f

),

m

f

< 0

˜
where    
E

tot

˜
˜
E E
+

=

h

tot
  and   ˜
e
g

h
˜
˜
+
e e
g
g

=

   comprise ‘true’ (i.e., thermal) emissions    

˜E   and  ˜eg,

and first-scattered-sunlight ‘emissions’ given by, in view of (23)-(24):

˜ (
E h

m

f

z
, )

=

( ) ˜(
h z S

m
h

Æ

m

f

z
, )

=

, ) ˜
d
z
m h m e m
L

˜(

h
m
L

(

L

f

z
, )

1

-Ú 1

  

˜
h
(
e m
  
m
L

f

z
, )

( ) ˜
h z s
m
L

(
m
h

=

Æ

m

f

),

h
˜ (
e m
g

f

)

=

h z
(

) ˜ (
s
g

g

m
h

Æ

m

f

)

5   Discrete photon inclinations

We now discretize the photon inclinations  m Œ -(

, )1 1 . This must be done carefully, in

order to preserve energy balance. We use two different methods. Which of the two is used

matters little in practice, but does matter in high precision tests.

Photon inclination sectors: Partition the interval   (

-1 1   into   N

, )

J

=

N

D

N

U

  sectors  Dmj :

+

        

(

-

,

,...,

1 1
, )

=
(
m m m
j

(
m m m
N
1
),

=

,

0

1
-

j

j

D

),

J

m
0

1
,
= -

m
N

D

=

0
,

m
j

=

1
2

(
m
j

+

m
j

1
-

),

j

=

1 2
,

1

=

  

J

m
N
,...,

N

J

(38)

(39)

(40)

(41)

(42)

10

where  mj   are mean inclinations. Note that no sector straddles m = 0 . We write   j DŒ   if

mj > 0   is downwards, and  j UŒ   if  mj < 0   is upwards. Denoting

ˆ
m m m
D
j

-

∫

j

j

,

1
-

2
m m m
D
j
1
-

-

∫

2
j

2
j

ˆ ,
2
m m
D
j
j

=

2
ˆ
m
D
j

∫

2
m
D
j

we note that

      

m

j

m

j

1
-

Ú

0

d
m m

=

Ú

D

m

j

1
ˆ
d
m m

=

Ú

0

d
m m

=

1
2

ˆ
m m m
D
j

D

=

2
j

j

ˆ
d
m m
1
-

Ú

=

Â

j D U
Œ

or 

Ú

D

m

j

ˆ
d
m m

=

1
2

Â

j D U
Œ

or 

2
ˆ
m
D
j

1
2

=

( )
a

( )
b

Discretized LTE:  Both of our two discretization methods yield the discretized LTE

f

m

d
dz
ˆ ˜ (
I
m
  

f

f

˜ ( )
I
z

f

= -

G

f

( ) ˜ ( )
z I
z

f

+

˜ ( ) ˜
I z S
i
i

( )
z

+

f

Æ

˜ ( )
z
E

f

z

g

)

=

Â

i D
Œ

˜ (
I z
i

g

) ˜
s

g i
,

Æ

f

g f
,

(

f U
Œ

)

i

Â
˜
e

+

where   i f

,

= 1 2
,

,...,

N J

, and, using notation (5), i.e.,  f

(

)
m
D

∫ Ú

D

m

d f
)
(
m m

:

˜ ( )
z
I
  

f

∫

˜(
I

D

m

f

, ),
z

˜ ( )
z
E

f

˜ (
E

∫

m
D

f

, ),
z

˜
e

g f
,

˜ (
e m
D
g

f

∫

)

As to   Gf ,  ˜Si

fÆ

  and   ˜ ,sg i

fÆ , they depend on which discretization method is used.

Method 1: We here assume that   ˜( , )

I

zm   varies little within each sector   Dmj , hence is

approximately equal to its mean value within the sector, that is:

    ˜( , )
z
m

I

ª

ˆ
-D
m
j

1

˜(
I

D
m
j

z
, )

       if    m mŒD j

Thereby,  ˜( , )

I

zm   can be taken outside integrals over   Dmj , so that for any   f (

)m :

1

Ú

1
-

˜( , ) (
z f

d I
m m

)
m

=

˜( , ) (
z f

d I
m m

)
m

ª

˜(
I

D
m
j

z
, )

1
ˆ
-
D
m
j

f

(

D
m
j

)

Â

j

ÚÂ

j

D
m

j

Integrating then the LTE (22) over  Dmf , and using  (44) and (48), we obtain (45) with

j

G
˜
s

( )
z

=

,
g j

Æ

f

=

1
ˆ
(
-
m
D
G D
j
1
ˆ
˜ (
s
-
m
D
j
g

, ),
z

m
j

m
D
j

Æ

m
D

f

)

˜
S

j

Æ

f

( )
z

1
ˆ
-
m
D
j

=

˜(
S

m
D
j

Æ

m
D

f

, )
z

(43)

(44)

(45)

(46)

(47)

(48)

(49)

where, e.g.,  ˜ (
g

s

D

m
i

Æ

m
D

f

)

∫

Ú

D

m
i

d
m
i

Ú

D

m

f

d
m m m
i

˜ (
s
f g

Æ

f

)

, by (5). Obviously, (47) applies best to

the diffuse radiance   ˜ ( , )
z

I

d

m . It is exact if radiances are semi-isotropic,  ˜( , )
z
m m± >

I

˜ ( )
I
z
±=0

, as in

our analytical models in Ref.[2]. Hence this method will be used in tests using these models.

11

 Method 2: We here ascribe to the sharp direction  mj   all the radiance within   Dmj , so that

˜( , )
z
I
m

=

Â

j

˜ ( ) (
z
I

j

-
d m m
j

),

˜ ( )
z
I

j

=

˜( , )
z

d I
m m

ÚD

m

j

Substituting this into (22), and integrating over  Dmf , yields again (45), with this time:

( )
z

=

j

G
˜
s

, ),
z

(
m
G
j
˜ (
s
g

g j
,

Æ

f

=

m
j

Æ

m
D

f

)

˜
S

j

Æ

f

( )
z

=

˜(
S

m
j

Æ

m
D

f

, )
z

In this method, photons effectively have only discrete inclinations  mj .

In view of (6), there is little difference between (49) and (51), so that using method 1 or 2

matters little in practice. It matters only in high precision tests.2

Energy balance: In both methods 1 and 2, the vertical fluxes (30) become, either by (48) with

f (

ˆm m= , or by (50):

)

z
( )

D
  

=

Â

j D
Œ

ˆ
m
j

˜ ( ),
z
I

j

U

z
( )

=

Â

j U
Œ

ˆ
m
j

˜ ( )
z
I

j

In particular, the incident diffuse skylight is, by (44)(b):

d
j D
Œ

(

z
0

)

=

d
2
D
0

ˆ ,
m
D
j

˜
I
  

d
D
0

=

Â

j D
Œ

ˆ
m
j

˜ (
I

d
j

z
0

)

d
2
D
0

=

ˆ
ˆ
m m
D
i
i

Â

j D
Œ

The absorption and emission rates (28) become

z
( )

A
  

=

Â
where, depending on the discretization method:

Â

=

j

j

j

E

z
( )

˜ ( )
I

z A z
j

( ),

˜ ( )
z
E

j

(50)

(51)

(52)

(53)

(54)

(55)

1
ˆ
-
m
D
i

(

A

A

or

, )
z

( )
A z
i

m
D
i

∫ {

} =
Summing the discretized LTE (45) over  f , using (52), yields the continuity equation (29),
˜Si
ÆÂ

= G   exactly if there is zero absorption.

ensuring energy balance. In particular, 

G
i

-

(
m
i

, )
z

( )
z

( )
z

i

f

f

f

f

˜
S
ÆÂ
i

Sunlight: In general, as already said, it is much better to compute accurately first-scattered

sunlight, and treat that as an ‘emission’. Let us now show why more explicitly. Let   Dmjh

  be the

                                                  

2   Note, alternatively, that (45) also follows from assuming either   f

(
)
  inside   Dmj , or
m
, for  f  equal to  m, G, S  and  sg. This imposes no condition on   ˜( , )
zm ,
I

D
m
j

ª

)

(

f

1

ˆ
-D
m
j

=

(
)
m

f
-
but is an overly coarse approximation in the case   f (

f
(
Â D

m d m m
j

) (

)

j

j

)m m= .

12

(56)

(57)

sector containing sun rays, m

ŒD
mh
jh

. In general  m mj

h π

h

. Suppose now that we lump the

incident sunlight together with the incident skylight within  Dmjh

, so that by (53):

˜ (
I
j
  

h

z
0

)

=

˜(
I

m
D
j

h

,

z
0

)

=

ˆ
2
mD
D

d
0

j

h

h
0

+

Observe, however, that this implies, by (52), a vertical sunlight flux  mjh

h0 , instead of the actual

flux mhh0 , so that the number of photons entering the canopy (per second per unit horizontal
area) is altered. To maintain the proper sunlight flux, one may use, instead of (56):

˜ (
I
j
  

h

z
0

)

2=

ˆ
D Dm

d
0

j

h

+(

m m
h
j

h

h
0

)

But still, sunlight gets attenuated as if its inclination was  mjh
left of (45). Also, the angles of incidence of sunrays on leaves and ground, hence   G,  ˜S ,  ˜sg , are
altered. Moreover, for consistency, the substracted sunlight in (36) should really be taken as
˜ ( )
z
I

, due to the term  mf

) so much larger than

z
( )

dz

(

)

h
xm0

= m m
h
jh

, for the exact  xmh
z( ), actually produced by integrating the LTE (45), that   ˜ ( )
z

z( )  might be (if  m mh
jh

>

I

˜ ( )
z
I

  could end

z
( )

  on the

jh

h

d
j

h

=

j

h

h
- 0xm

h

xmjh

˜
fdI

up negative. All this tinkering can entail sizable errors, since sunlight is so intense. This is why

we prefer to treat first-scattered-sunlight, computed accurately, as an ‘emission’.

 

The above problems do not occur in the exceptional cases that  m mh
jh

=

, if we use discre-

tization method 2, for the coefficients (51) with   j

jh=

  are exact for sunlight if  m mh
jh

=

 (unlike

(49) which are averages over   Dmjh

). We shall in fact assess how accurate our ‘first-scattered-

emission’ treatment of sunlight is, by comparing its numerical results, for m mh
jh

=

, with the

results obtained by lumping sunlight with skylight as in (56), and using (51).

6   Matrix form of the LTE

We next express the discrete LTE (45) in the matrix form

d
dz

J

f

z
( )

= -

G z J
( )
f

f

z
( )

+

H z J z
( )
( )

fi

i

E z
( )
f

+

J

f

(

z

g

)

=

Â Œ

i D

R J z
(

g fi
,

i

g

)

+

(

f U
Œ

)

i

Â
e
g f
,

a
( )

b
( )

(58)

We will consider two versions of (58): One where   J zj ( )  are equal to the fluxes   ˜ ( )
zj

I

, the other

where   J zj ( )  are equal to the vertical components   ˆ ˜ ( )

jI

mj

z   of these fluxes. We start with the

latter case.

13

Vertical fluxes: Dividing (45) by   sgnmf , we obtain (58) with (v  stands for ‘vertical’):

v
( )
J z
j

ˆ
m
j

=

˜ ( ),
I
z

j

v
( )
G z
j

1
-
m
j

G

j

=

( ),
z

v
( )
E z
f

(sgn

=

) ˆ
m m
f
i

(sgn

v
( )
H z
fi
  
v( )  are vertical fluxes, and   ˆGi

˜
1
-
S
i

( ),
z

Æ

f

v, ˆH fi

Here,  J zj

R

v
,
g f i

ˆ
m
i

=

1
-

˜
s

,
g i

Æ

f

=

,

f

m
v
e
,
g f

) ˜ ( )
z
E

f

˜
e

=

,
g f

v   are interception and scattering probabilities per

unit vertical distance3. Indeed, the probability for a photon  i  to get scattered into direction  f

l
while travelling a vertical distance   dz , hence an oblique distance   d

=

dz

≥m 0, is given by

i

˜
S
i

f

Æ

l
d

˜
S
Æ=
i

f

dz

m
i

=

ˆ
v
H dz
fi

. The probability of absorption per unit vertical distance, and the

total absorption per unit volume, are, by (54)-(55):

v
i

( )

ˆ ( )
A z G z
=
  

v
i

-

Â

f

ˆ
v
( )
H z
fi

1

ˆ
-m

i

=

A z
i

( ),

A

( )
z

=

Â

i

( )
A z J z
( )

v
i

v
i

(note that  G H E

,

,

v
fi

v
f

v
f

  are negative if  mf < 0   is ‘up’). The total vertical photon fluxes (38) are

z
( )

D
  

=

Â
The first-scattered-sunlight emission vectors are, by (41):

Â

j D
Œ

j D
Œ

=

+

( ) ˆ ,
h z
m
h

J

,
d v
j

z
( )

v
J z
( )
j

U

z
( )

=

Â

j U
Œ

v
J z
( )
j

  

E

,
h v
f

=

(sgn

m

f

) ( ) ˜(
h z S

m
h

Æ

D
m

f

, ),
z

,
h v
e
g f
,

(
h z

)˜ (
s
g

g

=

m
h

Æ

D
m

f

)

Oriented fluxes: Let us now rather divide (45) by  mf . This yields again (58), but with

( )
J z
j

=

˜ ( ),
I
z

j

( )
G z
j

1
-
G
m
j

j

=

( ),
z

( )
E z
f

=

m

1
-
f

( )
H z
fi
  

=

m

1
-
f

˜
S
i

f

Æ

( ),
z

R

,
g f i

ˆ
m

1
-
f

˜
s

=

,

,
g i

Æ

f

f

˜ ( )
z
E
ˆ
1
˜
-
m e
f

,
g f

e
,
g f

=

where   J zj ( )  are now oriented fluxes. We then have, instead of (60)-(62):

( )
A z
i
  

=

Â

f

z
( )

D
  

=

Â

f

ˆ
ˆ
G
(
m d
i
ˆ
m

J

f

f

f D
Œ

ˆ
H

-

fi

fi

,
)

A

( )
z

=

Â

i

( )
A z J z
( )

i

i

z
( )

=

Â

f D
Œ

ˆ
m

f

J

d
f

z
( )

ˆ
m
h

+

h z

( ),

U

z
( )

=

Â

f U
Œ

ˆ
m

f

J

f

z
( )

E

h
f

=

m

1
-
f

( ) ˜(
h z S

m
h

Æ

D

m

f

, ),
z

h
e
,
g f

ˆ
m

=

1
(
h z
-
f

g

)˜ (
s
g

m
h

Æ

D
m

f

)

Note that   G Gj

=

v
j

  and   H

v
fi

= m m
f
i

H

, so that   A G
i

=

fi

v
i

- Âˆ

f

m m
f
i

ˆ
H

.

fi

(59)

(60)

(61)

(62)

(63)

(64)

(65)

(66)

                                                  

3  Note that these probabilities per unit vertical distance may be large in grazing directions (mi  close to

zero), with long oblique paths through   dz .

14

Discussion: Since the matrix equation (58) represents vertical ‘evolution’, it is not surprising that

quantities in the ‘vertical’ version (59) are simpler and have more direct physical meanings.

Hence its use in Ref.[1]. However, if we intend to compute absorption rates by individual leaves

(rather than by layers), which involve the oriented fluxes, then we may as well use the ‘oriented’

version (63). In any case, it does not matter much which version is used. In fact, the minuscule

relative differences (less than  10 13-   in our tests) between numerical results obtained using either

(59) or (63) provide useful estimates of numerical accuracy. Apart from such tests, we mostly

use (63) in our computations.

Down-up block form: Separating out the vector   J( ) { ( ),

z

j

=

J z
j

= 1 2
,

,...,

N

}

, see (42), into

J

subvectors   D( ) { ( ),

z

J z
j

j

=

= 1

,...,

N

}

z
  and   U( ) { ( ),

J z
j

D

=

j N
=

D

+ 1

,...,

N

J

}

  of ‘down’ and

‘up’ fluxes, we rewrite (58) in the ‘down-up’ block form

D

U

( )
z
ˆ
˜ =
( )
z
¯

Ê
Á
Ë

Ê
Á
Ë

M

M

DD

UD

( )
z
( )
z

∂
z
∂

M

M

DU

UU

( )
z
ˆ
˜
( )
z
¯

D

U

( )
z
ˆ
˜ +
( )
z
¯

Ê
Á
Ë

E

D

E
U

( )
z
ˆ
˜
( )
z
¯

Ê
Á
Ë

,

     

J

( )
z

=

D

U

( )
z
ˆ
˜
( )
z
¯

Ê
Á
Ë

(67)

U

(

z

)

g

=

R D
g

(

z

g

)

+

E
U

(

z

g

)

where   M H G

- . These were our starting equations in Ref.[1].

=

7   Lambertian scattering and emission

Scattering and emission of light will henceforth be assumed purely Lambertian.

s
)
e±

Lambertian optical coefficients are, for a horizontal leaf (see section 2):

(
W

i

Æ

W

f

)

=

1
p

sgn

m
i

, sgn

m

f

,

(
e
W

f

)

=

)
ˆ ˆ
mm s
i
f

)
ˆ
m e
sgn
f

1
p

m

f

where  

  are total numbers of photons emitted (per second per unit area), and  

total fractions transmitted (reflected). The absorption coefficients are

(
  a
W

i

)

=

1
∫ -

sgn

m
i

sgn

m
i

,

+

sgn

m
i

,

-

,

)
s

)
s

-

)
a

a

(
W

i

)

=

)
ˆ
m a
i

sgn

m
i

Similarly, Lambertian coefficients for the ground surface are

sg

a
g

i

(
W
(
W

i

Æ
)

=

f

W
)
a
g

)

1
p

=
1
= -

)
ˆ
ˆ
m m s
f
i
)
s

g

,

g

e
g

(
W

f

)

=

1
p

)
ˆ
m e
f
g

(68)

)
s± ±

)
ms±

 (

)  are

 (69)

(70)

For an inclined leaf, the coefficients may be written, using notation (1) (u  stands for + or -):

15

s
W

L

(
W

i

Æ

W

f

)

=

1
p

,
u u
i

f

=±

,
u u
i

f

WW WW WW WW
u
i

◊

◊

L

i

f

L

u

f

e
W

L

(
W

f

)

=

1
p

Â

u

f

=±

( )
z

,

u

f

L

WW WW
◊
f

L

u

f

)
s

Â
)
e
W

(71)

(72)

(73)

(75)

where  

, ( )
z
±

  is allowed to depend on   W L   and  z, since the temperature of a leaf depends in

)
eW L

general on its orientation and position, and so does first-scattered sunlight.

jjjj----integrated coefficients: The  jf -integrated, jL-averaged coefficients (24) now become :

˜
s
m
L

(
m m

Æ =
f

)

i

2

)
s

=±

g

u
i

(
,
m m
i
L

)

g

u

f

u u
,
i

f

˜
(
e m
m
L

f

, )
z

2

=

( )
z g

(
,
m m
f
L

),

u

f

,

u

f

Â

f

,
u u
i
)
e
m
L

Â

u

f

=±

)

(
,
m m
f
L
)
e
m
L

,
±

( )
z

1
2
p

∫

p

Ú

-p

)
d
j e
L
W

( )
z

,

±

L

where   g

±

  are defined in (9). The j-integrated ground coefficients are

  ˜ (
sg

m m

Æ = 2
)

i

f

,              ˜ (

e m
g

f

g

)

= 2

)
ˆ ˆ
mm s
i
f

)
ˆ
e m
g

f

Discretized canopy coefficients: In view of (20),(23) and (72), we have, using (5):

(
G D

m
i

, )
z

˜(
S

m
D

i

Æ

1

1
-

=

Ú
m
D

˜(
d
m h m
L
L

, ) (
z g

, )
z

f

=

2

u u
,
i

f

=±

)

1

,
m m
D
L
i
)
s

u u
,
i

f

Ú

1
-

1

Â
)
em

˜ (
E
   

m
D

f

, )
z

2

=

Â

u

f

=±

,

u

ff

L

( )
z

d

˜(
Ú m h m

1
-

L

L

, )
z g

(

,
D
m m
f
L

)

u

f

˜(
d
m h m
L
L

, )
z g

(

,
m m
D
L
i

)

g

u

f

(

,
m m
D
L
f

)

u
i

(74)

The coefficients (49) (method 1) follow directly from (74). The coefficients (51) (method 2) are

given by (74) but with   Dmi   replaced by  mi. All these  g  functions are known analytically (see
Appendix B). The integrations over  mL   in (74) will be done numerically by putting

˜(
h m
L

, )
z

=

c

L

˜(
, ) (
z
h m d m m
L

-

L

L

)

 

Â

L

where the discrete leaf inclinations  mL , and the coefficients  cL , depend on the numerical
integration rule chosen. Note that (75) corresponds to a definite physical model, with discrete

leaf inclinations, for which the canopy scattering coefficients are known very accurately, whence

the possibility of high precision tests.

Discretized ground coefficients: In view of (73), we have   ˜

  in both discreti-

zation methods 1 and 2, since by (44),  D

1
ˆ
-
m
i

f

(

m
D
i

)

=

f

R

,
g f i

ˆ
m

1
-
f

˜
s

=

,
g i

Æ

f

=

)
ˆ
ˆ
2
m m s
D

f

i

,

g

e
,
g f

ˆ
˜ (
m e m
g

1
-
f

D

f

=

)

=

)

ˆm m= . Hence, by (63):
  if  f (
)
ˆ
m e
D
f
g

(76)

2

,sg i

)
ˆ ˆ
Æ = 2mm m sD
i
ˆ
(
)
=
m m
i

ˆ

i

f

f

f

g

16

)
Also, the second line of (29) becomes, using    
a
g
)
D
a
g
g

ig
   
since      A
v
rather work with vertical fluxes, using (59), then    Rg f i
,

)
a   if    a

= -1
)
s

)
e
g
)
a
g

D U
-
g
g

)W ∫
(

D
g
g

D
g
g

U
g

or

=

=

=

-

=

g

g

i

)
s

+

  by (70):
g
)
e
g

 (alternatively, sum (58)(b) over   f UŒ   and use (43)). If we

)
ˆ= Dm s

2
f

v
  and   eg f
,

g

)
ˆ= Dm e

2
f

.

g

(77)

8   Black leaves

‘Black’ leaves, which emit no light and absorb all the light they receive, provide an

especially simple test case. We will use the following notations (with   z
1

2<   always):

z

z
( )

h

=

˜(
d
m h m
L

L

z
, ),

˜(
l m
L

z
, )

˜(
h m
L

=

z
, )

z
( )

h

dz

h

z
( ),

L

z
( )

=

L

(

z z
0

, ),

L L
=

(

z

g

)

=

L

(

z z
,
0

g

)

  

(78)

1

1

-Ú
)

=

z

2

Ú

z
1

(

z z
,
2
1

L
  

z z1
,

h( )z   is the total leaf area density at  z, while   ˜(
2   is the leaf area index (LAI) of layer  (
  L(
)
horizontal area).   L( )z   is the LAI above height  z, and    L   the total LAI of the canopy.
General solution: With non-emitting totally absorbing black leaves, the canopy scattering and

l mL z   is the distribution of leaf inclinations.
z z1
,

2  (the total leaf area within the layer, per unit
)

, )

emission terms vanish, so that the LTE (22) has the solution

˜( , )
z
I
m

=

˜( ,
I

z
m x
0
m

)

( ),
z

( )
z

x
m

∫

x
m

(

, )
z z
0

x
m

(

,
z z
2
1

)

e

∫

-

L

m

(

z z
,
1

2

)

,

L
m

(

,
z z
2
1

)

∫

dz

( , )
z
m m

G

z

2

Ú

z
1

Observe that  xm
distribution  ˜(

( )z < 1  (attenuation) if m > 0, and  xm

( )z > 1  (amplification) if m < 0. If the

l m
L

, )
z ∫

˜(
l m
L

)

  is uniform in  z, then  ˜(

h m
L

, )
z

( ) ˜(
z
h l m
L

=

)

, so that by (12):

G

z
( , )
m
(

z
( ) (
)
=
h g m
z z
z z
,
,
(
)
2
1
2
1

L

=

L
  
m

) (
)
g m m

,

where

(
)
g m

d

1
2

∫
p Ú
)
(
g m
≥

W
0

˜(
l m
L

)

L

WW WW
◊
L

Now, g m(

)  and  xm( )z   can be calculated analytically for some special distributions  ˜(

)l mL   of

leaf inclinations, namely, using (8) (see also II-(32-35)):

Horizontal (hz):   

˜(
)
=
l m d m
L
  

(

L

),
1

-

ˆ,
)
g m m

=

(

xm

( )
z

e
= -

L

( )sgn
z

m

Semi-isotropic (s-i):    

˜(
l m
L
  

)

=

(
m

),

Q

(
)
g m

=

1
2

,

xm

( )
z

= -
e

1
2 L

( )
z

m

Erect:       

˜(
)
=
l m d m
L
  

(

L

),

(
)
g m

=

2
p

sin ,
q

xm

( )
z

e

=

2 L

- p

( )sin
z

q m

(79)

(80)

(81)

(82)

(83)

17

(note that  g  is dimensionless, as are    L   and   L). We see that in the semi-isotropic and erect

cases, grazing ‘down’ light (small m > 0) hardly penetrates the canopy, while amplification of
‘up’ light (m < 0) blows up as  m Æ - 0 (since oblique distances   Dz ˆm  through horizontal
layers   Dz  become infinite). Thus, the LAI by itself is not a reliable indicator of optical
thickness.

Transfer matrix: As just seen above, xm( )z   may blow up as  m Æ - 0.  But of course, the
mj   have a finite minimum   ˆ
discrete photon inclinations   ˆ
m
z( ),  j
,...,
N J

, are in fact elements of the transfer matrix

(42). The discrete values  xmj

, where   j

ˆ
m= j

= 1 2,

min =

N D

min

min

± 1, by

Tblack z z
( ,

)0 , which is diagonal since here there is no scattering, so that   H = 0   in (58):

black

Tij

(

,
z z
1
2

)

=

d
ij

e

-

L

j

(

z z
,
1

2

)

,

L

j

(

,
z z
2
1

)

=

dz

G

j

( )
z

m
j

(

z
2

>

z
1

)

     

(84)

z

2

Ú

z
1

If   ˜(

l m
L

, )
z ∫

˜(
l m
L

)

  is uniform in  z, then by (80):

(

,
z z
2
1

)

=

L

(

,
z z
2
1

)
g m
j
j

,

  L j

g

j

(
g m
j

∫

)

≥

0

(85)

Thus,  ˆ
L

j

ˆ
L

£

max

ˆ
L

∫

j

min

  and   ˆ
black
T
ij

T

black
max

£

∫

ˆ
L

e

j

min

  are bounded. But   Tij

black   can still be very

large if    L >> 1, especially in grazing directions (small  ˆ
realistic canopies (with   H π 0 ) to likewise contain large elements (positive or negative since
M G H
= - +   has elements of both signs), as is indeed found to be the case. This is what

mj ). We therefore expect  T  for thick

motivates our use of ‘medium’ layers in TTRG.

Part II   LAI of medium and thin layers, and numerical integration errors

This part concerns some estimates. Section 9 estimates the appropriate LAI for the

‘medium’ layers used in TTRG. Section 10 estimates the errors due to the numerical integration

(over z) of first-scattered-sunlight ‘propagated emissions’. Section 11 estimates appropriate LAI

for the ‘thin’ layers in iterative integration. All these estimates are done for a specific value of

ˆ
minm , corresponding to   N J = 18  photon inclination sectors of  10∞  each ( N

ND
U=

= 9), so that

m
0

,
1
= -

m
1

cos

170

, ... ,

m
18

= -

m
1

=

(
1

+

cos

)
∞ ª

∞
10

=
1
2

,
0

=
m
9
,
0 992
.

m
10
...,

=

cos

80

, ... ,
∞

m
17

cos

,
10
∞

=
cos

1
2

80

∞ ª

1

=

 

m
18
1
.
11 5

m
10

= -

m
9

=

(86)

or  q18

ª

.
7 06

, q10

∞

ª

.
85 02
∞

. Since   ˆ

minm

m= 10   and   ˆ

maxm

m= 18 , we have

18

ˆ
m

min

ª

1
11 5
.

,

ˆ
m

max

1
,

ª

1
ˆ
-
m

∫

1

ˆ
m

max

ˆ
m

-

min

ˆ
m

max

Ú

ˆ
m

min

d
m m

ª -

1
0 9
.

ln ˆ
m

min

ª

2 8
.

(87)

where the mean  

ˆm-1   of   ˆm-1  will be needed below.

9   Medium layers

           TTRG requires ‘medium’ layers whose transfer matrices are free of overly large elements.

Ref.[1] gave an ‘automatic’ way of constructing these ‘medium’ layers, by successive accretion

of ‘thin’ layers. However, it is more convenient to build them ‘by hand’, by estimating an

appropriate LAI. This will here be done by reference to ‘black’ leaves.

In general, we expect transfer matrix elements, for ‘medium’ layers of LAI  

  L m , to be

bounded by   T black

max ~10nm , where, in view of (81)-(85):

~ log

10

L

max

e

L

m

(log

10

ª

e

ˆ
)
g m

min

ª

n
m
  

1
2.3

L

m

.
2 5

L

m

Ï
Ô
Ì
ÓÔ

(
)
horizontal  (hz)
(
)
semi - isotropic  (s - i)

(88)

(since g m= ˆ   for hz, and  ˆ
precision), then transfer matrix elements are precise to about 15 digits. Now, according to Eqs. I-

1
2   for s-i). If the computer carries  15  digits (in double

11 5 , g =

m ª
min

1
.

(22), transmission-reflection (TR) matrices (whose elements are numbers between 0 and 1)

involve substractions of transfer matrix elements (of size ~ 10nm ), hence are precise to roughly
15 - nm   digits. Thus, if we want a precision 10 6- , say, then we need  15
hence  

  for s-i. We get nonsense if   nm > 14 , i.e.,

, or   nm ª 9,

  for hz, or  

.
9 2 3 20

ªnm

.
9 2 5

.
3 5

ª

ª

-

6

  L m ª ¥

if  

  L m > 32  for hz, or   Lm >

  for s-i. Realistic canopies tend to have s-i leaf

inclinations. We indeed find that for realistic canopies of LAI beyond about 5, the

  L m ª
.
.
14 2 5 5 5
ª

straightforward transfer matrix method (see section I-4) yields negative values in the fluxes  U0

reflected by the canopy. We will therefore use ‘medium’ layers of LAI between  1  and  3, except

in numerical tests done with canopies of horizontal leaves.

10   Errors due to numerically integrating the propagated ‘sun emissions’

 

If first-scattered sunlight is treated as an ‘emission’, then TTRG requires the ‘propagated

emissions’ for medium layers  (

z z1
,

2 , namely
)

z z
,
1
2

)

=

(
f
  

z

2

Ú

z
1

dz

T

(

z z
, )
2

E

h

z
( )

=

d

(
L L L

T

,

)

e

2

h
0

e

Lg m m
h
h

)

(

-

L

2

Ú

L
1

(89)

where we assumed, for the present purposes, that   E

( )
z

( )
z

, see (66),(23) and (85),   

h

( )
e
z

=h

h
x0
h

19

depends on  z  only through  h( )z   and

( )
z

∫

xm

h

(

, )
z z
0

e
= -

  x

h

L

( ) (
z

g m m
h
h

)

(90)

z
L( )
  

=

z

Ú 0

z

dz

h ,
z
)
(
¢
¢

Also, we replaced the integration variable  z  by the dimensionless variable  

z dz

L =h( )

. The integral (89) is evaluated numerically using Simpson’s rule, with a step

so that    d
size    l  in    L . We here estimate the error in doing so. Because iterative integration amounts to
using the trapezoid rule, we will also give in square brakets the corresponding errors. The

Simpson [trapezoid] error is  ~    

1
90

4

Lm Ml

1
12

 [    

4

2

Lm Ml

2

], where  

∫

L

2

L

1

-

L
m
  

z

2

= Ú

z
1

dz

h( )  is the

z

LAI of the medium layer  (z1, z2) , and  Mk  is a bound on the kth derivative of the integrand [7,8].

Thus, the relative Simpson error (RSE), and the relative trapezoid error (RTE), namely the errors
divided by the value of the integral, taken as roughly equal to    M m0L , are given by

 RSE

~

1
90

4

l

M M
4

0

Simpson),
(

RTE

~

2

l

1
12

M M
2

0

(

trapezoid)

(91)

Now, with horizontal leaves we have  g m m(
T T~ black , are of the form    e± L , so that   M Mk

)

0

= 1, so that the exponentials in  xh z( ), and also in

1~ . In the (more realistic) semi-isotropic case,

(

)

1
2

=

1, so that  xh z( )  if  mh ≥
-
g m m m
again behave like    e± L , hence   M Mk

0

1
2 , and also  T  for the dominant non-grazing directions,

1~ . But for small  mh , the  z  dependence in the s-i case

is dominated by the rapidly decreasing  xh z( ), so that   M Mk
in summary we may put:

~ (

k

1
2

1

)m-

h

0

, by (90) with  g =

1
2 . So

RSE

~

4

l

1
90

RTE

~

2

l

1
12

(

horizontal leaves,  and s - i  if 

m
h

≥

1
2

)

RSE
 

~

1
90

(

1
2

l

[
m
h

4

)

]
1
~ (
12

RTE

[

l

1
2

2

)

m
h

]

(
s - i  leaves if

m
h

<

1
2

)

(92)

11   Thin layers in iterative integration

Iterative integration (see section I-12) is done using  N  ‘thin’ layers of LAI    l. The

transmission-reflection matrices and emission vectors for these thin layers are treated to first
order in   l. The resulting errors, and acceptable values of   l, will now be estimated.

l
Consider a vertically uniform canopy of total LAI    L , so that    

∫ L N . Treating the
iteration equations I-(47) to first order in    l  amounts to assuming that a photon scattered or

emitted by a leaf element inside a thin layer has negligable probability of hitting another leaf

before exiting the thin layer. This probability is ~  (

l

)

1
2

ˆ

g m   (since the mean vertical distance

20

out is    1
2

l). Putting this equal to  0.1  say yields    l ~ .0 2   for horizontal leaves (g m= ˆ ), and

l

1
4

1

ˆ
m- ª

.
2 8
4

l

.
0 1

, hence    l ~ .0 1, for semi-isotropic leaves (g =

ª

1
2 , and  

1

ˆ
m- ª

2 8   by (87)).
.

Now, as was argued in section I-12, when treated to first order in    l, transmission matrices are

too small, and reflection matrices too large. Thus, since in realistic canopies photons undergo

numerous back and forth transmissions and reflections through the various thin layers, single thin

layer errors are of both signs, hence do not accumulate. Indeed, computer experiments on
‘realistic’ canopies (with s-i leaves) indicate that using    l

  is usually adequate (the

ª 0 1.

precision of iterative integration is here inferred by comparing with TTRG results, or by
examining convergence as    l
errors in the radiances at the bottom  zg  of the canopy are between 1 and 5%  if    l
about 10 times less if    l
 (the error seems roughly linear in    l). However, errors are much
larger in the case of grazing sunlight (very small mh ) 4, and are roughly as given inside the square
brackets in (92), since iterative integration in effect numerically integrates the first-scattered

Æ 0 ). For instance, for an s-i canopy with    L = 10, the relative
, and

= 0 01.

= 0 1.

sunlight ‘emissions’ with the trapezoid rule. With  mh = 0 01.
 l

, and err by 0.5 to 2% if   l

.

= 0 01.

= 0 1.

  for instance, results are way off if

In some artificial situations, however, thin layer errors do accumulate, for instance in the

case of black leaves, where there are no back and forth reflections:

Black leaves: Denote lj

∫ L

j N

, where   L

∫
Lj

j

(

,
z z
0

g

)

  is for the whole canopy. With black

leaves, the canopy reflection matrices  r, rrrr  are zero, while the transmission matrices  t, tttt   are

just the transfer matrices. Applying (84) to thin layers   (

z z1
,

2 , we get iteration equations
)

D t D
=

n

,

n

1
-

U

N

R D
g

N

,

=

U

n

1
-

=

tt

U

,

n

t

ij

=

t d
=
ij

ij

-
l
e j

(see section I-12) where

    l

j

∫

L

j

N

l
g m
j
j

,

=

L

j

∫

L

j

(

,
z z
0

g

),

l

L

∫

N

(93)

(94)

Thus,  D

N

=

N
t D

0   and   U

N

0 = tt

U

N , that is,  D z
(

j

g

)

- L
(
e D z

j

j

0   and U z
)
(

j

)
0 =

=

- L
(
e U z

j

j

g

)

, as in

(79). Here, t  and  tttt   are exact. We now estimate the error done in treating  t  and  tttt   in (93) to
                                                  

4  Note that in general the weight of small   ˆm  (excluding  mh ) is small on average, because most of the
diffuse light reaching down travelled nearly vertically (along paths of shortest  Dz ˆm), after having
been scattered by leaves higher up.

21

first order in    l. For a single thin layer, approximating   el

= + +

2
1
l l
2

1

...

+ ª +

l

1

  implies an

2
1
ª
l1
2

error  d
(93) to first order in    l  amounts to approximating   e

  (we omit subscripts  j). However, single layer errors accumulate. Indeed, treating

-

L

e N
l
-=

N

ª -(

l1
)

, resulting in a relative

error (i.e., the error divided by the radiance    e- LD0 ) given by, in view of (A.1):

d
2

∫

L

-e

1
- -(

)
l

N

L

e

1
2

2
L

ª

N

1
2

=

l

L

=

1
2

N

2
l

=

N

d
1

(
l

=

L

N

)            

(95)

Let   N z  be the number of thin layers above height  z . Now it may happen that when  Nz  is large

enough that  d

2

( )z

=

1
2

N z

2
l

  is sizable (for a given l), the attenuation   e

-

-∫L

e N z

l   is already so

strong (hence radiances so small) that errors are irrelevant. So what really matters here is the

error relative to the incident flux    D0  (not relative to    e- LD0   as in (95)), namely
)
e
L L

LL . Since   (

= -1
(

d d

, the maximum of   L Le-   occurs at   L = 1,

e
)

L

e

e

1
2

L

L

-

-

-

L

∫
d d
2
3

=-
and is  1 e. Hence

l

  d l
ª
3

2

e

l

= (

2

e

ˆ
)(
g m

1
.
5 4

l
ˆ
g m

) ª
2 , so that    d

1

For semi-isotropic leaves, g =
to  d3 ª l (for   ˆ
g m= ˆ , so that    d3
 l

m m=

1
5 4ª .

ˆ min

  implies    d3

ª 0 1.

ª

~

1
4

1

-e l

1
4

ª

3

l

1
11

ª

ˆ
m
l

ˆ   ranges from    d3
m

l (for  ˆm = 1)
, by (87). For horizontal leaves,

1
11ª

l

1
.

11 5 ), with a mean   d

ˆ
ª-
=
m
l. So one may take, in general,   d3
4~ l  (for black leaves). For instance,
l

1
11

ª

1
4

1

3

1

. %
2 5

. 5

Remark: We will encounter in section 14 light trapping situations where radiances increase down

(96)

the canopy, and errors again accumulate, so that the relevant error is given by  d2, and much
smaller    l  must be used. For instance, (94),(95) with g =
ˆm £ 1), so that if    L = 8, say, and we use    l

, then  d2 10> %.

2   yield     d

ª 0 1.

2
ˆ
m

  (since

L

L

>

ª

l

l

1
8

1
8

1

2

                                                  

2

1

5  We should check that using  d2
here. With  g =
For   N > 5, the correction   N
smaller than  d2
=

ª
, we have    N =
-(
) = -
N , their ratio being   10
24

l ˆ
1
ˆ
-
l g m m
2   in (A.1) (with   x =
N - < .

2 1
-
8
1
-

L N

ª 0 1.

2 ,   l

=
N

1
12

5
24

ª

=

5

1
-

1
3

1
2

1
2

1
2

-

1

2

1

-L N   is valid for   L = 1  and the values of   N = L l  involved
ˆ< <m .
1

  since   1
11 5
.

, so that   5

<N

57

<

=L 1) is indeed sufficiently

22

Part III    Numerical tests

Section 12 describes our computational setup, and gives the results of some general

numerical tests. Section 13 presents tests done with analytic models producing isotropic

radiances. Section 14 presents tests done with horizontal leaves, in situations of extreme light

trapping. Finally, section 15 concerns iterative integration.

12    Computational setup and general tests

All our computations carry 15 digits (double precision).

Leaves and ground are always Lambertian.

As in (86), we use   N J = 18  photon inclination sectors  Dmj , of equal angular sizes

Dqj =

∞10 . We integrate numerically over leaf inclinations mL , using (75) adapted to the

midpoint rule, with the range  ( , )0 1  of leaf inclinations partitioned into equal intervals  DmL:

   Dm

L

= (

,
m m
1
L
L

2 ,        m
)

L

=

1
2

(
m m
+
1
L

L

2

),          cL

D ˆm m m1

-

∫

L

L

L

2  

=

(97)

We use  9  equal intervals  DmL  of sizes   D ˆmL =
value of  L  in (75), with  mL = 1  (mL = 0).6

1
9 . Horizontal (erect) leaves require a single

Integration of propagated emissions: We subdivide each medium layer   (

z

number  Nm  of thin layers, in order to integrate the propagated emissions   f

zm
,

(

m

)

)

m +1   into an even
z
,

z

f

)

(

m

+1

m

∫

numerically using Simpson’s rule. However, to determine the radiances between thin layers

(inside the medium layer), we require   f (

z

,

z

m

)

  for   n

= 1 2,

,...,

N m

m n
+

, where   z

m N

m+

z

=

m

+

1. For  n

odd, the integration over the last (odd) thin layer   (

z

,

z

)

  is not as accurate as the

m n

1
+ -

m n
+

integration over pairs of layers, as explained in Appendix C, so that the precisions of the

computed radiances between thin layers alternate by about one digit (more precise for  n  even,

less for  n  odd).

Discretization methods  1 and  2:  In section 5, we gave two different methods (1 and 2) for

discretizing the photon inclinations m. In general, radiances computed using these two methods

differ by between 10 4-  and 10 3- .

                                                  

6  Note that for (semi)isotropic leaf inclinations, we do not use the analytic canopy optical coefficients

obtained in section 9 of Ref. [2], because we are unable to integrate those analytically over   Dmf . We
prefer to use (75) to ensure precise energy balance.

23

Working with radiances or with vertical fluxes: One can choose to work with radiances

˜(
I

zjDm   by using the LTE (58) with (63), or with vertical fluxes   ˆ ˜(
I
D
mj
j

, )

m

z
, )

  by using (58)

with (59). Radiances computed in these two ways generally differ by less than 10 13- .

Sunlight:  As discussed in section 5, sunlight may be treated in two different ways:

(i) ‘Incident’ method: Lump sunlight with the skylight incident in sector   Dmjh

, using (57).

(ii) ‘Emission’ method: Treat first-scattered sunlight as an ‘emission’.

To compare these two methods, for ‘realistic’ canopies (semi-isotropic leaves), we assume that

only sunlight is incident, and use (51) (discretization method 2). We first let  m mh
jh

=

  to make

the ‘incident’ method exact, so that the relative differences (r.d.) between results yielded by the

‘incident’ and ‘emission’ methods are due solely to Simpson numerical integration errors in the

‘emission’ method, that is, r.d ~ RSE in Eq. (92). The actual errors roughly agree with (92)

(within factors 10  or so). For instance, with a total canopy LAI   L = 10  and  mh > 0 3.

, we get

6
-

10

<

r.d.

<

10

5
-

  if    l

= 0 1.

dependence). With  mh ª 0 05.

-

, and  10
  and    l

10

<
= 0 1.

r.d.

9
-

<

  if    l

10

= 0 01.
  we get  r.d. ~10 3- .

  (reflecting the    l4

We next do calculations with  m mh
jh

π

. Radiances yielded by the ‘incident’ and

‘emission’  methods then differ by up to 20 percent, giving the error due to nudging the sunlight

inclination from mh   to  mjh

  in the ‘incident’ method. It is not easy to estimate theoretically this

‘nudging’ error, because much of the light that penetrates deeper (especially with grazing
sunlight) is sunlight scattered nearly vertically downwards (minimum  Dz ˆm) by leaves higher
up. But the general tendency is as expected: Too much (not enough) light reaches down if  mh   is
nudged towards vertical (horizontal), since this decreases (increases)   L mh . If in the ‘incident’
method we use (56) rather than (57), thereby altering the flow of energy into the canopy, then the

discrepancy with ‘emission’ results more than doubles, and may reach above  200%  at very

small mh  (e.g., more than  400%  for  mh = 0 01.
method is clearly the more accurate and reliable (unless  m mh
jh

ª

, in the case of visible light). The ‘emission’

  by chance), and is the one we

use in practice.

13   Non-absorbing leaves and ground

24

Let us assume that: (i) leaf area densities are j-symmetric; (ii) incident light is semi-

isotropic; and (iii) leaves and ground are non-absorbing and non-emitting. Then, in view of
± = 0 , the radiances inside the canopy are isotropic,  ˜( , )
z
m =

Eq.II-(89) with   c

, with

˜( )
I z

˜( )
I z
  

)
m s

D

L

,

+

(

)

1
2 L

b

L

m
L

z
( )

z
( )

=

b
--

˜(
I z e
)
=
0
)
)
s s ,  b
+
)
s  since zero absorption implies  

˜(
I z e
)
0
)

=

+

+ -

+ +

-+

--

-

)
s

where   b
+

=

b
+

b
--

= 2D

)
s s , and   mL   is the mean leaf inclination. We noted that

= -1

-+

  and  

= -1

+ -

. Observe that

)
s

--

)
s

)
s

+ +

(98)

˜( )
I z   increases down the canopy if   D

)
s > 0, implying light trapping.

I
)
)
)
s s s
D
+ +

-

∫

--

           We here discretize photon inclinations using (49) (discretization method 1), since it is

exact for isotropic radiances. Note that using discrete leaf inclinations entails no loss of precision

(since these are still j-symmetric). Leaf inclinations are taken semi-isotropic, so that   mL =

1
2 .

As argued in section 9, TTRG computations loose  nm  digits of precision due to the

thickness  

  L m   of medium layers. Other sources of error are not easy to estimate, but in the light
)
s > 0, analogy to the simpler case of horizontal leaves, treated in section 14

trapping case   D
n
below, suggests an additional loss of  nI  digits in precision, where      
  ª 0 2. L D

)
s, if   mL =

1
2 . Thus, the expected precision is  na  digits, where, using (88):

ª

I

log (
I z

)

g

(log ) 1
e

2 L D

=

)
s

n
   

a

15

n

m

n

I

-

.
15 2 5
-

L

ª

m

-

ª

-

.
0 2

L D

)
s

This is roughly what we get for the cases we treated, with    L   ranging from 1 to 30, and 

between 1 and 3. For instance, if   D

)
s = 1,   L = 30 , and  

  L m = 3, then (99) yields   na ª 1, while

TTRG numerical results differ by ~ 5%  from the analytic radiances.

If we obtain the radiances between medium layer by iterating Eqs. I-30 (rather than using

the Green’s matrix as in TTRG), then the results agree to  15 - nI   digits with TTRG, since both
computations use the same transmission-reflection matrices, with the same error  nm .

Computed radiances turn out to be isotropic to better than  10 10-

. If we add in emissions

given by Eqs. II-(86), then precision is better than  10 3-   in all the cases we treated. If we rather

use discretization method 2  (i.e., (51) instead of (49)), then precision is ~10 3-  ( as expected

since methods 1 and 2 yield results differing by ~10 3-   in general).

(99)

  L m

14   Horizontal leaves, extreme light trapping

25

In this section, leaves are horizontal. Methods 1 and 2 for discretizing photon inclinations

are then equivalent, and yield canopy optical coefficients similar to the ground coefficients (76).

Because the ‘effective’ LAI does not increase in oblique photon directions, we expect higher

precisions than with semi-isotropic leaves (for a given LAI). Also, we can use thicker ‘medium’

layers, as was argued in section 9. We use    Lm £ 10 , so that   nm £ 4   by (88).

With semi-isotropic incident radiances, radiances throughout the canopy should be semi-

isotropic. TTRG computed radiances are semi-isotropic to better than 10 10-

  (for    L = 10).

Black leaves: With non-absorbing non-emitting black leaves, ‘down’ radiance at   z

zg=   should

L

0, and reflected light at  z

z= 0   should be zero if the ground is totally absorbing

be    e D- L
( Rg = 0), and    e D-2
values to better than  10 11- , for    L = 1  to 30, even if we use a single ‘medium’ layer (of LAI up
= 0, the transmission-reflection matrices I-(22) involve no
to 30). Indeed, since here   T

  if totally reflecting ( Rg = 1). TTRG computations yield these analytic

T

=

UD

DU

0

substractions of (large) transfer matrix elements.

Extreme light trapping: This is produced by a totally reflective ground, and leaves which totally

transmit ‘down’ light, but totally reflect ‘up’ light. We showed in section II-12 that with only

semi-isotropic skylight incident, the fluxes at the bottom   z

zg=   of the canopy are

  

D U
g=
  

g

1
(
= + +

r

2

r

+

1
= -(

1
-
r D
)
0

1
-

D
0

,

=

t

r

1
∫ -

,
t

-

e

L  

t

∫

(100)

Here, D  stands for the vector   (

,...,

D , i.e., the   D Dj =

)

  are all equal. Also, r  stands for  r

D
0

...
)
D D
,

times the   9 9¥   unit matrix (if   N

ND
U=

= 9).

TTRG calculation: In view of Eq.II-(108), we here have, if we use a single medium layer:

0

r
1 0

ˆ
˜
¯

Ê
Á
Ë

,

=

Q
  

D
g

U

g

Ê
Á
Ë

ˆ
˜ =
¯

GE

=

1

1

-

r

1

r D
ˆ
Ê
0
˜
Á
0
1 1
¯
Ë

Ê
Á
Ë

ˆ
˜ =
¯

1

1

-

r

D
0
D
0

ˆ
˜
¯

Ê
Á
Ë

where we used    E = (

1
(
= -

Q

)

1
-

  G

, )D0 0  (no ‘true’ emissions), and noted that    Q 2
1r
)
1
-
= +

+ = -

Q Q
+

1
(

1
(

...

Q

+

)

2

= r , so that

(101)

(102)

Thus, TTRG yields (100) with  t-1  computed as  t-

1

1(
= -

1
-

)r

. Now, t  and   r  are accurate to

about 14 digits. So if  t  is very small, then   r = - ª

1t

1

, so that the small number  t = -1 r   is

26

t

10

10

e

=

ª

t

L

log

0 43
.

~ log
-

  digits, where

L . Hence we expect computed radiances precise to  14 - nt

the difference of two ‘large’ numbers (1 and  r ª 1), hence is precise to  14 - nt
  n
digits. This is roughly the case: For instance, if    L = 10, then    eL
precision; if    L = 30 , then    eL
ª
32
nonsense once    L >
Eq.II-(109), actual TTRG computations would then use several medium layers (of LAI    Lm < 10
say), in order that no   rm

, and precision is down to about  3%. We get

= 22 026, and we get 10 digits

¥
 (recall that   ln

e ). But of course, as said after

= -1 t   be too close to 1.

1 0686 1013
.

10 1
=

ln
14 10

/ log

ª

10

m

Sunlight:  If only sunlight is incident, and is treated as an ‘emission’, then as shown in section

II-12, we have again   D

1
1
)
(
r D
g = - -

0. The computed   Dg   agrees to ~10 6-  with that computed

above (with only skylight incident), for all values of    L   treated, between  1  and  30, and with
 l

, in line with the relative Simpson error ~  1
90

-   in (92).

610

l

4

= 0 1.

ª

Iteration: Rather than use the Green’s matrix, we can obtain the radiances between medium

layers by iterating Eqs. I-(30). Consider the case of a single medium layer (the whole canopy).

( )
k
The iteration equations are then   D
g

=

D rU
+

0

k

(
g

1 , U
)
-

( )
k
g

( )
k
D
g

, U

( )
k
0

U

( )
k
g

=t

=

, so that

k

(
D
g

1
)

+ =

( ),
k
D rD
+
g

0

r

1 t

= -

(103)

where  D  again stands for the vector   (

D D
,

,...,

D . Iteration stops when   Dg

)

k( )   is large enough

( )
k
that the loss   D
g

( )
k
rD
g

-

=t

( )
k
D
g

k( )
  is (nearly) equal to the gain  D0, i.e., when  D
g

1

ª -t

D

0. In

view of Eq.II-(103), the number of iterations needed to obtain a relative accuracy  dr   is

K

ª - -t

1 ln . Now, r  is either too large or too small by  e ~ 10 15-
repeated  K  times (so that roundoff errors accumulate), causes a relative error

d
r

. So multiplication by  r,

K

(

r

)
e

±

-

K

r

K

r

ª

K r K

e

ª

e ~ ln

d t
r

1
-

15

-

10

¥

ª

ln

d
r

¥

10

  (since   r ª 1), so that

15
- +

n
t

precision is  ~14 - nt

  digits if   lndr £ 10   (i.e., if  dr ≥

-10 10).

15   Iterative integration

           We now discuss iterative integration applied to the above extreme light trapping situation.

Let us repeat the discussion in the last paragraph of section II-12, but with no sunlight present,
and putting   Dt = -1 l   explicitly. We have, for the total vertical fluxes:

1
-

n

n

  D D
=
1 l
(
= -

n

)

Thus,     U

l
D
n

,

+

U D
=
N

N

,

U
n

1
-

(
1
= -

l

)
U
n

l
           

∫ L N

(104)

N n
-

U
N

 (where  

  U UN
=

g

), and the  kth  iterate is, using II-(100):

27

( )
k
N

U D D
  

=

=

( )
k
N

l
Â0
+

N

n

0

=

k

)
1
-

(
U
n

(
k
D U
+
N

r
l

0

),
1
-

=

r
l

1
∫ -

t
l

,

t
l

1
(
∫ -

N

l

)

(105)

Hence, putting    UN

( )0

0= , we get      U D D

r
+ l

=

0

0

,     U

( )1
N

2
( )
N

1= + +l

r

(

2
r
l

)
D
0

,...,

k

( )
k
U
N
  

=

r
Â l

m

=

0

m
D
0

1
(
= -

1
-

r
l

)

1
(

1

+

k
r
l

)
D
0

-

So as   k Æ •,   r k

l

1

+ Æ

0, and  

k( )
U Dg
  

0   converges from below to      (
1

-

1
-

r
l

)

1
-
lt

=

1
= -(

L

N

)

N

-

.

And the latter converges from above to    eL   as   N Æ •  (indeed, compare, e.g., for    L = 10, the
value    eL

ª 22 026, with    1
-(

, and also    1
+(

, if  N = 100 ).

37 648

13780

) ª

L N

L N

ª

)

N

N

-

Let   J

( )
k
n

( )
k
,
D U
n

( )
k
n

= (

)  be the fluxes obtained in the kth iteration of equations (104). Our

computer code asks that iteration stops when

J

( )
k
n j
,

-

1
)
-

J

(
k
n j
,

1
)
-

J

(
k
n j
,

<

d
i

)

(

(

for all

, )
n j

       

(106)

(107)

k

-(
r

k

s
-(

k

s

k

) =-1
k

= -

i.e., when stability to within  di   is attained. If the incident radiance is semi-isotropic, then so are

the radiances inside the canopy, so that (107) is equivalent to  

(
( )
k
(
U U
-
n
n
  

k

1
)
-

)

k

1
)
-

(
U
n

<

d . In the

i

present case,  n N=
stops when   s
s

  (at which    U   is largest) is determinant, so that in view of (100), iteration
)ª
d

), where   s

∫ + +

. Since

...
+ +

d (
1

) (
1

s
i k

=

-

-

1

1
-

1
-

r

r

r

r

r

2

k

k

k

i

k

, we can solve for   r k , to get   r k

(
)
d t d
i

=   (since  r = -1 t), whence:

+

i

ln

1
+(

t d
i

)

1
ln(

)
t t
ª

-

1
-

ln

1
+(

t d           (for  t << 1)

i

)

(108)

The actual number of iterations is very close to the theoretical value (108) (e.g., with    L = 10
and  di =

-10 11, the number  k  predicted by (108) is  322 357, while the actual one is  322 358).

Now, in view of Eq.II-(103), the number  k  of iterations needed to approximate the

analytic value    U
(108) that   ln

d
r

ª -

N = -t

1
D

0   with a relative error  dr   is given by   k

ª - -t

1(ln ). It follows from

d
r

ln

1
+(

t d
i

)

, hence  1

ª -
t d di
r

+

, or  d tdi

ª

r

  if  dr << 1. Thus, if  t << 1,

1

then di   must be taken much smaller than the desired relative error dr  (showing that  di   can
sometimes be quite unrelated to  dr ). The trouble here is that because   r k m+   decreases very
slowly as  m  increases (since  r  is very close to 1), many terms of size comparable to   r k   add

up. A better convergence criterion would here be   r

k

=

s

k

-

s

k

<-1 d , or  

r

(
( )
k
(
U U
-
g
g
  

k

-1
)

)

D

0 d .
<

r

But this would not do if above our light trapping layer (LTY) we had another thick layer of
totally absorbing horizontal leaves, decreasing the flux    D0   incident on the LTY by a factor

28

t0

1<< , so that a proper criterion would then rather be    D D

<-1
specifying a convergence criterion can, in certain cases, be problematic.

-

k
( )

k

(

)

D
0

0t d . So just

r

,rr tt  to first order in   l: As shown in section I-12, when treated to first
Error due to treating   t r,
order in   l, transmissions are too small and reflections too large, which means too much trapping

,

in the present case. For instance, if    L = 10  and we ask that  d2
l
need   N ª 5000  hence    
then we would get  
L

0 01 1
=
. If we were to use the ‘usual’   l

L N 0 002
ª

! 7

%

N

=

=

e

e

)

.

.

.

L

L

N

-

ª

0 71 71
=

-

-

1
(
[
  

]

%, see (95), then we

= 0 1.

, hence   N = 100 ,

We thus see that in the iterative integration method, one should really check the stability

of results against both  di   and  N, that is, vary these numbers until stable (presumably correct)
values are attained.

Computation times: For a relative accuracy  dr , we need   k

ª - -t

d
r

1 ln   iterations. The number

of thin layers needed in order that    1 -(
is    N

ª

1
2

2L d , by (95) with    L = L . The computation time is thus

r

L N

N

)-

  be equal to    eL   to a relative accuracy  d d2 ª r

CP sNk
ª
  

1
-

ln

d
r

s
)(
ª - (
t
.ª
10 1 15 1
ln

where we put   1
2

1
2

2

L

d
r

) ª

s

2
L L
e

1
-
d
r

log

10

1
-
d
r

ª , and   s  is the number of seconds required per iteration and per

layer. Our various computations (using a 1 GHz Pentium IV) indicate that   s ~ 2 10 5

- . For

5

10

,   N

1
2

2

L d

r

ª

5000

, so that

¥

=

instance, with    L = 10  and dr =
CP sNk
ª

ª 10 000  seconds  ª 2 8.

-10 2, we get   k

eª -
ª-
 hours (roughly what we get).

10

ln

10

2

In all our tests, TTRG computations times are less than a second (including the

computation of all matrices).8

                                                  

7 Note that in this case (95) (of first order in  N -1) yields    d2
in   N -1  yields  d2
10

1
ª +
2

ª-

.
0 66

+

1
3

1
8

.

3

4

4
10 10
)

(

1
2

2
L N

1
2

=

ª

, while (A.1) to second order

8  To compute   A B-1

, we use what MATLAB  calls ‘left division’  A\B, based on Gauss elimination

algorithms. This is more accurate than calculating  A-1  separately, and then multiplying into  B.

16  Conclusion

29

All the numerical tests discussed in the preceding sections indicate that TTRG numerical

integration of the light transport equation (LTE) is highly accurate and rapid, even in cases of

extreme light trapping where iterative integration is hardly practical.

One might object that such high precision as provided by TTRG is somewhat pointless,

since the horizontally homogeneous turbid medium model (on which is based the LTE) is

already very approximate, and so are all our data (leaf and ground optical coefficients, leaf area

densities, etc.). However, since TTRG is anyhow faster, one might as well use it. We thereby

know at least that integration of the LTE produces very small errors in the absence of sunlight

and emissions (about  10 12-

  judging from ‘realistic’ model computations with semi-isotropic

leaves), and is of amply sufficient precision when sunlight is present (and treated as an

‘emission’), namely better than 10 3-   for all relevant values   0 05
of LAI    l

.

 (the drop in precision being due to the Simpson numerical integration of the

1

, if we use thin layers

£

£mh

ª 0 1.
propagated emissions).

The case of extreme light trapping provides an example for which iterative integration

requires large numbers of iterations, hence large computation times. Moreover, it reveals that

specifying a convergence criterion and proper thin layer thickness in the iterative method can

sometimes be problematic. Of course, realistic canopies do not suffer these problems. But one

should be aware that iteration can become impractical in certain cases. Our TTRG method

remains as efficient, while also being faster and more accurate in realistic situations.

In this paper we assumed that the diffuse radiances are j-symmetric, so that it sufficed to

use  j-symmetric light sectors ( N J = 18  sectors, specifically). In that case, iterative integration

and TTRG both take little computer time for realistic canopies, so that computation time is not a

serious issue here. However, if we wish to compute diffuse radiances which vary with  j   (as

should really be done since photo-synthesis is highly non-linear in the radiances), then one

should use 18  azymuthal sectors, say, for a total of   N J =

18 18
¥

=

324  light sectors. Then

2.
computation time becomes an issue, since it scales like   N J

30

Appendix A: Approximations for exponentials

We here show that the relative errors done in approximating   e

x

1
(
ª ±

x N

)

±

N

  have the

following expansions in powers of   N -1:

d
+

x N
( ,

)

∫

d
-

x N
( ,

)

∫

x

e

N

x N

)

(
1
- +
x
e
x N
e

)
x

(
1

-

N

-

x

e

-

2
x N

1
-

1
2

=

-

1
3

(

3

x

1
8

+

2
-

4
x N
)

...

+

= -

d
+

x N
( ,
-

)

=

2
x N

1
-

1
2

+

1
3

(

3

x

1
8

+

2
-

4
x N
)

...

+

Proof: Note first that  d+

x N
( ,

)

1
= -

A x
( )

, where

( )
A x

∫

e

x
- 1
(

+

N

x N

)

1 1
2

= -

1
N

2

x

1
3

1
2
N

+

3

x

+

1
2
N

2
N

3

+

1
8

(

4

x

)

...

+

the expansion being obtained by multiplying out the two series   e

x- = - +
1

x

2

x

1
2

-

...  and

1
(

+

N

y

)

1
= +

Ny

1
2

+

N N
(

2

1
)

y

-

+

...

, where   y

x N∫

. Although (A.1) agrees with (A.2) to the

orders shown in  x  and   N -1, this does not guarantee that the coefficients of   N -1,  N -2 ,..., in

(A.1) do not contain higher powers of  x. To get (A.1), write   (

1 +

N

y

)

y

(

e

N

)

e   where

-

=

e =

1
!
2

2

y

1
!
3

3

y

+

+

...

, and then compute, noting that   e

Ny

x

e

:

=

( )
A x

=

x

-

e

y

(

e

N

)
e

=

x

-

e

Ny

Ne

-

(

N

1
)
-

y
e

+

1
2

(
N N

1
)
e

-

(

N

2

)

-

2
y
e

-

...
)

1
= -

-

Ne

1
2

+

(
N N

2
-

1
)
e

y
2
e

...

+

(

y

∫

x N

)

-
y
e

e

(
-

Since  e ~ N -2, we see that the next power in  e  goes as   N

3 3

e ~

N

3
- , etc. So to order   N -2 :

(A.1)

(A.2)

(A.3)

(A.4)

( )
A x

1
= -
1
= -

1
= -

1
2

1
2

y

-

Ne

(

1
2

2

y

-

e

2

y x
N

-

+
1
e
6

3

y

)

1
6

-

3

2

y x
N

2
-

y

4

y

1
4

...

+

(
N N

N

1
-
N

e

1
)
e

-
2
y x
-
N

4

2

...

+

1
(

-

x
N

)

2

x
N

1
6

3

2

x
N

-

4

2

x
N

...

+ = -

1

1
2

2

x
N

11
3

3

2

x
N

1
x
N+
8

4

2

+

+ ...

1
2

1
8

1
8

+

+

+

whence (A.1). For example, with   x = 2  and   N = 100 , the exact  d+
while (A.1) yields   1
4 100
2

x N = ¥

= .

0 02

1
2

2

  to order  N -1, and  0.019533...  to order  N -2 .

x N   is  0.019543... ª 2%,
( ,

)

N

)

x N

<  ex <  1 -(

)-
          Note that   1 +(
x = 10  and   N = 100  [ N = 1000 ], then   1
x N
+(
 [ ª23 164], while   e10

37 648

x N

x N

ª

ª

N

-

N

) ª
.
22 026

N

1
-(

)

, since  1

±

x N e

±

ª

x N

1
2

- (

2

)

x N

. For instance, if

13780

 [ ª20 959], and

31

Appendix B:  The functions   g±

)m m   and   g±
( ,

¢

(

,
Dm m
¢

)

B.1  We write the scalar product of two unit vectors   W = ( ,

)q j   and   W¢ = ¢
,

)q j   as
(
¢

W ◊ W¢ = +

a b

cos(

j j
- ¢

),

a

,
mm
¢

=

b

=

bb

¢ ≥

0

m

=

cos ,
q

b

∫

1

2
m

-

=

sin

q

≥

0

Recall that  q

0
( ,

Œ p ﬁ

)

sin

q

≥

0 . We will use the inverse trigonometric functions

1
-

cos

x

1
cos (
-

-

),

0
( ,
Œ p
x
)

= p -

1
-

sin

x

1
-

cos

x

,

(
Œ - p
1
sin (
-

2

,

x

-

p
)

2

),

1
-

tan

1
-

sin

x

,

= -

x

(
Œ - p
1
x
tan (
-

-

2

,

p

2

)

)

= -

1
-

tan

x

Using   b

2

2

a

-

1

= - ¢ -m m , we note the following derivatives:

2

2

2

b
(

2

a

)

-

2
,
m
= -

d
d
m
d
d
m

d
d
m

(

a b
/

)

=

)

a b
/
2
(
1
m m
-
d
d
m

tan

1
-

cos

Ê
Á
Ë

-

a
b

ˆ
˜ =
¯

¢
m
)

1
(

2
m

-

2

b

2

a

-

,

1
-

Ê
Á
Ë

m
2

-

b

2

a

ˆ
˜ =
¯

1

2

b

2

a

-

 

(B.3)

B.2  The function  G

): As in Eq.(7) in Ref.[2], we define the function

(
m m¢

)
(
z m

=

2

1

-

-
m m

1
-

cos

d
m

cos

m

= -

Ú
)  as the indefinite integral of   1
p

m

1
-

We also define   G

(
m m¢

b
-(
z

a b

)

, for fixed  m¢, as follows:

˙
G
¢
m

(
)
m

∫

1
p

b
-(
z

a b

) =

1
p

2

b

2

a

-

1
p

+

a

cos

1
-

-(

a b

) =

(

)
d d G
m
¢
m

(
)
m

            

(B.5)

G
¢
m

)
(
m

∫

˙
d G
m
¢
m

)
(
m

=

Ú

1
2

p

È
m
Í
Î

2

b

2

a

-

- ¢
b

2

1
-

cos

Ê
Á
Ë

m
b
¢

ˆ
˜
¯

˘
˙
˚

+

1
2

p

È
¢
¢
m m
Í
Î

1
-

tan

Ê
Á
Ë

m
2

-

b

2

a

ˆ
1
(
˜ - -
¯

2
m

)cos

1
-

 

Ê
Á
Ë

-

a
b

ˆ
˜
¯

˘
˙
˚

(B.1)

(B.2)

(B.4)

(B.6)

(B.7)

as is readily verified using (B.3). Using (B.2), we find that

G

)
(
m

=

G
m
¢

)
(
m

+

1
2

m

m
- ¢

2
m

)

G
m
¢

(

)
m

-

= -

G
m
¢

)
(
m

-

1
(
¢ -

2
m

)

1
(
+ - ¢
m

2

)
]

1
(
¢ -
[
m

1
2

Note the special cases:

G
m

G
0

0

¢≥

¢(
b
)
(
m

=

) =
[

1
2
p

1
4

2
¢ -

m

1
2

¢
m

3

,

G
m

0

¢≥

(

- ¢
b

1
4

2
¢ -

m

1
2

) =
G
m
¢

,

]

G
0

( )
1

=

,
0

G
0

(

)
1
- = -

1
2

,

G

1
±

( ) m
0
=

1
4

( )
a

( )
b

(( )c

m

1

2
m

-

-

1
-

cos

m

( )
0

=

1
4

2
(
¢ - ¢ -
m m

)
1

(B.8)

32

Proof:  (a) m b= ± ¢   and  m¢ ≥ 0  imply  1

m m ,  b = ¢m b,  a b = ±1  and   b

= ¢

-

2

2

2

2

a

-

0
= , so

that   tan

1
-

(
m b

2

2

a

-

) =

1
tan (
-

)
±• = ±

p
2

1
,  cos (
-

a b

)

-

=

1
cos (
-

m
1
)

=

p{ }

0

, and

1
cos (
-

m b

)
¢ =

1
cos (
-

1
)
± =

0
p

Ï
Ì
Ó

¸
˝
˛

. (b) m¢ = 0  (m = 0 )  implies   a = 0  and   b = b  (

b = ¢b . (c) follows

)

from (b). Note, since   G

)  is real only for   a

(
m m¢

b£ , that if  m = ±1  or  m¢ = ±1, implying

b = 0 , then   G

(
m m¢

)  is real only for  m¢ = 0   or  m = 0 (as in (c)). Note also that   G

m¢ π 0 1( )  is

complex, while   G

π(

m m¢

)0   diverges as  m¢ Æ 1.9

B.3   The functions   g
±

)m m : We define, for  m Œ -(
( ,

¢

, )1 1 , m¢ Œ -(

, )1 1 :

g

±

( ,
m m

)
¢ =

1
2
p

Ú

±W◊W¢>

0

d
j

W ◊ W¢ =

1
2
p

d
j

a b
+

cos

j

±

p

Ú

-p

using notation (1). Note the integrals, and special cases:

1

Ú

1
-

d g
m m m
±

( ,

)
¢ =

1
2
p

Ú

± ◊

W W

¢>

0

d

W

W ◊ W¢ =

1
2
p

Ú

±

W

z

>

0

d

W

W =
z

1
2

g

±

0
( , )
m

=

1
2
p

d
cos
jb j

+

1
2
p

b

=

d
j j b

cos

=

p

2

p

Ú

-p

2

 

 

p

Ú

-p

p

Ú

-p

g

±

1
( , )
m

=

1
2
p

d
j m m
±

=

±

Note also the symmetries

g
±
g
-

( ,
m m
( ,
m m

)
¢ =
)
¢ =

g
±
g
+

)
,
(
m m
¢
,
(
m m

-

(

=
)
¢ =

g
±
g
+

,
m m
- - ¢
( ,
m m
- ¢

)

)

( )
i

( )
ii

(B.9)

(B.10)

(B.11)

(B.12)

where (ii) follows from   a b

it suffices to evaluate   g
+

cos

a b

(
Æ - +
+
j
)m m   for   - £
1
( ,

+ p

cos(

  if   ( ,

)
)
1m   and  m¢ ≥ 0. Now, if   a

m m

)
¢ Æ -

,
m m
b£ - , then

j

£

(

¢

¢ . Because of (ii),
)

a b+

cosj 0  for all j, hence  g+ = 0 ; if   a b≥ , then   a b+

£

cosj 0  for all j , hence

≥

g

+

=

1
2
p

p

Ú

-p

d
j

(

a b
+

cos )
j

=

a

; finally, if   a

b£ , then   a b+

cosj 0  for   -

≥

j j j
£ £

c

c , where

jc

∫

1
cos (
--

a b

)

, so that    g
+

=

1
2
p

d
j

(

a b
+

cos )
j

= p

(

a
j
c

+

b

sin

j
c

1
-

). Hence, noting that

j
c

Ú

j
-
c

sinjc

=

-1

b

2

b

-

a

2 :

                                                  

9 Considering   cos-
1
follows that   (

-

1 L z ,  cos z
=
1
)cos (
--

2
m

=

1
2
)

iz

e

(

iz

-

e

+

) =

a b   vanishes as  m Æ 1, and diverges as m¢ Æ 1.

L

, we see that   cos-1 L  ~  log L   as   L Æ • . It

0

1
p
a

Ï
Ô
Ì
Ô
Ó

33

if

if

if

b

a

£ -
2

a

£
a b
≥

2

b

g

+

( ,
m m

)
¢ =

2

b

2

a

-

1
p

+

a

cos

1
-

-(

a b

) =

1
p

b
-(
z

a b

)

(B.13)

as also follows from (B.4),(B.9) in Ref.[2]. Noting now that   b

2

2

a

-

2

2

= ¢ -b m , we see that

2

a

a

2

b m b ; also,  a

b

£ ¤   - ¢ £ £ ¢
b£ - ¤ £ - ¢

m b . It follows that (B.13), for  m¢ ≥ 0, may be rewritten as, using (B.5):

2

2

≥ ¤ ≥ ¢

ˆm b , so that if  m¢ ≥ 0, then   a b≥ ¤ ≥ ¢m b , and

b

(B.14)

(B.15)

(B.16)

g

+

(
m

¢ ≥

0
,

)
m

=

(
)
m

b m b
- ¢ £ £ ¢

              m¢ ≥

(

)0

0
Ï
Ô
˙
G
Ì
m
¢
Ô
mm
¢
Ó

if

if

if

m b
£ - ¢

m b
≥ ¢

A.4   The functions   g± D

(

)m m : We next evaluate, for  D =

(
m m m
2

,

,

¢

1

)

(
Ã -

1 1
, ),

m m
£
2

1

:

g

±

(

,
m m

)
¢ ∫

D

d g
m m m
±

( ,

)
¢ =

m
2

Ú

m
1

1
p

m
2

Ú

m
1

p
d
m j
Ú
0

d

a b
+

cos

j

±

If the intervals  Dm   partition   (

-1 1 , then by (B.10):

, )

(

,
m m
D

)
¢ =

d g
m m m
±

( ,

)
¢ =

1
2  

1

Ú

1
-

±

g

mD

Â
( ,
m m

Since   g
+

)
¢ =

g
-

( ,
m m

)
- ¢ =

g
+

(

m m   by (B.12), we have the symmetries
,
- - ¢

)

g

+

(

,
m m
D - ¢ =

)

g

-

(

,
m m

)
¢ =

D

g

+

(

-D

m m ,                   -D ∫ -
(

m

)

,

¢

,
m m
-
1

2

)

(B.17)

where we denote   -D ∫ -
(
then (B.14), we have for instance, for  m

,
m m
-

m

2

1

£ - ¢ £ ¢ £

b b m
2

:

1 . It thus suffices to evaluate   g
)

(
+ D

)m m   for  m¢ ≥ 0. Using

,

¢

g

+

(

,
m m
D

)
¢ =

d g
m

+

+

d g
m

+

+

d g
m

+

0
= +

b
- ¢

m
1

Ú
G
[

b

¢

b
- ¢

Ú
b
- ¢

=

(
b

)
¢ -

G

(

)
] +

1
2

2
- ¢
m m b
2

¢

2

)

m
2

b

¢

Ú
(

b

¢

Ú

b
- ¢

˙ (
d G
)
m m m
+ ¢

m
2

Ú

b

¢

d
mm

(B.18)

We thereby find, for  m m1
2£

  and  m¢ ≥ 0:

           g

(

,
m m
D

)
¢ =

+

0

1
2

Ï
Ô
Ô
G
Ô
Ô
m
¢
Ì
G
m
¢
Ô
Ô
G
m
¢
Ô
G
Ô
Ó
m
¢

)
b
- ¢ +
(

b
- ¢

)

)

(

(

-

¢
(
b
(
m
2

2
2
m m m
1
2
)
G
¢ -
m
¢
)
G
m
¢
(
m
1
(
m
1

G
m
¢
G
m
¢

(
b
(
m
2

)
¢ -
)

-

-

)

if

m
2

b
£ - ¢

if

m b
≥ ¢

1

if

if

1
2

2
m m b
- ¢
2

(

¢

2

)

m
1

£ - ¢ £ ¢ £

b b m
2

m
1

£ - ¢ £

b m b
¢¢
2

£

(B.19)

)

+

1
2

2
- ¢
m m b
2

(

¢

2

)

if

- ¢ £

b m b m
2

£ ¢ £

1

if

- ¢ £

£
£ ¢
b m m b

2

1

f
( )

( )
a

( )
b

( )
c

d
( )

e
( )

34

Note that (B.19) excludes the problematic values   G1

)m π
(
0

  and   G

1(
m¢ π ±0

) (as should be since

(B.15) is well defined). With   G

)  given by (B.8)(a), case (c) also reads

(
m b¢ ± ¢

(
g
+ D

,
m m

1
)
¢ = -
2

1
2

1
(
¢ -

m

2
m
2

)

, whence, for   D = -m (

, )1 1 ,  g
+

1 1
, ),

(
(

-

m
¢

1
2

) = =

should be by (B.10). We also find, for   0

£ ¢ £m

1

, that  g

0 1
( , ),

(
+ ±

m
¢

) =

11
(
4

1

d g
( ,
m m m , as
+

)

¢

1
-

Ú
m , where
± ¢

)

0 1
( , )

-

(
∫ -

1 0 , hence, by (B.17), for any m¢ :
, )

0 1
( , ),

g

±

(

m
¢

) =

d g
m m m
±

( ,

)
¢ =

1
4

1
(

m
± ¢

)

(

1

m
- £ ¢ £

1
)

(B.20)

1

0

Ú
1 1
, ),

Whence again   g

(

(

-

±

m
¢

) =

g

±

(

(

-

1 0
, ),

m
¢

) +

g

±

(

0 1
( , ),

m
¢

) =

1
2

.

Appendix C: Simpson’s integration rule

Consider the integral (for any real  a  and  h):

I

=

a h
+

Ú

a h
-

1

Ú

1
-

( )
dz f z

h

=

( )
dx y x

,        z

a hx

∫ +

,

( )
y x

∫

(
f a hx
+

)

Denote

y
0

∫

y

( )
0

=

( ),
f a

y

±

∫

y

(

)
1
± =

(
f a h
±

),

y

m

=

1
2

(

y

+

-

y

+

)

The integral  I  is approximated by   I

ª

I

m

=

y

m

◊ 2   in the ‘trapezoid’ rule, and by

h

I

ª

I

0

=

0 2   in the ‘midpoint’ rule. In Simpson’s rule,  y x( )  is first approximated by a
y
◊

h

quadratic polynomial passing through the three points   (

1 y
,

-

-

)

,  ( ,

0 0y   and   ( ,

1 y

)

)

:

+

( )
y x

ª

( )
y x
S

a bx

= +

+

2

cx

=

y
0

+

1
2

(

y

+

-

)
y x
-

+

(

y

m

-

2

)
y x
0

Since the linear term  bx  contribute zero to the integral over  (

-1 1 , we get

, )

I

I

S

ª

∫

h

( )
dx y x
S

h

=

(
dx y
0

+

cx

2

)

=

1
3

(
h y

+

-

04
y

+

y

+

)

1

Ú

1
-

1

Ú

1
-

Simpson’s rule is obviously exact if  f(x)  is a quadratic polynomial, and also if  f(x)  is a cubic

polynomial. Indeed, if   y x
( )

=

a
0

a x a x
+
1

2

+

...

, then   y
0

+

a
0=

  and  y

2

that   y

m =

a
0

a
2

+

a

4

+

+

... Thus, if   f x( )  is cubic, then   y

m -

y
=0

a
0

a
1

a
2

±

± =

+
2, so that   y x( )  and   y xS ( )
a

±

±

3

a

..., so

have identical coefficients for   x0   and  x2 , hence equal integrals over   (

-1 1  (since the  x3  term

, )

integrates to  0).

In our problem we also require the separate integrals over   (

-h 0   and   ( , )0 h :

, )

I

±

I

ª

S

±

= ±

dz f

S

( )
z

1
2

I

S

h

±

=

dx bx

1
12

=

h

(

5

y

+

±

8

y
0

-

y

)m

(C.5)

h

±

Ú

0

1
±

Ú

0

(C.1)

(C.2)

(C.3)

(C.4)

35

(of course,  I

I
-+
S

S

+

= ). These ‘half integrals’ are again exact if  f(x)  is a quadratic, but no

I

S

longer if  f(x)  is a cubic. Now, by the ‘interpolation error theorem’ (see, e.g., Ref.[7]), we have:

S ( )
y x

-

( )
y x

1
4
!

£

y

(
≤¢

p x
(

)
)
)

(

x

+

1
) (
x x

1
)

-

1
4
!

3

M h x
3

3

x

-

£

for some   p x( )

Œ -1 1 , and  Mk  is a bound on the kth derivative of   f z( )  inside   (

, )

(

-h h . Thus

, )

the error for the half-integrals (C.5) has the bound

Error

1
!
4

M h
3

4

£

Ú
This is in general larger than the error bound   1
90

0

=

-

3

x

)

1
96

M h
3

4

 

1

(
dx x

-h h . We
, )
use (C.4) and (C.5) alternately to integrate the ‘propagated emissions’ (89) up to even and odd

5M h   for the integral (C.4) over   (

4

numbered thin layers, respectively, whence an alternance in the precision. For instance, with

0 1. , and  mh ≥ 0 3.

l
h = =
layers are roughly 1 digit less accurate than radiances just after even-numbered thin layers.

, we find that the computed radiances just after odd-numbered thin

(C.6)

(C.7)

References

arXiv.org/physics/0501064

[1]  A. Royer and S. Royer, Integrating transport equations by combining transfer matrices,

transmission-reflection matrices, and Green’s matrices, in the context of light propagation in foliage,

[2]  A. Royer and S. Royer, Light propagation in a horizontally homogeneous Lambertian

foliage: Analytically solvable models, arXiv.org/physics/0505121

[3]  J. Goudriaan, Crop Micrometeorology: A Simulation Study, Pudoc, Wageningen (1977)

[4]  R.B. Myneni, J. Ross and G. Asrar, A review on the theory of photon transport in leaf

canopies, Agricultural and Forest Meteorology, 45 (1989), 1-153

[5]  Photon-Vegetation Interactions, edited by R.B. Myneni and J. Ross, Springer 1991

[7]   G.H. Golub and J.H. Ortega, Scientific Computing and Differential Equations, Academic

Press 1992, section 6.3.

[8] F.B. Hildebrand, Introduction to Numerical Analysis, McGraw-Hill 1956

