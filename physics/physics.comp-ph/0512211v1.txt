5
0
0
2
 
c
e
D
 
2
2
 
 
]
h
p
-
p
m
o
c
.
s
c
i
s
y
h
p
[
 
 
1
v
1
1
2
2
1
5
0
/
s
c
i
s
y
h
p
:
v
i
X
r
a

Filtering a distribution simultaneously in real and Fourier space

Eduardo Anglada and Jos´e M. Soler
Departamento de F´ısica de la Materia Condensada, C-III,
Universidad Aut´onoma de Madrid, E-28049 Madrid, Spain
(Dated: February 2, 2008)

We present a method to ﬁlter a distribution so that it is conﬁned within a sphere of given radius
rc and, simultaneously, whose Fourier transform is optimally conﬁned within a sphere of radius
kc. Our procedure may have several applications in the ﬁeld of electronic structure methods, like
the generation of optimized pseudopotentials and localized pseudocore charge distributions. As an
example, we describe a particular application within the SIESTA method for density functional
calculations, in removing the spurious rippling of the energy surface generated by the integrations
in a real space grid.

PACS numbers: 71.15.-m,31.15.-p,31.15.Pf

I.

INTRODUCCTION

II. OPTIMIZED FILTERING METHOD

It is well known that the mean quadratic widths, in
real and Fourier space, ∆r2 and ∆k2, of a distribution in
a space of nD dimensions, obey the uncertainty relation
∆r∆k ≥ nD. The equal sign applies to a spherically sym-
metric gaussian distribution, which is therefore optimally
In
conﬁned in phase space in the least squares sense.
many practical cases, however, we are interested in distri-
butions that are strictly conﬁned within a sphere of given
radius (i. e. deﬁned to be strictly zero outside that sphere)
and, simultaneously, optimally conﬁned within another
sphere in Fourier space. This occurs when, to be com-
putationally eﬃcient, we use distributions deﬁned only
within a ﬁnite sphere and we must limit also their Fourier
transforms to a ﬁnite number of plane waves. In order to
calculate those Fourier components, we frequently must
perform a discrete Fourier transform using a ﬁnite num-
ber of grid points, and we want to avoid as much as possi-
ble the resulting aliasing eﬀects1. Such a situation occurs,
for example, in the eﬃcient computation of Ewald sums,
and in the particle-mesh method2. Within the ﬁeld of
electronic structure calculations, this problem occurs in
the real-space formulation3 of Kleinman-Bylander pseu-
dopotentials4, and of pseudocore charge distributions of
ultrasoft pseudopotentials5.

In the speciﬁc case of the SIESTA density functional
method6,7, this problem arises in the evaluation, using a
real-space grid, of matrix elements involving strictly lo-
calized basis orbitals and neutral-atom potentials. Those
integrals generate an artiﬁcial rippling of the total en-
ergy, as a function of the atomic positions relative to
the grid points (the so-called eggbox eﬀect), which com-
plicates considerably the relaxation of the geometry and
the evaluation of phonon frequencies by ﬁnite diﬀerences.
In other grid-based methods8, this problem is generally
solved by ﬁltering the atomic pseudopotentials 9, typi-
cally by multiplying them by an ad-hoc ﬁlter function
in Fourier space1. Here we present a new method for
optimal ﬁltering and its application to solve the eggbox
problem in SIESTA.

We will study only the speciﬁc case of three dimen-
sions, but the extension to one or two dimensions is ob-
vious. Consider an initial distribution of the form
F (r)Y m
0

l (ˆr) if r ≤ rc
otherwise

F (r) =

(1)

(cid:26)

where we are using the same symbol F for F (r) and its
radial part F (r), since it does not lead to any confusion.
l (ˆr) is a real spherical harmonic. The Fourier trans-
Y m
form of F (r) is

G(k) ≡

il
(2π)3/2 Z

dr3e

−ikr

F (r) = G(k)Y m
l (

ˆk)

(2)

where we have introduced the factor il to make G(k) real,
and

G(k) =

rc

4π
(2π)3/2 Z
0

dr r2jl(kr)F (r)

(3)

where jl(x) is a spherical Bessel function.

In general G(k) will be nonzero for any value of k. If we
want to ﬁlter it out for k > kc, the most straightforward
procedure is to multiply it by a step function and then
to perform the inverse Fourier transform:

F (r) ←

kc

4π
(2π)3/2 Z
0

dk k2jl(kr)G(k).

(4)

The new F (r) will no longer be strictly zero for r > rc
but we may suppress those components and iterate the
procedure. As a result, only the most conﬁned compo-
nents, in real and reciprocal space, will survive.

To annalize more rigorously the decomposition of F (r)
into more and less conﬁned components, let us deﬁne
x ≡ r/rc, y ≡ k/kc, f (x) ≡ xF (xrc), g(y) ≡ yG(ykc),
κ ≡ kcrc, and K(x, y) ≡
2κ/π κxy jl(κxy). Then,
substituting in (3) and (4), one iteration of the ﬁltering
p
procedure is given by

f (x) ←

′
dx

′
K 2(x, x

′
)f (x

)

(5)

1

Z
0

where

′
K 2(x, x

) ≡

′
dyK(x, y)K(y, x

).

(6)

1

Z

0

If f (x) were already a perfectly conﬁned function in
both real and reciprocal space, it would not be aﬀected
by the ﬁltering procedure (5), i. e. it would be an eigen-
function of the ﬁltering kernel K 2 with eigenvalue one.
In practice, the uncertainty principle forbids simultane-
ous perfect conﬁnement in real and Fourier space, and
the ﬁltered f (x) will unavoidably ‘leak’ somewhat out-
side x > 1 and its norm within x ≤ 1 will no longer be
one. In fact, if φ(x) is an eigenfunction of K 2, with norm
equal to one within x ≤ 1, its eigenvalue λ2 gives directly
its norm after ﬁltering, since the eﬀect of ﬁltering is just
a multiplication by λ2:

φ(x) ←

′
dx

′
K 2(x, x

′
)φ(x

) = λ2φ(x)

(7)

1

Z

0

Thus, we may perform an eﬃcient ﬁltering, without the
need of iteration, by expanding the original function in
terms of the complete basis of eigenfunctions of K 2, keep-
ing only those with eigenvalues suﬃciently close to one.
Since, it is clear that the eigenfunctions φi(x) of K(x, y),
with eigenvalues λi, are also eigenfunctions of K 2(x, x′),
with eigenvalues λ2
i , we may work with the simpler eigen-
value problem

1

Z
0

dyK(x, y)φi(y) = λiφi(x)

(8)

Notice that, since K(x, y) is the Fourier-transform kernel,
the eigenfunctions φi(x) have the same shape in real and
reciprocal space. This is not true in general for the ﬁl-
tered function f (x), which is a combination of eigenfunc-
tions with eigenvalues λi close to either +1 or -1, which
either change sign or not when Fourier transformed.

In order to solve (8), it is convenient to expand K(x, y)
and φi(x) in a basis of functions in the interval [0, 1].
The simplest basis is that of powers of x. From the
Taylor expansion of jl(x) at x = 0 we ﬁnd K(x, y) ≃

N

n=0 Knx2n+l+1y2n+l+1, where

P

Kn =

2κ
π

(−1)nκ2n+l+1
(2n)!!(2n + 2l + 1)!!

.

r

(9)

Then making φi(x) =

N

n=0 φinx2n+l+1, Eq. (8) becomes

P
Kn
2n + 2m + 2l + 3

N

Xm=0

φim = λiφin.

(10)

In practice, we have found numerically more accurate,
stable, and eﬃcient (requiring a lower N ) to expand
K(x, x′) in orthonormal Legendre polynomials 1 Pn(x)
in the interval 0 ≤ x ≤ 1. Taking into account the parity
lp = mod (l, 2) of jl(x):

2

1

Z Z
0
N −lp

Xα,β=1

The kernel coeﬃcients Knm may be calculated by inte-
gration in a Gauss-Legendre1 set of points xα and weights
wα:

Knm =

dx dyK(x, y)P2n−lp−1(x)P2m−lp−1(y)

=

(12)
wαwβK(xα, yβ)P2n−lp−1(xα)P2m−lp−1(yβ)

The required number N of polynomials
is deter-
mined by the convergence of the expansion xjl(x) ≃
N
n=1 jlnP2n−lp−1(x) in the interval 0 ≤ x ≤ κ. Fig-
ure 1 shows the number of polynomials N required to
P
obtain a given error in the expansion, as a function of κ,
for l = 0. The l-dependence of the error is very small

50

40

30

20

10

s
l
a
i
m
o
n
y
l
o
p
 
f
o
 
r
e
b
m
u
N

Mean error < 10

-12

-6

10

0

0

10

20

30

40

50

kcrc

FIG. 1: Number of polynomials required to obtain a root
mean square error of the expansion of xj0(x) in the interval
0 < x < kcrc. j0(x) is a spherical Bessel function with l = 0.

and, as a rule of thumb, we use N = int(10 + 0.65κ).

i up to N .

Figure 2 plots the ﬁrst eigenfunctions φi(x) of the ﬁlter
kernel K 2(x, y) for a typical value of κ, and ﬁgure 3 shows
all the eigenvalues λ2
It may be seen that there
is a rapid transition between the eigenvalues which are
very close to 1 and those close to 0. It is then straight-
forward to select the M eigenfunctions whose eigenvalues
are above some threshold, say λ2
i > 0.99, for the expan-
sion of the ﬁltered function:

f (x) ←

fiφi(x)

(13)

M

Xi=1

N −lp

Xα=1

K(x, y) ≃

KnmP2n−lp−1(x)P2m−lp−1(y).

(11)

Fig. 4 shows, as an example, the unﬁltered and ﬁltered
oxygen 2p pseudo atomic orbital, generated as proposed

N

Xn,m=1

fi =

wαφi(xα)f (xα).

(14)

)
x
(

i
h
P

i

)
x
(

i
h
P

i

2

1

0

2

1

0

-1

-2

0

-1

-2

0

s
e
u
l
a
v
n
e
g
i
E

1

0.8

0.6

0.4

0.2

0

0

3

rc

4

0.2

0.4

0.6

0.8

1

1

2
r (a.u.)

3

l=0

l=1

x

x

1.6

1.2

)
r
(
i
s
P

0.8

0.4

0

0

0.01

0.008

0.006

0.004

0.002

0

)
k
(
i
s
P

kc

0.2

0.4

0.6

0.8

1

6

8

10

12

k (a.u.)

′

FIG. 2: First few eigenfunctions (with highest eigenvalues)
of the ﬁlter kernel K 2(x, x
) for κ ≡ kcrc = 25. Divided by
r, they give the radial part of the distributions, with angular
momentum l, that are most localized in a real-space sphere
of radius rc and simultaneously in a reciprocal-space sphere
of radius kc.

FIG. 4: Filtered (dashed lines) and unﬁltered (full lines) oxy-
gen 2p pseudo atomic orbital, generated with a strict cutoﬀ
rc = 3.94 bohr as proposed by Sankey and Niklewski10. It
was ﬁltered with a cutoﬀ κ = 25, which corresponds to a
c = 40 Ryd. Upper
plane wave cutoﬀ kc = 6.35 bohr
panel: real space shape. Lower panel: tails of their Fourier
transform.

−1, or k2

by Sankey and Niklewski6,10 with a Troullier-Martins
pseudopotential11. To enhance the ﬁltering eﬀect, we
have used a very small ﬁlter cutoﬀ. Still, it may be seen
that the Fourier components above the cutoﬀ are very ef-
ﬁciently suppressed, although this is achieved (with this
small cutoﬀ) at the expense of a substantial change in its
shape.

Finally, the most conﬁned eigenfunctions, φ1(x), for
each angular momentum l, may be used to generate a
localized distribution with given multipole moments, as
required in the ultrasoft pseudopotential5 and projector
augmented waves12 methods, among others problems in
computational physics2. They may be used also as a
basis of localized orbitals, for the expansion of the elec-
tron wavefunctions13, which is asymptotically complete,
within the conﬁning spheres, as the ﬁlter cutoﬀ increases.

5

10

15

20

25

Index

FIG. 3: Eigenvalues of the ﬁlter kernel K 2(x, x
) for κ = 25
and l = 0 (circles and full line), l = 1 (squares and dashed
line), and l = 2 (diamonds and dotted line).

′

III. APPLICATION WITHIN SIESTA

There are three contributions to the eggbox eﬀect in
SIESTA (an artiﬁcial rippling of the total energy sur-
face as a function of the positions of the atoms relative
to the integration grid points): i) the so-called neutral-
atom potential6 VN A(r) given by the local part of the
atomic pseudopotentials minus the Hartree potential of
the free-atom electron densities; ii) the exchange and cor-
relation potential Vxc(r), given by the electron valence
density ρ(r), which in turn is given by a sum of products
of atomic basis orbitals ϕµ(r). These two contributions
are frequently comparable in magnitude; iii) the nonlocal
core correction (NLCC) to Vxc(r), given by a pseudocore
electron density ρN LCC(r) added to ρ(r). This added
density is generally very large and localized and, when
the NLCC is present, it normally dominates the eggbox
eﬀect. Finally, the Hartree energy, given by the self-
interaction of ρ(r), also contributes to the eggbox but,
since the Hartree potential is much smoother than the
density, this contribution is always negligible compared
to the other ones.

Thus, in order to cut drastically the eggbox eﬀect, we
must ﬁlter ρN LCC(r), VN A(r), and ϕµ(r). The ﬁrst two
may be ﬁltered with the plane wave cutoﬀ kc of the real-
space integration grid used to calculate the matrix ele-
ments of VN A(r) and Vxc(r). The ﬁltering cutoﬀ required
for ϕµ(r) is somewhat less clear, because we need to treat
products of two ϕ’s in the integration grid, not just the
ϕ’s themselves. In principle, the plane wave cutoﬀ of a
product of two functions is twice that of the functions
themselves, what would suggest that ϕµ(r) should be ﬁl-
tered with kc/2. However, a widespread experience with
plane wave codes has shown that this criterion is too
strict, and that in practice the eﬀective cutoﬀ for the
density is typically less than two times that of the wave-
functions. Therefore, we have checked that making the
ﬁlter cutoﬀ for ϕµ(r) equal to ∼ 0.6kc leads generally to
the best convergence, as a function of kc.

Figure 5 shows the eggbox eﬀect of isolated atoms dis-
placed across the integration mesh. It may be seen that
the eﬀect is indeed eliminated almost completely by ﬁl-
tering. Of course, we shall not eliminate the eggbox eﬀect
at the expense of ﬁltering the pseudopotentials and ba-
sis functions so much as to change the physical results.
Figure 6 shows the vibrational frequencies of the water
molecule, calculated by diagonalizing the dynamical ma-
trix obtained by ﬁnite diﬀerences14. As the plane wave
cutoﬀ kc of the integration grid is reduced, ρN LCC(r),
VN A(r) are ﬁltered with that cutoﬀ, and ϕµ(r) is ﬁltered
with 0.7kc. It may be seen that much lower cutoﬀs are re-
quired, to converge accurate frequencies, with than with-
out ﬁltering.

4

0.2

0.4

0.6

1
Displacement (Bohr)

0.8

1.2

1.4

C

O

Fe

Pb

100

150

200

250

300

Mesh cutoff  (Ry)

FIG. 5: a) Total energy of an isolated carbon atom, as it is
displaced in a large unit cell, using an integration grid with
a plane wave cutoﬀ k2
c = 50 Ryd, whose points are separated
by ∆x = π/kc = 0.44 bohr. b) Magnitude of the eggbox
eﬀect (peak to peak of total energy) for several isolated atoms
with hard pseudopotentials or nonlocal core corrections (in
Pb and Fe), as a function of the plane wave cutoﬀ of the
integration mesh. Full lines: without ﬁltering. Dashed lines:
with ﬁltering.

)

V
e
(
 
y
g
r
e
n
E

-141.41
-141.42
-141.43
-141.44
0

)

V
e
m

(
 
x
o
b
g
g
E

200
150
100
50
80
60
40
20

100
50
0

)
1
-
^
m
c
(
 
s
e
i
c
n
e
u
q
e
r
F

3930
3920
3910
3900
3890

3820
3810
3800
3790
1750

1700

1650

100

150

200
Mesh cutoff (Ry)

250

300

FIG. 6: Vibrational frequencies of the water molecule, calcu-
lated from the hessian matrix, which was obtained by ﬁnite
diﬀerences from the forces on the atoms displaced from their
equilibrium positions. The x axis is the plane wave cutoﬀ
of the integration grid used in SIESTA. Full lines: without
ﬁltering. Dashed lines: with ﬁltering.

IV. CONCLUSIONS

We have presented a general method to generate dis-
tributions, with a given angular momentum, which are
optimally conﬁned within a strict cutoﬀ in both real and
Fourier space. They can be used by themselves, as to
produce localized distributions with given multipole mo-
ments, or as a basis for expanding and ﬁltering an arbi-
trary initial distribution. As an example, we have shown
how they can be used to ﬁlter the pseudopotentials and

5

basis functions in the density functional method SIESTA,
thus eliminating the eggbox eﬀect on the total energy,
due to the calculation of matrix elements in a real space
integration grid.

Thus, our basis functions φ(x) are the normalized dis-
tributions which are strictly conﬁned to 0 ≤ x ≤ 1 (i.
e. r ≤ rc) and whose Fourier transform has the smallest
norm in y > 1 (k > kc).

Acknowledgments

We want to thank Alberto Garc´ia for useful discus-
sions and M. Fern´andez-Serra for the basis set of the
water molecule15. This work has been founded by grant
BFM2003-03372 from the Spanish Ministery of Science.

APPENDIX A: VARIATIONAL PRINCIPLES

Here we show that the ﬁltering basis functions φi(r)
obey a simple variational principle, and we also present
an alternative principle for gaussian basis functions. It
may be easily shown, by a straightforward functional
derivative, that the eigenvalue equation (7) is equivalent
to the variational principle

1

1

Z

0 Z

0

′
dx dx

′
φ(x)K 2(x, x

′
)φ(x

) = max

(A1)

subject to the condition of normalization of φ(x) within
0 ≤ x ≤ 1. Now, using that the Fourier transform of
φ(x) is

g(y) =

dx φ(x) K(x, y)

(A2)

1

Z
0

as well as the deﬁnition (6) and the fact that the total
norm of a function is the same in real and Fourier space:

dy

dxφ(x)K(x, y)

′
dx

′
K(y, x

′
)φ(x

)

dy g2(y) = 1 −

dy g2(y) = max

dy g2(y) = min

(A3)

1

Z

0
∞

Z
1

1

1

Z
0

=

⇒

Z
0
1

Z
0

∞

Z
1

Interestingly, an alternative variational principle may
be demonstrated for a basis of gaussian functions. Thus,
we maximize the conﬁnement of a normalized distribu-
tion φ(r) and its Fourier transform φ(k), in the sense of
least squared dispersion:

1
r2
c Z

1
k2
c Z

dr r2φ2(r) +

dk k2φ2(k) = min

(A4)

where rc and kc are here scale factors that determine
the relative conﬁnement in real and Fourier space, rather
than strict cutoﬀs. Multiplying by k2

c /2:

r2
dr k2
c
2r2
c

Z

k2

2

Z

φ2(r) +

dk

φ2(k) = min

(A5)

Now, the ﬁrst term is the potential energy of a quan-
tum harmonic oscillator with spring constant (kc/rc)2
and wave function φ(r), and the second term is its ki-
netic energy. Its well known solutions are gaussians times
Hermite polynomials16. A similar (but not orthonormal)
basis, made of gaussians times powers of r, was used by
Hartwigsen et al 17 to generate compact separable pseu-
dopotentials.

1 W. H. Press, S. A. Teukolsky, W. T. Vetterling, and B. P.
Flannery, Numerical Recipes (Cambridge University Press,
Cambridge, 1992).

2 R. W. Hockney and J. W. Eastwood, Computer Simulation

Using Particles (IOP Publishing, Bristol, 1988).

3 R. D. King-Smith, M. C. Payne, and J. S. Lin, Phys. Rev.

7 P. Ordej´on, E. Artacho, and J. M. Soler, Phys. Rev. B 53,

R10441 (1996).

8 T. L. Beck, Rev. Mod. Phys. 72, 1041 (2000).
9 E. L. Briggs, D. J. Sullivan, and J. Bernholc, Phys. Rev.

B 54, 14362 (1996).

10 O. F. Sankey and D. J. Niklewski, Phys. Rev. B 40, 3979

B 44, 13063 (1991).

1425 (1982).

4 L. Kleinman and D. M. Bylander, Phys. Rev. Lett. 48,

11 N. Troullier and J. L. Martins, Phys. Rev. B 43, 1993

5 D. Vanderbilt, Phys. Rev. B 41, 7892 (1990).
6 J. M. Soler, E. Artacho, J. D. Gale, A. Garc´ıa, J. Junquera,
P. Ordej´on, and D. S´anchez-Portal, J. Phys.: Condens.
Matter 14, 2745 (2002).

12 P. E. Bl¨ochl, Phys. Rev. B 50, 17953 (1994).
13 C. K. Gan, P. D.Haynes, and M. C. Payne, Phys. Rev. B

63, 205109 (2001).

14 To obtain the full hessian matrix by ﬁnite diﬀerences,

(1989).

(1991).

M. Paulsson has noticed that the eggbox eﬀect can be
dramatically reduced by using not the force on the dis-
placed atom but minus the total force on the rest of
the atoms (for details,
list in
http://www.uam.es/siesta). This trick cannot be used,
however, when many atoms move simultaneously, as to
calculate given frozen-phonon frequencies or in molecular
dynamics. Therefore, we have used the forces of the dis-
placed atoms to obtain the hessian, precisely to evaluate

see the SIESTA mail

6

the eﬀect of ﬁltering on the eggbox.

15 M. Fernandez-Serra and E. Artacho, J. Chem. Phys 121,

11136 (2004).

16 C. Cohen-Tannoudji, B. Diu, and F. Lalo¨e, M´ecanique

Quantique (Hermann, Paris, 1977).

17 C. Hartwigsen, S. Goedecker, and J. Hutter, Phys. Rev. B

55, 3641 (1998).

